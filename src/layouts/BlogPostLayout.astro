---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents.astro';
import CodeEnhancer from '../components/CodeEnhancer.astro';
import type { CollectionEntry } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '../utils/readingTime';

interface Props {
  post: CollectionEntry<'blog'>;
  headings: { depth: number; slug: string; text: string }[];
}

const { post, headings } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  author,
  tags,
  banner,
  seoTitle,
  tldr,
  keyTakeaways,
  category,
  difficulty,
  seoKeywords
} = post.data;

const formattedDate = pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdatedDate = updatedDate?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const pageTitle = seoTitle || title;

// Calculate reading time from post body
const readingTime = calculateReadingTime(post.body || '');
const readingTimeText = formatReadingTime(readingTime);

// Generate JSON-LD structured data for AI crawlers and SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "TechArticle",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Person",
    "name": author,
    "url": "https://blog.amenoacids.com/about"
  },
  "datePublished": pubDate.toISOString(),
  "dateModified": (updatedDate || pubDate).toISOString(),
  "publisher": {
    "@type": "Organization",
    "name": "ACIDBATH"
  },
  "proficiencyLevel": difficulty || "Intermediate",
  "keywords": [...tags, ...(seoKeywords || [])].join(", "),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://blog.amenoacids.com/blog/${post.slug}`
  }
};
---

<BaseLayout title={pageTitle} description={description}>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} slot="head" />

  <!-- AI-specific meta tags -->
  {tldr && <meta name="ai-summary" content={tldr} slot="head" />}
  {difficulty && <meta name="ai-difficulty" content={difficulty} slot="head" />}
  {category && <meta name="ai-category" content={category} slot="head" />}

  <article>
    <header>
      <!-- Post metadata badges -->
      <div class="post-badges">
        {category && <span class="badge badge-category">{category}</span>}
        {difficulty && <span class="badge badge-difficulty">{difficulty}</span>}
        <span class="badge badge-time">{readingTimeText}</span>
      </div>

      <h1>{title}</h1>

      <div class="meta">
        <time datetime={pubDate.toISOString()}>{formattedDate}</time>
        {updatedDate && (
          <span> · Updated: <time datetime={updatedDate.toISOString()}>{formattedUpdatedDate}</time></span>
        )}
        <span> · {author}</span>
      </div>

      {tags.length > 0 && (
        <div class="tags">
          {tags.map((tag) => (
            <span class="tag">[{tag}]</span>
          ))}
        </div>
      )}
    </header>

    <hr />

    {banner && (
      <div class="post-banner">
        <img src={banner} alt={title} class="post-banner-img" />
      </div>
    )}

    <!-- TL;DR section for AI and quick readers -->
    {tldr && (
      <div class="tldr-section">
        <h2>TL;DR</h2>
        <p>{tldr}</p>
      </div>
    )}

    <!-- Table of Contents -->
    <TableOfContents headings={headings} />

    <div class="prose">
      <slot />
    </div>

    <!-- Key Takeaways section -->
    {keyTakeaways && keyTakeaways.length > 0 && (
      <div class="takeaways-section">
        <h2>Key Takeaways</h2>
        <ol class="takeaways-list">
          {keyTakeaways.map((takeaway) => (
            <li>{takeaway}</li>
          ))}
        </ol>
      </div>
    )}
  </article>

  <!-- Code block enhancements (copy button) -->
  <CodeEnhancer />

  <!-- Mermaid diagram rendering -->
  <div id="mermaid-modal" class="mermaid-modal">
    <div class="mermaid-modal-content">
      <span class="mermaid-modal-close">&times;</span>
      <div class="mermaid-modal-body"></div>
    </div>
  </div>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#4a9eff',
        primaryTextColor: '#e1e4e8',
        primaryBorderColor: '#30363d',
        lineColor: '#8b949e',
        secondaryColor: '#238636',
        tertiaryColor: 'transparent',
        background: 'transparent',
        mainBkg: 'transparent',
        nodeBorder: '#30363d',
        clusterBkg: 'transparent',
        clusterBorder: '#30363d',
        titleColor: '#e1e4e8',
        edgeLabelBackground: 'transparent',
      }
    });

    // Click to zoom functionality
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const diagrams = document.querySelectorAll('.mermaid');
        const modal = document.getElementById('mermaid-modal');
        const modalBody = modal.querySelector('.mermaid-modal-body');
        const closeBtn = modal.querySelector('.mermaid-modal-close');

        diagrams.forEach(diagram => {
          diagram.style.cursor = 'zoom-in';
          diagram.title = 'Click to enlarge';

          diagram.addEventListener('click', () => {
            const svg = diagram.querySelector('svg');
            if (svg) {
              modalBody.innerHTML = svg.outerHTML;
              modal.classList.add('active');
              document.body.style.overflow = 'hidden';
            }
          });
        });

        closeBtn.addEventListener('click', () => {
          modal.classList.remove('active');
          document.body.style.overflow = '';
        });

        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('active')) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
          }
        });
      }, 500);
    });
  </script>

  <style is:global>
    .mermaid {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
      transition: opacity 0.2s;
    }
    .mermaid:hover {
      opacity: 0.8;
    }
    .mermaid svg {
      max-width: 100%;
      height: auto;
    }

    /* Modal styles */
    .mermaid-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .mermaid-modal.active {
      display: flex;
    }
    .mermaid-modal-content {
      position: relative;
      max-width: 95vw;
      max-height: 95vh;
      overflow: auto;
      padding: 2rem;
    }
    .mermaid-modal-close {
      position: fixed;
      top: 1rem;
      right: 1.5rem;
      font-size: 2.5rem;
      color: #e1e4e8;
      cursor: pointer;
      z-index: 1001;
      line-height: 1;
    }
    .mermaid-modal-close:hover {
      color: #fff;
    }
    .mermaid-modal-body {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mermaid-modal-body svg {
      max-width: 90vw;
      max-height: 85vh;
      width: auto;
      height: auto;
    }
  </style>
</BaseLayout>

<style>
  /* Post badges (category, difficulty, reading time) */
  .post-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: var(--spacing-line);
  }

  .badge {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--color-foreground-alt);
    color: var(--color-foreground-alt);
  }

  .badge-category {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .badge-difficulty {
    border-color: var(--color-foreground);
    color: var(--color-foreground);
  }

  .badge-time {
    border-color: var(--color-foreground-alt);
  }

  /* TL;DR section */
  .tldr-section {
    margin: var(--spacing-line) 0;
    padding: var(--spacing-line) 1ch;
    border-left: 4px solid var(--color-accent);
    background: var(--color-background-alt);
  }

  .tldr-section h2 {
    margin-top: 0;
    font-size: 0.85rem;
    color: var(--color-accent);
  }

  .tldr-section p {
    margin: 0;
    font-size: 1rem;
    line-height: 1.6;
  }

  /* Key Takeaways section */
  .takeaways-section {
    margin: calc(var(--spacing-line) * 2) 0 var(--spacing-line);
    padding: var(--spacing-line) 1ch;
    border: var(--border-width-thick) solid var(--color-accent);
    background: var(--color-background-alt);
  }

  .takeaways-section h2 {
    margin-top: 0;
    color: var(--color-accent);
  }

  .takeaways-list {
    margin: 0;
    padding-left: 3ch;
  }

  .takeaways-list li {
    margin-bottom: 0.5rem;
  }

  .takeaways-list li:last-child {
    margin-bottom: 0;
  }

  /* Post banner */
  .post-banner {
    width: 100%;
    max-height: 250px;
    overflow: hidden;
    margin-bottom: var(--spacing-line);
  }

  .post-banner-img {
    width: 100%;
    height: 250px;
    object-fit: cover;
    object-position: center;
  }

  .meta {
    color: var(--color-text-muted, #888);
    font-size: 0.9rem;
  }

  .tags {
    margin-top: calc(var(--spacing-line) * 0.5);
  }

  .tag {
    color: var(--color-text-muted, #888);
    font-size: 0.85rem;
    margin-right: 0.5ch;
  }
</style>
