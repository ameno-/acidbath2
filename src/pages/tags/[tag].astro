---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { BlogPostCard } from '@/components/ui/BlogPostCard';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  // Get all unique tags
  const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags))];

  return uniqueTags.map((tag) => ({
    params: { tag },
    props: {
      posts: allPosts
        .filter((post) => post.data.tags.includes(tag))
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout title={`Posts tagged "${tag}"`} description={`All articles tagged with ${tag}`}>
  <header class="tag-header">
    <a href="/blog" class="back-link">&larr; All posts</a>
    <h1>[{tag}]</h1>
    <p class="subtitle">{posts.length} article{posts.length !== 1 ? 's' : ''} tagged with "{tag}"</p>
  </header>

  <hr />

  {posts.length > 0 ? (
    <div class="posts-list">
      {posts.map((post) => (
        <BlogPostCard
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          slug={post.slug}
          tags={post.data.tags}
        />
      ))}
    </div>
  ) : (
    <p class="text-alt">No posts with this tag.</p>
  )}
</BaseLayout>

<style>
  .tag-header {
    margin-bottom: var(--spacing-line);
  }

  .back-link {
    font-size: 0.85rem;
    color: var(--color-foreground-alt);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-foreground);
    text-decoration: underline;
  }

  h1 {
    margin-top: calc(var(--spacing-line) / 2);
    color: var(--color-accent-primary);
  }

  .subtitle {
    color: var(--color-foreground-muted);
    margin-top: calc(var(--spacing-line) * -0.5);
  }

  .posts-list {
    margin-top: var(--spacing-line);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }
</style>
