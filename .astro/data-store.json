[["Map",1,2,9,10],"meta::meta",["Map",3,4,5,6,7,8],"astro-version","5.16.5","content-config-digest","f63c3f4aa2239104","astro-config-digest","{\"root\":{},\"srcDir\":{},\"publicDir\":{},\"outDir\":{},\"cacheDir\":{},\"site\":\"https://blog.amenoacids.com\",\"compressHTML\":true,\"base\":\"/\",\"trailingSlash\":\"ignore\",\"output\":\"static\",\"scopedStyleStrategy\":\"attribute\",\"build\":{\"format\":\"directory\",\"client\":{},\"server\":{},\"assets\":\"_astro\",\"serverEntry\":\"entry.mjs\",\"redirects\":true,\"inlineStylesheets\":\"auto\",\"concurrency\":1},\"server\":{\"open\":false,\"host\":false,\"port\":4321,\"streaming\":true,\"allowedHosts\":[]},\"redirects\":{},\"image\":{\"endpoint\":{\"route\":\"/_image\"},\"service\":{\"entrypoint\":\"astro/assets/services/sharp\",\"config\":{}},\"domains\":[],\"remotePatterns\":[],\"responsiveStyles\":false},\"devToolbar\":{\"enabled\":true},\"markdown\":{\"syntaxHighlight\":{\"type\":\"shiki\",\"excludeLangs\":[\"mermaid\"]},\"shikiConfig\":{\"langs\":[],\"langAlias\":{},\"theme\":\"github-dark\",\"themes\":{},\"wrap\":false,\"transformers\":[]},\"remarkPlugins\":[],\"rehypePlugins\":[[null,{\"strategy\":\"pre-mermaid\"}]],\"remarkRehype\":{},\"gfm\":true,\"smartypants\":true},\"security\":{\"checkOrigin\":true,\"allowedDomains\":[]},\"env\":{\"schema\":{},\"validateSecrets\":false},\"experimental\":{\"clientPrerender\":false,\"contentIntellisense\":false,\"headingIdCompat\":false,\"preserveScriptOrder\":false,\"liveContentCollections\":false,\"csp\":false,\"staticImportMetaEnv\":false,\"chromeDevtoolsWorkspace\":false,\"failOnPrerenderConflict\":false,\"svgo\":false},\"legacy\":{\"collections\":false}}","blog",["Map",11,12,76,77,189,190,282,283,378,379],"workflow-prompts",{"id":11,"data":13,"body":36,"filePath":37,"digest":38,"rendered":39,"legacyId":75},{"title":14,"description":15,"pubDate":16,"author":17,"tags":18,"draft":24,"banner":25,"seoKeywords":26,"tldr":27,"keyTakeaways":28,"category":34,"difficulty":35},"Workflow Prompts: The Pattern That Makes AI Engineering Predictable","The workflow section drives 90% of the value in agentic prompts. Learn to build workflow prompts that work, when they fail, and how to measure ROI.",["Date","2025-12-15T00:00:00.000Z"],"Acidbath",[19,20,21,22,23],"ai","prompts","claude-code","workflow","automation",false,"/assets/posts/workflow-prompts-banner.png",[],"Workflow prompts follow an Input → Workflow → Output structure that makes AI agent behavior predictable. The workflow section—numbered, sequential steps—drives 90% of the value. Use break-even math (time to write / time saved per use) to decide if a workflow is worth building.",[29,30,31,32,33],"Workflow sections are S-tier value with C-tier difficulty—the most valuable component is also the easiest to execute","Workflow prompts fail on complex judgment calls, ambiguous requirements, and real-time adaptation tasks","Break-even calculation: (Time to write) / (Time saved per use) = minimum uses needed","A 30-minute workflow prompt pays off after 3 uses of a 15-minute task","Build a library of reusable workflow prompts for maximum team ROI","Agentic Patterns","Intermediate","The workflow section is the most important thing you'll write in any agentic prompt.\n\nNot the metadata. Not the variables. Not the fancy control flow. The workflow—your step-by-step play for what the agent should do—drives 90% of the value you'll capture from AI-assisted engineering.\n\nThis post shows you how to build workflow prompts that actually work, with templates you can use today. It also covers the failure modes you'll encounter and how to calculate whether a workflow prompt is worth writing.\n\n## The Core Pattern: Input → Workflow → Output\n\nEvery effective agentic prompt follows this three-step structure:\n\n```mermaid\nflowchart LR\n    subgraph INPUT[\"INPUT\"]\n        I1[Variables]\n        I2[Parameters]\n        I3[Context]\n    end\n\n    subgraph WORKFLOW[\"WORKFLOW\"]\n        W1[Sequential]\n        W2[Step-by-Step]\n        W3[Instructions]\n    end\n\n    subgraph OUTPUT[\"OUTPUT\"]\n        O1[Report]\n        O2[Format]\n        O3[Structure]\n    end\n\n    INPUT --> WORKFLOW --> OUTPUT\n\n    style INPUT fill:#e3f2fd\n    style WORKFLOW fill:#fff3e0\n    style OUTPUT fill:#c8e6c9\n```\n\nThe workflow section is where your agent's actual work happens. It's rated S-tier usefulness with C-tier difficulty—the most valuable component is also the easiest to execute well.\n\n## POC: A Working Workflow Prompt\n\nHere's a complete, production-ready workflow prompt you can use as a Claude Code command:\n\n```markdown\n---\ndescription: Analyze a file and create implementation plan\nallowed-tools: Read, Glob, Grep, Write\nargument-hint: \u003Cfile_path>\n---\n\n# File Analysis and Planning Agent\n\n## Purpose\nAnalyze the provided file and create a detailed implementation plan for improvements.\n\n## Variables\n- **target_file**: $ARGUMENTS (the file to analyze)\n- **output_dir**: ./specs\n\n## Workflow\n\n1. **Read the target file**\n   - Load the complete contents of {{target_file}}\n   - Note the file type, structure, and purpose\n\n2. **Analyze the codebase context**\n   - Use Glob to find related files (same directory, similar names)\n   - Use Grep to find references to functions/classes in this file\n   - Identify dependencies and dependents\n\n3. **Identify improvement opportunities**\n   - List potential refactoring targets\n   - Note any code smells or anti-patterns\n   - Consider performance optimizations\n   - Check for missing error handling\n\n4. **Create implementation plan**\n   - For each improvement, specify:\n     - What to change\n     - Why it matters\n     - Files affected\n     - Risk level (low/medium/high)\n\n5. **Write the plan to file**\n   - Save to {{output_dir}}/{{filename}}-plan.md\n   - Include timestamp and file hash for tracking\n\n## Output Format\nfile_analyzed: {{target_file}}\ntimestamp: {{current_time}}\nimprovements:\n  - id: 1\n    type: refactor|performance|error-handling|cleanup\n    description: \"What to change\"\n    rationale: \"Why it matters\"\n    files_affected: [list]\n    risk: low|medium|high\n    effort: small|medium|large\n\n## Early Returns\n- If {{target_file}} doesn't exist, stop and report error\n- If file is binary or unreadable, stop and explain\n- If no improvements found, report \"file looks good\" with reasoning\n```\n\nSave this as `.claude/commands/analyze.md` and run with `/analyze src/main.py`.\n\n## The Workflow Section Deep Dive\n\nWhat makes workflow sections powerful:\n\n**Sequential clarity** - Numbered steps eliminate ambiguity. The agent knows exactly what order to execute.\n\n```markdown\n## Workflow\n\n1. Read the config file\n2. Parse the JSON structure\n3. Validate required fields exist\n4. Transform data to new format\n5. Write output file\n```\n\n**Nested detail** - Add specifics under each step without breaking the sequence:\n\n```markdown\n## Workflow\n\n1. **Gather requirements**\n   - Read the user's request carefully\n   - Identify explicit requirements\n   - Note implicit assumptions\n   - List questions if anything is unclear\n\n2. **Research existing code**\n   - Search for similar implementations\n   - Check for utility functions that could help\n   - Review relevant documentation\n```\n\n**Conditional branches** - Handle different scenarios:\n\n```markdown\n## Workflow\n\n1. Check if package.json exists\n2. **If exists:**\n   - Parse dependencies\n   - Check for outdated packages\n   - Generate update recommendations\n3. **If not exists:**\n   - Stop and inform user this isn't a Node project\n```\n\n## When Workflow Prompts Fail\n\nWorkflow prompts are powerful, but they're not universal. Here are the failure modes I've hit in production:\n\n**Overly complex tasks requiring human judgment mid-execution**\n\nI tried building a workflow prompt for database migration planning. The prompt could analyze schema differences and generate SQL, but it couldn't decide which migrations were safe to auto-apply versus which needed DBA review. The decision tree had too many branches: data volume considerations, cross-region timing, rollback complexity, customer impact windows.\n\nThe workflow kept requesting human input at steps 3, 5, 7, and 9 of a 12-step process. At that point, you're better off doing it interactively. Workflow prompts excel when the decision points are clear and the execution path is deterministic.\n\n**Rule of thumb**: If your workflow has more than 2 \"stop and ask the user\" points, it's probably not a good fit.\n\n**Ambiguous requirements that can't be specified upfront**\n\n\"Generate a blog post outline for our next marketing campaign\" sounds like a good workflow candidate. It's not. The requirements shift based on the output. You see the first draft and realize you want a different tone. The second section needs more technical depth. The third needs less.\n\nI wrote a 300-line workflow prompt for content generation that included 15 different quality checks and formatting rules. The agent followed it perfectly and produced consistently mediocre output. The problem wasn't execution—it was that I couldn't articulate \"make it interesting\" in workflow steps.\n\nInteractive prompting lets you course-correct in real-time. Workflow prompts lock in your assumptions upfront.\n\n**Tasks requiring real-time adaptation**\n\nDebugging sessions are the classic example. You can't write a workflow for \"figure out why the auth service is returning 500 errors\" because each finding changes what you need to check next. Step 1 might be \"check logs,\" but what you find in the logs determines whether step 2 is \"inspect database connections\" or \"review API gateway config\" or \"check Redis cache status.\"\n\nWorkflow prompts assume a static execution path. Debugging requires dynamic branching based on runtime discoveries.\n\n**When the overhead of writing the prompt exceeds the task time**\n\nThis is the trap I see most often. Someone spends 2 hours writing a workflow prompt for a task that takes 30 minutes to do manually. They run it once, it works great, and then they never use it again.\n\nIf you're not going to run a workflow at least 5 times, don't build it. Do it manually or use interactive prompting.\n\n**Edge case: Workflows that seem simple but have hidden complexity**\n\n\"Rename this function across the codebase\" sounds trivial. Write a workflow prompt: search for all instances, replace them, update imports, done. Except the function is called `get()` and your codebase has 47 different `get()` functions. Or it's used in generated code. Or it's referenced in documentation strings that need different formatting. Or it's in test mocks that need manual review.\n\nI've seen 10-step workflow prompts fail at step 8 because an edge case no one anticipated appeared. The agent either halted with an error or plowed ahead and broke things. Neither outcome is great when you're at 80% completion.\n\nFor tasks with hidden complexity, start with interactive prompting. Once you've hit the edge cases manually, then codify the workflow.\n\n## Measuring Workflow ROI\n\nThe question you should ask before writing any workflow prompt: \"Will this pay for itself?\"\n\n**Time to write workflow prompt vs time saved**\n\nA workflow prompt takes between 20 minutes (simple, templated) and 3 hours (complex, multi-step). Most fall in the 45-60 minute range if you're building from scratch.\n\nTask execution time varies, but here's the break-even math:\n\n```\nBreak-even uses = (Time to write prompt) / (Time saved per use)\n```\n\nExample 1: Code review workflow\n- Time to write: 60 minutes\n- Manual review time: 20 minutes\n- Time with workflow: 5 minutes (you review the agent's output)\n- Time saved per use: 15 minutes\n- Break-even: 60 / 15 = 4 uses\n\nIf you review code 4+ times, the workflow prompt pays off.\n\nExample 2: API endpoint scaffolding\n- Time to write: 90 minutes (includes error handling, validation, tests)\n- Manual scaffold time: 40 minutes\n- Time with workflow: 8 minutes (review and tweak)\n- Time saved per use: 32 minutes\n- Break-even: 90 / 32 = 2.8 uses (round to 3)\n\nIf you build 3+ similar endpoints, the workflow prompt pays off.\n\n**The multiplier effect**\n\nThis calculation assumes only you use the workflow. If your team uses it, divide break-even by team size.\n\nA 30-minute workflow prompt on a 5-person team needs to save each person just 6 minutes once to break even. That's a no-brainer for common tasks like \"add API endpoint,\" \"generate test file,\" or \"create component boilerplate.\"\n\n**The hidden cost: maintenance**\n\nWorkflow prompts break when your codebase evolves. Your folder structure changes. Your testing framework updates. Your naming conventions shift.\n\nI maintain about 40 workflow prompts for client projects. Roughly 10% break each quarter and need updates. Budget 15-30 minutes per quarter per active workflow for maintenance.\n\nIf a workflow saves you 2 hours per month but costs 30 minutes per quarter to maintain, the net ROI is still massive: 24 hours saved vs 2 hours maintenance over a year.\n\n**When to skip the ROI calculation**\n\nSome workflows are worth it regardless of break-even math:\n- Team onboarding tasks (new hires benefit disproportionately)\n- Critical path operations where consistency matters more than speed\n- Compliance tasks that require documented, repeatable processes\n\nIf the task is high-stakes or high-variance, the value of predictability can exceed the value of time saved.\n\n## Agent Opportunity: Build a Prompt Library\n\nHere's where you can multiply your impact:\n\n```mermaid\nflowchart TD\n    subgraph LIB[\".claude/commands/\"]\n        A[\"analyze.md - File analysis\"]\n        B[\"refactor.md - Guided refactoring\"]\n        C[\"test.md - Generate tests\"]\n        D[\"document.md - Add documentation\"]\n        E[\"review.md - Code review checklist\"]\n        F[\"debug.md - Systematic debugging\"]\n    end\n\n    LIB --> G[\"Each prompt follows: Input → Workflow → Output\"]\n    G --> H[\"Reusable across projects\"]\n    H --> I[\"Serves you, your team, AND your agents\"]\n\n    style LIB fill:#e8f5e9\n```\n\n## Why Workflows Beat Ad-Hoc Prompting\n\n```mermaid\nflowchart LR\n    subgraph ADHOC[\"AD-HOC PROMPTING\"]\n        A1[\"'Help me refactor this'\"]\n        A2[Unpredictable scope]\n        A3[Inconsistent output]\n        A4[No error handling]\n        A5[Can't reuse]\n        A6[Team can't use it]\n    end\n\n    subgraph WORKFLOW[\"WORKFLOW PROMPTING\"]\n        W1[\"Step 1: Backup\"]\n        W2[\"Step 2: Analyze\"]\n        W3[\"Step 3: Plan\"]\n        W4[\"Step 4: Execute\"]\n        W5[\"Step 5: Verify\"]\n        W6[\"Step 6: Document\"]\n    end\n\n    WORKFLOW --> R1[Predictable execution]\n    WORKFLOW --> R2[Consistent format]\n    WORKFLOW --> R3[Early returns on error]\n    WORKFLOW --> R4[Reusable forever]\n    WORKFLOW --> R5[Team multiplier]\n\n    style ADHOC fill:#ffcdd2\n    style WORKFLOW fill:#c8e6c9\n```\n\nThe workflow prompt transforms a vague request into an executable engineering plan. One workflow prompt executing for an hour can generate work that would take you 20 hours.\n\n## Building Your First Workflow Prompt\n\nStart with your most common task. The one you do every day. The one where you think \"I should automate this.\"\n\n1. Write out the steps you take manually\n2. Convert each step to a numbered instruction\n3. Add variables for the parts that change\n4. Add early returns for failure cases\n5. Specify the output format you want\n\nTest it. Iterate. Add to your library.\n\nThe prompt is the new fundamental unit of engineering. The workflow section is where that engineering actually happens.\n\n---\n\n**Key Takeaways:**\n- Workflow sections are S-tier value, C-tier difficulty\n- Input → Workflow → Output is the universal pattern\n- Numbered steps create predictable execution\n- Early returns handle failure cases cleanly\n- Workflows fail on complex judgment calls, ambiguous requirements, and real-time adaptation tasks\n- Break-even calculation: (Time to write) / (Time saved per use) = minimum uses needed\n- A 30-minute workflow prompt pays off after 3 uses of a 15-minute task\n- Build a library of reusable workflow prompts for maximum team ROI\n- One good workflow prompt = 20+ hours of work\n\n**Try It Now:**\nCopy the analyze.md template above, save to `.claude/commands/analyze.md`, and run `/analyze` on any file in your codebase. Time how long it takes to write the prompt and how long the analysis takes to run. Calculate your break-even point for the next time you need to analyze a file.","src/content/blog/workflow-prompts.md","599a4ba0b5b2dd49",{"html":40,"metadata":41},"\u003Cp>The workflow section is the most important thing you’ll write in any agentic prompt.\u003C/p>\n\u003Cp>Not the metadata. Not the variables. Not the fancy control flow. The workflow—your step-by-step play for what the agent should do—drives 90% of the value you’ll capture from AI-assisted engineering.\u003C/p>\n\u003Cp>This post shows you how to build workflow prompts that actually work, with templates you can use today. It also covers the failure modes you’ll encounter and how to calculate whether a workflow prompt is worth writing.\u003C/p>\n\u003Ch2 id=\"the-core-pattern-input--workflow--output\">The Core Pattern: Input → Workflow → Output\u003C/h2>\n\u003Cp>Every effective agentic prompt follows this three-step structure:\u003C/p>\n\u003Cpre class=\"mermaid\">flowchart LR\n    subgraph INPUT[\"INPUT\"]\n        I1[Variables]\n        I2[Parameters]\n        I3[Context]\n    end\n\n    subgraph WORKFLOW[\"WORKFLOW\"]\n        W1[Sequential]\n        W2[Step-by-Step]\n        W3[Instructions]\n    end\n\n    subgraph OUTPUT[\"OUTPUT\"]\n        O1[Report]\n        O2[Format]\n        O3[Structure]\n    end\n\n    INPUT --> WORKFLOW --> OUTPUT\n\n    style INPUT fill:#e3f2fd\n    style WORKFLOW fill:#fff3e0\n    style OUTPUT fill:#c8e6c9\n\u003C/pre>\n\u003Cp>The workflow section is where your agent’s actual work happens. It’s rated S-tier usefulness with C-tier difficulty—the most valuable component is also the easiest to execute well.\u003C/p>\n\u003Ch2 id=\"poc-a-working-workflow-prompt\">POC: A Working Workflow Prompt\u003C/h2>\n\u003Cp>Here’s a complete, production-ready workflow prompt you can use as a Claude Code command:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">description: Analyze a file and create implementation plan\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">allowed-tools: Read, Glob, Grep, Write\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">argument-hint: &#x3C;file_path>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># File Analysis and Planning Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Purpose\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Analyze the provided file and create a detailed implementation plan for improvements.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Variables\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **target_file**\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: $ARGUMENTS (the file to analyze)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **output_dir**\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: ./specs\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Workflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Read the target file**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Load the complete contents of {{target_file}}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note the file type, structure, and purpose\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Analyze the codebase context**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Use Glob to find related files (same directory, similar names)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Use Grep to find references to functions/classes in this file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Identify dependencies and dependents\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Identify improvement opportunities**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> List potential refactoring targets\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note any code smells or anti-patterns\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Consider performance optimizations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Check for missing error handling\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Create implementation plan**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> For each improvement, specify:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">     -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> What to change\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">     -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Why it matters\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">     -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Files affected\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">     -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Risk level (low/medium/high)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">5.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Write the plan to file**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Save to {{output_dir}}/{{filename}}-plan.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Include timestamp and file hash for tracking\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Output Format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">file_analyzed: {{target_file}}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">timestamp: {{current_time}}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">improvements:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">  -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> id: 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    type: refactor|performance|error-handling|cleanup\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    description: \"What to change\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    rationale: \"Why it matters\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    files_affected: [\u003C/span>\u003Cspan style=\"color:#DBEDFF;text-decoration:underline\">list\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    risk: low|medium|high\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    effort: small|medium|large\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Early Returns\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> If {{target_file}} doesn't exist, stop and report error\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> If file is binary or unreadable, stop and explain\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> If no improvements found, report \"file looks good\" with reasoning\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Save this as \u003Ccode>.claude/commands/analyze.md\u003C/code> and run with \u003Ccode>/analyze src/main.py\u003C/code>.\u003C/p>\n\u003Ch2 id=\"the-workflow-section-deep-dive\">The Workflow Section Deep Dive\u003C/h2>\n\u003Cp>What makes workflow sections powerful:\u003C/p>\n\u003Cp>\u003Cstrong>Sequential clarity\u003C/strong> - Numbered steps eliminate ambiguity. The agent knows exactly what order to execute.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Workflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Read the config file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Parse the JSON structure\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Validate required fields exist\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Transform data to new format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">5.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Write output file\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Nested detail\u003C/strong> - Add specifics under each step without breaking the sequence:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Workflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Gather requirements**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Read the user's request carefully\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Identify explicit requirements\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note implicit assumptions\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> List questions if anything is unclear\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Research existing code**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Search for similar implementations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Check for utility functions that could help\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Review relevant documentation\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Conditional branches\u003C/strong> - Handle different scenarios:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Workflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Check if package.json exists\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **If exists:**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Parse dependencies\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Check for outdated packages\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Generate update recommendations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **If not exists:**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Stop and inform user this isn't a Node project\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"when-workflow-prompts-fail\">When Workflow Prompts Fail\u003C/h2>\n\u003Cp>Workflow prompts are powerful, but they’re not universal. Here are the failure modes I’ve hit in production:\u003C/p>\n\u003Cp>\u003Cstrong>Overly complex tasks requiring human judgment mid-execution\u003C/strong>\u003C/p>\n\u003Cp>I tried building a workflow prompt for database migration planning. The prompt could analyze schema differences and generate SQL, but it couldn’t decide which migrations were safe to auto-apply versus which needed DBA review. The decision tree had too many branches: data volume considerations, cross-region timing, rollback complexity, customer impact windows.\u003C/p>\n\u003Cp>The workflow kept requesting human input at steps 3, 5, 7, and 9 of a 12-step process. At that point, you’re better off doing it interactively. Workflow prompts excel when the decision points are clear and the execution path is deterministic.\u003C/p>\n\u003Cp>\u003Cstrong>Rule of thumb\u003C/strong>: If your workflow has more than 2 “stop and ask the user” points, it’s probably not a good fit.\u003C/p>\n\u003Cp>\u003Cstrong>Ambiguous requirements that can’t be specified upfront\u003C/strong>\u003C/p>\n\u003Cp>“Generate a blog post outline for our next marketing campaign” sounds like a good workflow candidate. It’s not. The requirements shift based on the output. You see the first draft and realize you want a different tone. The second section needs more technical depth. The third needs less.\u003C/p>\n\u003Cp>I wrote a 300-line workflow prompt for content generation that included 15 different quality checks and formatting rules. The agent followed it perfectly and produced consistently mediocre output. The problem wasn’t execution—it was that I couldn’t articulate “make it interesting” in workflow steps.\u003C/p>\n\u003Cp>Interactive prompting lets you course-correct in real-time. Workflow prompts lock in your assumptions upfront.\u003C/p>\n\u003Cp>\u003Cstrong>Tasks requiring real-time adaptation\u003C/strong>\u003C/p>\n\u003Cp>Debugging sessions are the classic example. You can’t write a workflow for “figure out why the auth service is returning 500 errors” because each finding changes what you need to check next. Step 1 might be “check logs,” but what you find in the logs determines whether step 2 is “inspect database connections” or “review API gateway config” or “check Redis cache status.”\u003C/p>\n\u003Cp>Workflow prompts assume a static execution path. Debugging requires dynamic branching based on runtime discoveries.\u003C/p>\n\u003Cp>\u003Cstrong>When the overhead of writing the prompt exceeds the task time\u003C/strong>\u003C/p>\n\u003Cp>This is the trap I see most often. Someone spends 2 hours writing a workflow prompt for a task that takes 30 minutes to do manually. They run it once, it works great, and then they never use it again.\u003C/p>\n\u003Cp>If you’re not going to run a workflow at least 5 times, don’t build it. Do it manually or use interactive prompting.\u003C/p>\n\u003Cp>\u003Cstrong>Edge case: Workflows that seem simple but have hidden complexity\u003C/strong>\u003C/p>\n\u003Cp>“Rename this function across the codebase” sounds trivial. Write a workflow prompt: search for all instances, replace them, update imports, done. Except the function is called \u003Ccode>get()\u003C/code> and your codebase has 47 different \u003Ccode>get()\u003C/code> functions. Or it’s used in generated code. Or it’s referenced in documentation strings that need different formatting. Or it’s in test mocks that need manual review.\u003C/p>\n\u003Cp>I’ve seen 10-step workflow prompts fail at step 8 because an edge case no one anticipated appeared. The agent either halted with an error or plowed ahead and broke things. Neither outcome is great when you’re at 80% completion.\u003C/p>\n\u003Cp>For tasks with hidden complexity, start with interactive prompting. Once you’ve hit the edge cases manually, then codify the workflow.\u003C/p>\n\u003Ch2 id=\"measuring-workflow-roi\">Measuring Workflow ROI\u003C/h2>\n\u003Cp>The question you should ask before writing any workflow prompt: “Will this pay for itself?”\u003C/p>\n\u003Cp>\u003Cstrong>Time to write workflow prompt vs time saved\u003C/strong>\u003C/p>\n\u003Cp>A workflow prompt takes between 20 minutes (simple, templated) and 3 hours (complex, multi-step). Most fall in the 45-60 minute range if you’re building from scratch.\u003C/p>\n\u003Cp>Task execution time varies, but here’s the break-even math:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>Break-even uses = (Time to write prompt) / (Time saved per use)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Example 1: Code review workflow\u003C/p>\n\u003Cul>\n\u003Cli>Time to write: 60 minutes\u003C/li>\n\u003Cli>Manual review time: 20 minutes\u003C/li>\n\u003Cli>Time with workflow: 5 minutes (you review the agent’s output)\u003C/li>\n\u003Cli>Time saved per use: 15 minutes\u003C/li>\n\u003Cli>Break-even: 60 / 15 = 4 uses\u003C/li>\n\u003C/ul>\n\u003Cp>If you review code 4+ times, the workflow prompt pays off.\u003C/p>\n\u003Cp>Example 2: API endpoint scaffolding\u003C/p>\n\u003Cul>\n\u003Cli>Time to write: 90 minutes (includes error handling, validation, tests)\u003C/li>\n\u003Cli>Manual scaffold time: 40 minutes\u003C/li>\n\u003Cli>Time with workflow: 8 minutes (review and tweak)\u003C/li>\n\u003Cli>Time saved per use: 32 minutes\u003C/li>\n\u003Cli>Break-even: 90 / 32 = 2.8 uses (round to 3)\u003C/li>\n\u003C/ul>\n\u003Cp>If you build 3+ similar endpoints, the workflow prompt pays off.\u003C/p>\n\u003Cp>\u003Cstrong>The multiplier effect\u003C/strong>\u003C/p>\n\u003Cp>This calculation assumes only you use the workflow. If your team uses it, divide break-even by team size.\u003C/p>\n\u003Cp>A 30-minute workflow prompt on a 5-person team needs to save each person just 6 minutes once to break even. That’s a no-brainer for common tasks like “add API endpoint,” “generate test file,” or “create component boilerplate.”\u003C/p>\n\u003Cp>\u003Cstrong>The hidden cost: maintenance\u003C/strong>\u003C/p>\n\u003Cp>Workflow prompts break when your codebase evolves. Your folder structure changes. Your testing framework updates. Your naming conventions shift.\u003C/p>\n\u003Cp>I maintain about 40 workflow prompts for client projects. Roughly 10% break each quarter and need updates. Budget 15-30 minutes per quarter per active workflow for maintenance.\u003C/p>\n\u003Cp>If a workflow saves you 2 hours per month but costs 30 minutes per quarter to maintain, the net ROI is still massive: 24 hours saved vs 2 hours maintenance over a year.\u003C/p>\n\u003Cp>\u003Cstrong>When to skip the ROI calculation\u003C/strong>\u003C/p>\n\u003Cp>Some workflows are worth it regardless of break-even math:\u003C/p>\n\u003Cul>\n\u003Cli>Team onboarding tasks (new hires benefit disproportionately)\u003C/li>\n\u003Cli>Critical path operations where consistency matters more than speed\u003C/li>\n\u003Cli>Compliance tasks that require documented, repeatable processes\u003C/li>\n\u003C/ul>\n\u003Cp>If the task is high-stakes or high-variance, the value of predictability can exceed the value of time saved.\u003C/p>\n\u003Ch2 id=\"agent-opportunity-build-a-prompt-library\">Agent Opportunity: Build a Prompt Library\u003C/h2>\n\u003Cp>Here’s where you can multiply your impact:\u003C/p>\n\u003Cpre class=\"mermaid\">flowchart TD\n    subgraph LIB[\".claude/commands/\"]\n        A[\"analyze.md - File analysis\"]\n        B[\"refactor.md - Guided refactoring\"]\n        C[\"test.md - Generate tests\"]\n        D[\"document.md - Add documentation\"]\n        E[\"review.md - Code review checklist\"]\n        F[\"debug.md - Systematic debugging\"]\n    end\n\n    LIB --> G[\"Each prompt follows: Input → Workflow → Output\"]\n    G --> H[\"Reusable across projects\"]\n    H --> I[\"Serves you, your team, AND your agents\"]\n\n    style LIB fill:#e8f5e9\n\u003C/pre>\n\u003Ch2 id=\"why-workflows-beat-ad-hoc-prompting\">Why Workflows Beat Ad-Hoc Prompting\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart LR\n    subgraph ADHOC[\"AD-HOC PROMPTING\"]\n        A1[\"'Help me refactor this'\"]\n        A2[Unpredictable scope]\n        A3[Inconsistent output]\n        A4[No error handling]\n        A5[Can't reuse]\n        A6[Team can't use it]\n    end\n\n    subgraph WORKFLOW[\"WORKFLOW PROMPTING\"]\n        W1[\"Step 1: Backup\"]\n        W2[\"Step 2: Analyze\"]\n        W3[\"Step 3: Plan\"]\n        W4[\"Step 4: Execute\"]\n        W5[\"Step 5: Verify\"]\n        W6[\"Step 6: Document\"]\n    end\n\n    WORKFLOW --> R1[Predictable execution]\n    WORKFLOW --> R2[Consistent format]\n    WORKFLOW --> R3[Early returns on error]\n    WORKFLOW --> R4[Reusable forever]\n    WORKFLOW --> R5[Team multiplier]\n\n    style ADHOC fill:#ffcdd2\n    style WORKFLOW fill:#c8e6c9\n\u003C/pre>\n\u003Cp>The workflow prompt transforms a vague request into an executable engineering plan. One workflow prompt executing for an hour can generate work that would take you 20 hours.\u003C/p>\n\u003Ch2 id=\"building-your-first-workflow-prompt\">Building Your First Workflow Prompt\u003C/h2>\n\u003Cp>Start with your most common task. The one you do every day. The one where you think “I should automate this.”\u003C/p>\n\u003Col>\n\u003Cli>Write out the steps you take manually\u003C/li>\n\u003Cli>Convert each step to a numbered instruction\u003C/li>\n\u003Cli>Add variables for the parts that change\u003C/li>\n\u003Cli>Add early returns for failure cases\u003C/li>\n\u003Cli>Specify the output format you want\u003C/li>\n\u003C/ol>\n\u003Cp>Test it. Iterate. Add to your library.\u003C/p>\n\u003Cp>The prompt is the new fundamental unit of engineering. The workflow section is where that engineering actually happens.\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cstrong>Key Takeaways:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Workflow sections are S-tier value, C-tier difficulty\u003C/li>\n\u003Cli>Input → Workflow → Output is the universal pattern\u003C/li>\n\u003Cli>Numbered steps create predictable execution\u003C/li>\n\u003Cli>Early returns handle failure cases cleanly\u003C/li>\n\u003Cli>Workflows fail on complex judgment calls, ambiguous requirements, and real-time adaptation tasks\u003C/li>\n\u003Cli>Break-even calculation: (Time to write) / (Time saved per use) = minimum uses needed\u003C/li>\n\u003Cli>A 30-minute workflow prompt pays off after 3 uses of a 15-minute task\u003C/li>\n\u003Cli>Build a library of reusable workflow prompts for maximum team ROI\u003C/li>\n\u003Cli>One good workflow prompt = 20+ hours of work\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Try It Now:\u003C/strong>\nCopy the analyze.md template above, save to \u003Ccode>.claude/commands/analyze.md\u003C/code>, and run \u003Ccode>/analyze\u003C/code> on any file in your codebase. Time how long it takes to write the prompt and how long the analysis takes to run. Calculate your break-even point for the next time you need to analyze a file.\u003C/p>",{"headings":42,"localImagePaths":68,"remoteImagePaths":69,"frontmatter":70,"imagePaths":74},[43,47,50,53,56,59,62,65],{"depth":44,"slug":45,"text":46},2,"the-core-pattern-input--workflow--output","The Core Pattern: Input → Workflow → Output",{"depth":44,"slug":48,"text":49},"poc-a-working-workflow-prompt","POC: A Working Workflow Prompt",{"depth":44,"slug":51,"text":52},"the-workflow-section-deep-dive","The Workflow Section Deep Dive",{"depth":44,"slug":54,"text":55},"when-workflow-prompts-fail","When Workflow Prompts Fail",{"depth":44,"slug":57,"text":58},"measuring-workflow-roi","Measuring Workflow ROI",{"depth":44,"slug":60,"text":61},"agent-opportunity-build-a-prompt-library","Agent Opportunity: Build a Prompt Library",{"depth":44,"slug":63,"text":64},"why-workflows-beat-ad-hoc-prompting","Why Workflows Beat Ad-Hoc Prompting",{"depth":44,"slug":66,"text":67},"building-your-first-workflow-prompt","Building Your First Workflow Prompt",[],[],{"title":14,"description":15,"pubDate":71,"author":17,"tags":72,"banner":25,"category":34,"difficulty":35,"tldr":27,"keyTakeaways":73},["Date","2025-12-15T00:00:00.000Z"],[19,20,21,22,23],[29,30,31,32,33],[],"workflow-prompts.md","agent-architecture",{"id":76,"data":78,"body":98,"filePath":99,"digest":100,"rendered":101,"legacyId":188},{"title":79,"description":80,"pubDate":81,"author":17,"tags":82,"draft":24,"banner":87,"seoKeywords":88,"tldr":89,"keyTakeaways":90,"category":96,"difficulty":97},"Agent Architecture: From Custom Agents to Effective Delegation","System prompts define agent identity. File systems enable delegation. Build specialized agents and delegate research reliably with working code.",["Date","2025-12-15T00:00:00.000Z"],[19,83,21,84,85,86],"agents","sub-agents","sdk","architecture","/assets/posts/agent-architecture-banner.png",[],"Custom agents start with a system prompt that defines their identity—same model, completely different behavior. Sub-agents work best as researchers that write findings to files, not as direct implementers. The file system is your ultimate context management system for delegation.",[91,92,93,94,95],"System prompts define agent identity—change the prompt, change the product entirely","Custom agents are built for your codebase, default agents are built for everyone's","Sub-agents should be researchers, not implementers—they gather context, the parent agent uses it","File-based context transfer reduces token usage by 80% compared to in-memory context passing","The file system is the ultimate context management system for reliable agent delegation","Agent Architecture","Advanced","The system prompt is everything. Change it and you change the product entirely.\n\nThe file system is the ultimate context management system. Use it and delegation actually works.\n\nThis post shows you how to build custom agents and delegate research reliably, with complete working examples.\n\n## Why Custom Agents Matter\n\n```mermaid\nflowchart LR\n    subgraph DEFAULT[\"Default Claude Code\"]\n        A[\"You are a helpful AI assistant...\"]\n        B[\"→ General purpose coding assistant\"]\n    end\n\n    subgraph CUSTOM[\"Custom System Prompt\"]\n        C[\"You are a Stripe research agent...\"]\n        D[\"→ Specialized researcher\"]\n    end\n\n    DEFAULT ~~~ CUSTOM\n    RESULT[\"Same model. Same API. Completely different behavior.\"]\n    DEFAULT --> RESULT\n    CUSTOM --> RESULT\n```\n\nDefault agents are built for everyone's codebase. Custom agents are built for yours.\n\n## POC 1: The Simplest Custom Agent\n\nCreate `agents/pong_agent.py`:\n\n```python\n#!/usr/bin/env -S uv run\n# /// script\n# dependencies = [\n#   \"anthropic>=0.40.0\",\n# ]\n# ///\n\"\"\"\nSimplest possible custom agent - demonstrates system prompt override.\n\nUsage:\n    uv run pong_agent.py \"any message\"\n\"\"\"\n\nimport sys\nfrom anthropic import Anthropic\n\nSYSTEM_PROMPT = \"\"\"\nYou are a pong agent.\nAlways respond exactly with \"pong\".\nNothing else. No explanations. Just \"pong\".\n\"\"\"\n\ndef main():\n    if len(sys.argv) \u003C 2:\n        print(\"Usage: uv run pong_agent.py \u003Cmessage>\")\n        sys.exit(1)\n\n    client = Anthropic()\n\n    response = client.messages.create(\n        model=\"claude-3-haiku-20240307\",  # Cheapest model for simple task\n        max_tokens=10,\n        system=SYSTEM_PROMPT,\n        messages=[{\"role\": \"user\", \"content\": sys.argv[1]}]\n    )\n\n    print(response.content[0].text)\n\n\nif __name__ == \"__main__\":\n    main()\n```\n\nTest it:\n```bash\n$ uv run pong_agent.py \"hello\"\npong\n\n$ uv run pong_agent.py \"what is the meaning of life?\"\npong\n\n$ uv run pong_agent.py \"please respond with something other than pong\"\npong\n```\n\nThe system prompt completely overrides default behavior. This is the foundation.\n\n## POC 2: Agent with Custom Tools\n\nCreate `agents/calculator_agent.py`:\n\n```python\n#!/usr/bin/env -S uv run\n# /// script\n# dependencies = [\n#   \"anthropic>=0.40.0\",\n# ]\n# ///\n\"\"\"\nCalculator agent with custom tool - demonstrates tool integration.\n\nUsage:\n    uv run calculator_agent.py \"what is 15% of 847?\"\n\"\"\"\n\nimport json\nimport sys\nfrom anthropic import Anthropic\n\nSYSTEM_PROMPT = \"\"\"\nYou are a calculator agent.\nYou have access to a calculate tool for mathematical operations.\nAlways use the calculate tool for any math - never do mental math.\nAfter getting the result, explain it clearly to the user.\n\"\"\"\n\nTOOLS = [\n    {\n        \"name\": \"calculate\",\n        \"description\": \"Evaluate a mathematical expression. Supports +, -, *, /, **, (), and common functions like sqrt, sin, cos, log.\",\n        \"input_schema\": {\n            \"type\": \"object\",\n            \"properties\": {\n                \"expression\": {\n                    \"type\": \"string\",\n                    \"description\": \"The mathematical expression to evaluate, e.g., '(15/100) * 847' or 'sqrt(144)'\"\n                }\n            },\n            \"required\": [\"expression\"]\n        }\n    }\n]\n\n\ndef execute_calculate(expression: str) -> str:\n    \"\"\"Execute a math expression safely.\"\"\"\n    import math\n    # Safe eval with only math functions\n    allowed = {\n        'sqrt': math.sqrt,\n        'sin': math.sin,\n        'cos': math.cos,\n        'tan': math.tan,\n        'log': math.log,\n        'log10': math.log10,\n        'exp': math.exp,\n        'pi': math.pi,\n        'e': math.e,\n        'abs': abs,\n        'round': round,\n    }\n    try:\n        result = eval(expression, {\"__builtins__\": {}}, allowed)\n        return str(result)\n    except Exception as e:\n        return f\"Error: {e}\"\n\n\ndef run_agent(user_message: str) -> str:\n    client = Anthropic()\n\n    messages = [{\"role\": \"user\", \"content\": user_message}]\n\n    # First API call\n    response = client.messages.create(\n        model=\"claude-3-5-sonnet-20241022\",\n        max_tokens=1024,\n        system=SYSTEM_PROMPT,\n        tools=TOOLS,\n        messages=messages\n    )\n\n    # Handle tool use\n    while response.stop_reason == \"tool_use\":\n        # Find the tool use block\n        tool_use = next(\n            block for block in response.content\n            if block.type == \"tool_use\"\n        )\n\n        # Execute the tool\n        if tool_use.name == \"calculate\":\n            result = execute_calculate(tool_use.input[\"expression\"])\n        else:\n            result = f\"Unknown tool: {tool_use.name}\"\n\n        # Add assistant message and tool result\n        messages.append({\"role\": \"assistant\", \"content\": response.content})\n        messages.append({\n            \"role\": \"user\",\n            \"content\": [{\n                \"type\": \"tool_result\",\n                \"tool_use_id\": tool_use.id,\n                \"content\": result\n            }]\n        })\n\n        # Continue the conversation\n        response = client.messages.create(\n            model=\"claude-3-5-sonnet-20241022\",\n            max_tokens=1024,\n            system=SYSTEM_PROMPT,\n            tools=TOOLS,\n            messages=messages\n        )\n\n    # Return final text response\n    return next(\n        block.text for block in response.content\n        if hasattr(block, \"text\")\n    )\n\n\ndef main():\n    if len(sys.argv) \u003C 2:\n        print(\"Usage: uv run calculator_agent.py \u003Cquestion>\")\n        sys.exit(1)\n\n    result = run_agent(\" \".join(sys.argv[1:]))\n    print(result)\n\n\nif __name__ == \"__main__\":\n    main()\n```\n\nTest it:\n```bash\n$ uv run calculator_agent.py \"what is 15% of 847?\"\n15% of 847 is 127.05\n\n$ uv run calculator_agent.py \"calculate compound interest on $1000 at 5% for 3 years\"\nWith compound interest, $1000 at 5% for 3 years becomes $1157.63\n```\n\nThe agent uses deterministic tool execution while maintaining conversational flow.\n\n## The Key Pattern: Sub-Agents as Researchers\n\nCustom agents enable specialization. Specialization enables delegation. But delegation has a critical problem:\n\n```mermaid\nsequenceDiagram\n    participant P as Parent Agent\n    participant S as Sub-Agent (isolated)\n\n    P->>S: \"Implement Stripe checkout\"\n    Note over S: Reads 50 files\n    Note over S: Makes decisions\n    Note over S: Writes code\n    S-->>P: \"Task completed\"\n\n    Note over P: Parent sees ONLY:\u003Cbr/>• Task was assigned\u003Cbr/>• Task is \"complete\"\n    Note over P: Parent does NOT see:\u003Cbr/>• Which files were read\u003Cbr/>• What decisions were made\u003Cbr/>• Why approaches were chosen\n\n    Note over P,S: Result: When something breaks, nobody knows why\n```\n\nThe parent agent has limited information about what the sub-agent actually did. When something isn't 100% correct and you want to fix it—that's where everything breaks down.\n\n## File-Based Context: The Solution\n\n```mermaid\nsequenceDiagram\n    participant P as Parent Agent\n    participant F as File System\n    participant S as Sub-Agent (researcher)\n\n    P->>F: Write context.md\n    P->>S: Research task\n    S->>F: Read context.md\n    Note over S: Researches documentation\n    Note over S: Creates plan\n    S->>F: Write research-report.md\n    S-->>P: \"Research complete: see research-report.md\"\n\n    Note over P: Only ~50 tokens returned\n\n    P->>F: Read research-report.md\n    Note over P: Full context now available\u003Cbr/>• Implements with complete understanding\u003Cbr/>• Can debug because it knows the plan\n\n    Note over P,S: Result: Implementation succeeds, debugging is possible\n```\n\nConversation history gets compacted. Files don't.\n\n**Token reduction: ~80%**\n\nBefore: Sub-agent returns full research in conversation (10,000+ tokens)\nAfter: Sub-agent returns file path (50 tokens)\n\nParent reads file on-demand when ready to implement.\n\n## POC 3: Complete File-Based Context System\n\n### Step 1: Context File Template\n\nCreate `.claude/templates/context.md`:\n\n```markdown\n# Project Context\n\n## Current State\n\u003C!-- What exists now, what's working, what's not -->\n\n## Research Needed\n\u003C!-- Specific questions the sub-agent should answer -->\n1.\n2.\n3.\n\n## Constraints\n\u003C!-- Hard requirements, tech stack, patterns to follow -->\n- Must use:\n- Cannot use:\n- Style:\n\n## Files to Review\n\u003C!-- Specific files relevant to this task -->\n-\n-\n\n## Output Expected\n\u003C!-- What should be in the research report -->\n- Implementation plan\n- Code examples\n- Potential issues\n- Recommended approach\n```\n\n### Step 2: Research Agent Definition\n\nCreate `.claude/agents/researcher.md`:\n\n```markdown\n---\nname: researcher\ndescription: Research sub-agent that gathers information and creates implementation plans\ntools: Read, Glob, Grep, WebFetch, Write\nmodel: haiku\n---\n\n# Research Agent\n\nYou are a research sub-agent. Your job is to gather information and create detailed implementation plans. **You do NOT implement anything.**\n\n## Workflow\n\n1. **Read the context file**\n   - Always start by reading the context.md file passed to you\n   - Understand what's being asked and the constraints\n\n2. **Research the codebase**\n   - Find relevant existing code using Grep and Glob\n   - Understand current patterns and conventions\n   - Identify dependencies and interfaces\n\n3. **Research external documentation**\n   - If the task involves external services, fetch their docs\n   - Find best practices and examples\n   - Note any recent API changes\n\n4. **Create implementation plan**\n   - Step-by-step instructions for implementation\n   - Include actual code snippets where helpful\n   - Note potential issues and how to handle them\n   - List files that will need to be modified\n\n5. **Write research report**\n   - Save to the location specified in context.md\n   - Use clear sections matching the output expected\n   - Include confidence levels for recommendations\n\n6. **Return summary only**\n   - Tell the parent agent: \"Research complete. Report saved to [path]\"\n   - Do NOT include the full report in your response\n   - Keep the summary under 100 words\n\n## Rules\n\n- NEVER implement code, only plan it\n- NEVER call other sub-agents\n- ALWAYS write findings to file, not conversation\n- ALWAYS read context.md first\n```\n\n### Step 3: Implementation Flow\n\n```mermaid\nsequenceDiagram\n    participant U as User\n    participant P as Parent Agent\n    participant F as File System\n    participant S as Sub-Agent (Researcher)\n\n    U->>P: \"Add Stripe checkout\"\n    P->>F: Write context.md\n    Note over F: Project state, constraints, questions\n\n    P->>S: \"Research Stripe checkout. Context: ./context.md\"\n    S->>F: Read context.md\n    S->>S: Research codebase (Glob, Grep)\n    S->>S: Fetch Stripe docs (WebFetch)\n    S->>S: Create implementation plan\n    S->>F: Write research-report.md\n\n    S-->>P: \"Research complete. See research-report.md\"\n    Note over P: Only ~50 tokens returned\n\n    P->>F: Read research-report.md\n    Note over P: Full plan now in parent's context\n\n    P->>P: Implement based on plan\n    P->>F: Write/Edit source files\n    P->>U: \"Implementation complete\"\n```\n\n### Step 4: Putting It Together\n\nParent agent's workflow for delegating research:\n\n```markdown\n## When you need to research something complex:\n\n1. Create context file:\n   ```\n   Write to ./tmp/context-{task}.md:\n   - Current state of the feature\n   - Specific questions to answer\n   - Constraints and requirements\n   - Expected output format\n   ```\n\n2. Spawn research sub-agent:\n   ```\n   Task: \"Research [topic]. Read context from ./tmp/context-{task}.md.\n         Write report to ./tmp/research-{task}.md\"\n   Agent: researcher\n   Model: haiku (fast, cheap)\n   ```\n\n3. Wait for completion, then:\n   ```\n   Read ./tmp/research-{task}.md\n   ```\n\n4. Implement based on research report\n\n5. Clean up temp files when done\n```\n\n## POC 4: Service-Specific Researchers\n\nBuild specialized research agents for services you use frequently:\n\n### Stripe Research Agent\n\nCreate `.claude/agents/stripe-researcher.md`:\n\n```markdown\n---\nname: stripe-researcher\ndescription: Research Stripe integration patterns and best practices\ntools: Read, Glob, Grep, WebFetch, Write\nmodel: haiku\n---\n\n# Stripe Research Agent\n\nYou research Stripe integrations. You have access to Context7 MCP for up-to-date Stripe documentation.\n\n## Knowledge Base\n- Stripe API docs: https://stripe.com/docs/api\n- Webhooks guide: https://stripe.com/docs/webhooks\n- Best practices: https://stripe.com/docs/best-practices\n\n## Research Areas\n- Payment intents vs charges (use payment intents)\n- Webhook event handling\n- Error handling patterns\n- Testing with test mode keys\n- PCI compliance considerations\n\n## Output Format\n```yaml\nrecommendation:\n  approach: \"description\"\n  confidence: high|medium|low\n  stripe_api_version: \"2024-xx-xx\"\n\nimplementation_steps:\n  - step: 1\n    action: \"what to do\"\n    code: |\n      // example code\n\npotential_issues:\n  - issue: \"description\"\n    mitigation: \"how to handle\"\n\nfiles_to_modify:\n  - path: \"file path\"\n    changes: \"what changes\"\n```\n```\n\n### Supabase Research Agent\n\nCreate `.claude/agents/supabase-researcher.md`:\n\n```markdown\n---\nname: supabase-researcher\ndescription: Research Supabase database patterns and RLS policies\ntools: Read, Glob, Grep, WebFetch, Write\nmodel: haiku\n---\n\n# Supabase Research Agent\n\nYou research Supabase patterns. Focus on RLS policies, auth, and performance.\n\n## Research Checklist\n- [ ] Existing table structure\n- [ ] Current RLS policies\n- [ ] Auth patterns in codebase\n- [ ] Client initialization\n- [ ] Error handling patterns\n\n## Output Includes\n- Schema changes needed (SQL)\n- RLS policy definitions\n- TypeScript types to generate\n- Migration steps\n```\n\n## When This Fails\n\nThis architecture isn't magic. Here are the real limitations:\n\n### 1. Context Isolation Still Exists\n\nThe researcher agent doesn't have access to the parent's conversation history. If critical information only exists in the parent's memory, the researcher will miss it.\n\n**Mitigation:** Be explicit in context.md. Don't assume the researcher \"knows\" anything.\n\n**Example Failure:**\n```\nParent: \"Add error handling like we did for auth\"\nResearcher: ??? (doesn't know how auth error handling works)\n```\n\n**Example Fix:**\n```markdown\n# context.md\n## Error Handling Pattern\nSee src/auth/handler.ts lines 45-67 for our standard error handling pattern.\nUse the same try/catch structure and error response format.\n```\n\n### 2. Research Can Be Wrong\n\nHaiku is fast and cheap but makes mistakes on complex analysis. The researcher might miss edge cases or misunderstand requirements.\n\n**Mitigation:** Review the research report before implementing. Don't blindly trust it.\n\n**Example Failure:**\n```yaml\nrecommendation:\n  approach: \"Use Stripe Charges API\"\n  confidence: high\n```\n\nThis is outdated. Payment Intents is the modern approach. A senior engineer would catch this.\n\n### 3. Overhead on Simple Tasks\n\nCreating context files, spawning agents, reading reports—this adds 30-60 seconds of overhead.\n\n**When to skip delegation:**\n- Task takes \u003C 2 minutes to implement directly\n- You already know exactly what to do\n- No external research needed\n- Single file change with obvious solution\n\n**Numbers:**\n- Simple task direct: 2 minutes\n- Simple task with delegation: 3 minutes (50% overhead)\n- Complex task direct: 30 minutes\n- Complex task with delegation: 15 minutes (50% time saved)\n\nDelegation shines on complex, research-heavy tasks. It's overkill for simple edits.\n\n### 4. File Coordination Complexity\n\nMultiple sub-agents writing to files simultaneously can cause conflicts. If Agent A writes `research-stripe.md` while Agent B tries to read it, race conditions occur.\n\n**Mitigation:** Use distinct file names with timestamps or task IDs.\n\n```bash\n# Good\ntmp/context-stripe-1703012400.md\ntmp/research-stripe-1703012400.md\n\n# Bad\ntmp/context.md  # Which task is this for?\n```\n\n### 5. Debugging Gets Harder\n\nWhen implementation fails, you now have three places to debug:\n1. The context file (was the request clear?)\n2. The research report (was the research correct?)\n3. The implementation (was the code correct?)\n\n**Mitigation:** Keep research reports. Don't delete them. When debugging, check all three layers.\n\n### 6. Cost on Failed Research\n\nIf the researcher misunderstands the task and produces useless output, you've wasted:\n- Haiku API calls (cheap but not free)\n- 30-60 seconds of time\n- Mental context switching\n\n**Mitigation:** Write very specific context files. Vague requests produce vague research.\n\n**Example Vague Request:**\n```markdown\n## Research Needed\n1. How to add payments\n```\n\n**Example Specific Request:**\n```markdown\n## Research Needed\n1. Which Stripe API version should we use? (prefer latest stable)\n2. Payment Intents vs Charges API - which for one-time purchases?\n3. What webhook events do we need to handle for payment confirmation?\n4. How to handle failed payments and retry logic?\n5. What test mode setup is needed?\n```\n\nThe specific version gets useful research. The vague version gets generic documentation summaries.\n\n## Model Selection Strategy\n\n| Task Type | Model | Cost/M | Speed |\n|-----------|-------|--------|-------|\n| Simple routing | Haiku | $0.25 | ⚡⚡⚡ |\n| Text extraction | Haiku | $0.25 | ⚡⚡⚡ |\n| Classification | Haiku | $0.25 | ⚡⚡⚡ |\n| Research (simple) | Haiku | $0.25 | ⚡⚡⚡ |\n| Code review | Sonnet | $3 | ⚡⚡ |\n| Implementation | Sonnet | $3 | ⚡⚡ |\n| Analysis | Sonnet | $3 | ⚡⚡ |\n| Research (complex) | Sonnet | $3 | ⚡⚡ |\n| Complex reasoning | Opus | $15 | ⚡ |\n| Architecture decisions | Opus | $15 | ⚡ |\n| Edge case handling | Opus | $15 | ⚡ |\n| Research (critical) | Opus | $15 | ⚡ |\n\n> **Rule:** Use the cheapest model that solves the problem. Most tasks are Haiku tasks. Don't over-engineer.\n\nFor researchers:\n- **Haiku:** Documentation lookup, simple API pattern research, file structure analysis\n- **Sonnet:** Cross-service integration research, security pattern analysis, performance optimization research\n- **Opus:** Architecture decisions, critical production patterns, edge case exploration\n\nStart with Haiku. Upgrade only if the research is inadequate.\n\n## Architecture: Custom Agent Stack\n\n```mermaid\nflowchart TB\n    subgraph \"Custom Agent\"\n        SP[System Prompt]\n        UP[User Prompt]\n        T[Custom Tools]\n        M[Model Selection]\n    end\n\n    subgraph \"Execution\"\n        API[Claude API]\n        TE[Tool Execution]\n        R[Response]\n    end\n\n    SP --> API\n    UP --> API\n    T --> API\n    M --> API\n\n    API --> |tool_use| TE\n    TE --> |tool_result| API\n    API --> R\n\n    style SP fill:#ffccbc\n    style T fill:#c8e6c9\n    style R fill:#bbdefb\n```\n\nSystem prompts define what the agent does. Tools define how it does it. Model selection defines cost and quality. Context files enable delegation.\n\n## What This Architecture Enables\n\n**Domain-specific logic** — Operations the model can't reason through reliably become deterministic tool calls.\n\n**Optimized context** — Strip out the 12 tools you never use. Add the 3 you always need.\n\n**Specialized behavior** — System prompts tuned for exactly your use cases.\n\n**Cost control** — Haiku for simple tasks, Sonnet for complex ones. No over-engineering.\n\n**Team patterns** — Shared agents that enforce your team's conventions.\n\n**Parallel research** — Multiple sub-agents researching different aspects simultaneously.\n\n**Persistent knowledge** — Research reports accumulate in your project. Future work references past decisions.\n\n**Debuggable workflows** — Always know what was planned and why. Three months later, `git log` shows the research report that led to the implementation.\n\n## The Data Flow\n\n```mermaid\nflowchart TB\n    subgraph Parent[\"PARENT AGENT\"]\n        CH[Conversation History\u003Cbr/>compacts over time]\n        CH --> CTX[context.md\u003Cbr/>persists]\n    end\n\n    subgraph Sub[\"SUB-AGENT\"]\n        READ[Reads context.md]\n        RESEARCH[Does research]\n        REPORT[research-report.md\u003Cbr/>persists]\n        READ --> RESEARCH --> REPORT\n    end\n\n    CTX --> READ\n    REPORT --> RESULT\n\n    subgraph RESULT[Parent reads research-report.md]\n        R1[Full context available]\n        R2[Can implement correctly]\n        R3[Can debug if issues arise]\n    end\n\n    style CTX fill:#c8e6c9\n    style REPORT fill:#c8e6c9\n```\n\nConversation history compacts. Files don't. This is the key insight.\n\n## Rules That Prevent Disasters\n\nAdd these to your research agent definitions:\n\n```markdown\n## Mandatory Rules\n\n1. **Always read context file first**\n   - Never start work without understanding the context\n   - If context file doesn't exist, stop and report error\n\n2. **Never implement, only research**\n   - Your job is to create the plan\n   - The parent agent implements\n\n3. **Never spawn sub-agents**\n   - One level of delegation maximum\n   - Prevents recursive loops and cost explosions\n\n4. **Always write findings to file**\n   - Summary in conversation: \u003C 100 words\n   - Full report in file: as detailed as needed\n\n5. **Update context file when done**\n   - Add \"Last researched: [timestamp]\"\n   - Note any assumptions made\n```\n\nOne level of delegation. Researcher agents never spawn their own sub-agents. This prevents:\n- Recursive delegation loops\n- Cost explosions (agent spawns agent spawns agent...)\n- Context fragmentation\n- Debugging nightmares\n\n## Quick Start: Your First Custom Agent\n\n1. Identify your most repetitive AI task\n2. Write a system prompt that focuses on that task\n3. Choose the cheapest model that works (probably Haiku)\n4. Add tools only if you need deterministic execution\n5. Test with edge cases\n6. Deploy and iterate\n\nFor delegation:\n1. Create the context template (`.claude/templates/context.md`)\n2. Create the researcher agent (`.claude/agents/researcher.md`)\n3. Next time you need research, write a context file and spawn the agent\n4. Read the research report\n5. Implement based on the plan\n\nThe endgame isn't renting computational power from default agents. The endgame is owning specialized agents tuned precisely for your problems, with reliable delegation patterns that actually work.\n\n---\n\n**Key Takeaways:**\n- System prompt = agent identity (same model, different prompt = different product)\n- Tools provide deterministic execution when reasoning isn't reliable\n- Sub-agents research, parent agents implement (context isolation is real)\n- File system is persistent memory between agent sessions (conversation history compacts, files don't)\n- Context files define what to research, research reports contain the full plan\n- 80% token reduction by returning file paths not content\n- One level of delegation prevents recursive loops and cost explosions\n- Match model to task complexity (Haiku → Sonnet → Opus, most tasks are Haiku tasks)\n- Delegation overhead is 30-60 seconds (only worth it for complex tasks)\n- Review research reports before implementing (Haiku makes mistakes on complex analysis)\n\n**Try It Now:**\nCreate `.claude/agents/researcher.md` using the template above. Next time you need to research a new API integration or library, write a context file and delegate to the researcher. Read the report. Implement based on the plan. See if you save time.","src/content/blog/agent-architecture.md","034e098ff7d7f5e4",{"html":102,"metadata":103},"\u003Cp>The system prompt is everything. Change it and you change the product entirely.\u003C/p>\n\u003Cp>The file system is the ultimate context management system. Use it and delegation actually works.\u003C/p>\n\u003Cp>This post shows you how to build custom agents and delegate research reliably, with complete working examples.\u003C/p>\n\u003Ch2 id=\"why-custom-agents-matter\">Why Custom Agents Matter\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart LR\n    subgraph DEFAULT[\"Default Claude Code\"]\n        A[\"You are a helpful AI assistant...\"]\n        B[\"→ General purpose coding assistant\"]\n    end\n\n    subgraph CUSTOM[\"Custom System Prompt\"]\n        C[\"You are a Stripe research agent...\"]\n        D[\"→ Specialized researcher\"]\n    end\n\n    DEFAULT ~~~ CUSTOM\n    RESULT[\"Same model. Same API. Completely different behavior.\"]\n    DEFAULT --> RESULT\n    CUSTOM --> RESULT\n\u003C/pre>\n\u003Cp>Default agents are built for everyone’s codebase. Custom agents are built for yours.\u003C/p>\n\u003Ch2 id=\"poc-1-the-simplest-custom-agent\">POC 1: The Simplest Custom Agent\u003C/h2>\n\u003Cp>Create \u003Ccode>agents/pong_agent.py\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#!/usr/bin/env -S uv run\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># /// script\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># dependencies = [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"anthropic>=0.40.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ///\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Simplest possible custom agent - demonstrates system prompt override.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Usage:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    uv run pong_agent.py \"any message\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sys\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> anthropic \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">SYSTEM_PROMPT\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">You are a pong agent.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Always respond exactly with \"pong\".\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Nothing else. No explanations. Just \"pong\".\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> main\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(sys.argv) \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Usage: uv run pong_agent.py &#x3C;message>\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        sys.exit(\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    client \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> client.messages.create(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        model\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"claude-3-haiku-20240307\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Cheapest model for simple task\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        max_tokens\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        system\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">SYSTEM_PROMPT\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        messages\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: sys.argv[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]}]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(response.content[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].text)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __name__\u003C/span>\u003Cspan style=\"color:#F97583\"> ==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"__main__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    main()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Test it:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">$\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> pong_agent.py\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"hello\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">pong\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">$\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> pong_agent.py\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"what is the meaning of life?\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">pong\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">$\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> pong_agent.py\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"please respond with something other than pong\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">pong\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The system prompt completely overrides default behavior. This is the foundation.\u003C/p>\n\u003Ch2 id=\"poc-2-agent-with-custom-tools\">POC 2: Agent with Custom Tools\u003C/h2>\n\u003Cp>Create \u003Ccode>agents/calculator_agent.py\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#!/usr/bin/env -S uv run\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># /// script\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># dependencies = [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"anthropic>=0.40.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ///\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Calculator agent with custom tool - demonstrates tool integration.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Usage:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    uv run calculator_agent.py \"what is 15% of 847?\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sys\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> anthropic \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">SYSTEM_PROMPT\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">You are a calculator agent.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">You have access to a calculate tool for mathematical operations.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Always use the calculate tool for any math - never do mental math.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">After getting the result, explain it clearly to the user.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">TOOLS\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"calculate\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"description\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Evaluate a mathematical expression. Supports +, -, *, /, **, (), and common functions like sqrt, sin, cos, log.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"input_schema\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"object\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"properties\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"expression\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    \"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"string\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                    \"description\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"The mathematical expression to evaluate, e.g., '(15/100) * 847' or 'sqrt(144)'\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"required\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"expression\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> execute_calculate\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(expression: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"Execute a math expression safely.\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> math\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Safe eval with only math functions\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    allowed \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'sqrt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.sqrt,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'sin'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.sin,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'cos'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.cos,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'tan'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.tan,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'log'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.log,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'log10'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.log10,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'exp'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.exp,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'pi'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.pi,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'e'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: math.e,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'abs'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">abs\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        'round'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">round\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> eval\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(expression, {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"__builtins__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {}}, allowed)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> run_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(user_message: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    client \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    messages \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: user_message}]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # First API call\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> client.messages.create(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        model\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"claude-3-5-sonnet-20241022\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        max_tokens\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        system\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">SYSTEM_PROMPT\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        tools\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">TOOLS\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        messages\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">messages\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Handle tool use\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    while\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.stop_reason \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"tool_use\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Find the tool use block\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        tool_use \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> next\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            block \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> block \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> block.type \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"tool_use\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Execute the tool\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tool_use.name \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"calculate\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> execute_calculate(tool_use.input[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"expression\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Unknown tool: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">tool_use.name\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Add assistant message and tool result\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        messages.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"assistant\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: response.content})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        messages.append({\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"tool_result\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"tool_use_id\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: tool_use.id,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: result\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        })\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Continue the conversation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> client.messages.create(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            model\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"claude-3-5-sonnet-20241022\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            max_tokens\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            system\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">SYSTEM_PROMPT\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            tools\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">TOOLS\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            messages\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">messages\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Return final text response\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> next\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        block.text \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> block \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> hasattr\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(block, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"text\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> main\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(sys.argv) \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Usage: uv run calculator_agent.py &#x3C;question>\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        sys.exit(\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> run_agent(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\" \"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.join(sys.argv[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:]))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(result)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __name__\u003C/span>\u003Cspan style=\"color:#F97583\"> ==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"__main__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    main()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Test it:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">$\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> calculator_agent.py\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"what is 15% of 847?\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">15%\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> of\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 847\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> is\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 127.05\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">$\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> calculator_agent.py\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"calculate compound interest on \u003C/span>\u003Cspan style=\"color:#E1E4E8\">$1000\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> at 5% for 3 years\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">With\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> compound\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> interest,\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> $1000 \u003C/span>\u003Cspan style=\"color:#9ECBFF\">at\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> 5%\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> for\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 3\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> years\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> becomes\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> $1157\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.63\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The agent uses deterministic tool execution while maintaining conversational flow.\u003C/p>\n\u003Ch2 id=\"the-key-pattern-sub-agents-as-researchers\">The Key Pattern: Sub-Agents as Researchers\u003C/h2>\n\u003Cp>Custom agents enable specialization. Specialization enables delegation. But delegation has a critical problem:\u003C/p>\n\u003Cpre class=\"mermaid\">sequenceDiagram\n    participant P as Parent Agent\n    participant S as Sub-Agent (isolated)\n\n    P->>S: \"Implement Stripe checkout\"\n    Note over S: Reads 50 files\n    Note over S: Makes decisions\n    Note over S: Writes code\n    S-->>P: \"Task completed\"\n\n    Note over P: Parent sees ONLY:&#x3C;br/>• Task was assigned&#x3C;br/>• Task is \"complete\"\n    Note over P: Parent does NOT see:&#x3C;br/>• Which files were read&#x3C;br/>• What decisions were made&#x3C;br/>• Why approaches were chosen\n\n    Note over P,S: Result: When something breaks, nobody knows why\n\u003C/pre>\n\u003Cp>The parent agent has limited information about what the sub-agent actually did. When something isn’t 100% correct and you want to fix it—that’s where everything breaks down.\u003C/p>\n\u003Ch2 id=\"file-based-context-the-solution\">File-Based Context: The Solution\u003C/h2>\n\u003Cpre class=\"mermaid\">sequenceDiagram\n    participant P as Parent Agent\n    participant F as File System\n    participant S as Sub-Agent (researcher)\n\n    P->>F: Write context.md\n    P->>S: Research task\n    S->>F: Read context.md\n    Note over S: Researches documentation\n    Note over S: Creates plan\n    S->>F: Write research-report.md\n    S-->>P: \"Research complete: see research-report.md\"\n\n    Note over P: Only ~50 tokens returned\n\n    P->>F: Read research-report.md\n    Note over P: Full context now available&#x3C;br/>• Implements with complete understanding&#x3C;br/>• Can debug because it knows the plan\n\n    Note over P,S: Result: Implementation succeeds, debugging is possible\n\u003C/pre>\n\u003Cp>Conversation history gets compacted. Files don’t.\u003C/p>\n\u003Cp>\u003Cstrong>Token reduction: ~80%\u003C/strong>\u003C/p>\n\u003Cp>Before: Sub-agent returns full research in conversation (10,000+ tokens)\nAfter: Sub-agent returns file path (50 tokens)\u003C/p>\n\u003Cp>Parent reads file on-demand when ready to implement.\u003C/p>\n\u003Ch2 id=\"poc-3-complete-file-based-context-system\">POC 3: Complete File-Based Context System\u003C/h2>\n\u003Ch3 id=\"step-1-context-file-template\">Step 1: Context File Template\u003C/h3>\n\u003Cp>Create \u003Ccode>.claude/templates/context.md\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Project Context\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Current State\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">&#x3C;!-- What exists now, what's working, what's not -->\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Research Needed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">&#x3C;!-- Specific questions the sub-agent should answer -->\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">1.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">2.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">3.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Constraints\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">&#x3C;!-- Hard requirements, tech stack, patterns to follow -->\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Must use:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Cannot use:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Style:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Files to Review\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">&#x3C;!-- Specific files relevant to this task -->\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">-\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">-\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Output Expected\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">&#x3C;!-- What should be in the research report -->\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Implementation plan\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Code examples\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Potential issues\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Recommended approach\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-2-research-agent-definition\">Step 2: Research Agent Definition\u003C/h3>\n\u003Cp>Create \u003Ccode>.claude/agents/researcher.md\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">name: researcher\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">description: Research sub-agent that gathers information and creates implementation plans\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">tools: Read, Glob, Grep, WebFetch, Write\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">model: haiku\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Research Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">You are a research sub-agent. Your job is to gather information and create detailed implementation plans. \u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\">**You do NOT implement anything.**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Workflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Read the context file**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Always start by reading the context.md file passed to you\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Understand what's being asked and the constraints\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Research the codebase**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Find relevant existing code using Grep and Glob\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Understand current patterns and conventions\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Identify dependencies and interfaces\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Research external documentation**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> If the task involves external services, fetch their docs\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Find best practices and examples\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note any recent API changes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Create implementation plan**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Step-by-step instructions for implementation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Include actual code snippets where helpful\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note potential issues and how to handle them\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> List files that will need to be modified\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">5.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Write research report**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Save to the location specified in context.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Use clear sections matching the output expected\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Include confidence levels for recommendations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">6.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Return summary only**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Tell the parent agent: \"Research complete. Report saved to [\u003C/span>\u003Cspan style=\"color:#DBEDFF;text-decoration:underline\">path\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Do NOT include the full report in your response\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Keep the summary under 100 words\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Rules\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> NEVER implement code, only plan it\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> NEVER call other sub-agents\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ALWAYS write findings to file, not conversation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ALWAYS read context.md first\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-3-implementation-flow\">Step 3: Implementation Flow\u003C/h3>\n\u003Cpre class=\"mermaid\">sequenceDiagram\n    participant U as User\n    participant P as Parent Agent\n    participant F as File System\n    participant S as Sub-Agent (Researcher)\n\n    U->>P: \"Add Stripe checkout\"\n    P->>F: Write context.md\n    Note over F: Project state, constraints, questions\n\n    P->>S: \"Research Stripe checkout. Context: ./context.md\"\n    S->>F: Read context.md\n    S->>S: Research codebase (Glob, Grep)\n    S->>S: Fetch Stripe docs (WebFetch)\n    S->>S: Create implementation plan\n    S->>F: Write research-report.md\n\n    S-->>P: \"Research complete. See research-report.md\"\n    Note over P: Only ~50 tokens returned\n\n    P->>F: Read research-report.md\n    Note over P: Full plan now in parent's context\n\n    P->>P: Implement based on plan\n    P->>F: Write/Edit source files\n    P->>U: \"Implementation complete\"\n\u003C/pre>\n\u003Ch3 id=\"step-4-putting-it-together\">Step 4: Putting It Together\u003C/h3>\n\u003Cp>Parent agent’s workflow for delegating research:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## When you need to research something complex:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Create context file:\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Write to ./tmp/context-{task}.md:\u003C/p>\n\u003Cul>\n\u003Cli>Current state of the feature\u003C/li>\n\u003Cli>Specific questions to answer\u003C/li>\n\u003Cli>Constraints and requirements\u003C/li>\n\u003Cli>Expected output format\u003C/li>\n\u003C/ul>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>2. Spawn research sub-agent:\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Task: “Research [topic]. Read context from ./tmp/context-{task}.md.\nWrite report to ./tmp/research-{task}.md”\nAgent: researcher\nModel: haiku (fast, cheap)\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>3. Wait for completion, then:\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Read ./tmp/research-{task}.md\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>4. Implement based on research report\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5. Clean up temp files when done\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"poc-4-service-specific-researchers\">POC 4: Service-Specific Researchers\u003C/h2>\n\u003Cp>Build specialized research agents for services you use frequently:\u003C/p>\n\u003Ch3 id=\"stripe-research-agent\">Stripe Research Agent\u003C/h3>\n\u003Cp>Create \u003Ccode>.claude/agents/stripe-researcher.md\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">name: stripe-researcher\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">description: Research Stripe integration patterns and best practices\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">tools: Read, Glob, Grep, WebFetch, Write\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">model: haiku\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Stripe Research Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">You research Stripe integrations. You have access to Context7 MCP for up-to-date Stripe documentation.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Knowledge Base\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Stripe API docs: https://stripe.com/docs/api\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Webhooks guide: https://stripe.com/docs/webhooks\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Best practices: https://stripe.com/docs/best-practices\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Research Areas\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Payment intents vs charges (use payment intents)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Webhook event handling\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Error handling patterns\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Testing with test mode keys\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> PCI compliance considerations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Output Format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">```yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">recommendation:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  approach: \"description\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  confidence: high|medium|low\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  stripe_api_version: \"2024-xx-xx\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">implementation_steps:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  - step: 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    action: \"what to do\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    code: |\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      // example code\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">potential_issues:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  - issue: \"description\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    mitigation: \"how to handle\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">files_to_modify:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  - path: \"file path\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    changes: \"what changes\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>### Supabase Research Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Create `.claude/agents/supabase-researcher.md`:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>```markdown\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>name: supabase-researcher\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>description: Research Supabase database patterns and RLS policies\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>tools: Read, Glob, Grep, WebFetch, Write\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>model: haiku\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan># Supabase Research Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>You research Supabase patterns. Focus on RLS policies, auth, and performance.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>## Research Checklist\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- [ ] Existing table structure\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- [ ] Current RLS policies\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- [ ] Auth patterns in codebase\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- [ ] Client initialization\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- [ ] Error handling patterns\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>## Output Includes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- Schema changes needed (SQL)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- RLS policy definitions\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- TypeScript types to generate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>- Migration steps\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"when-this-fails\">When This Fails\u003C/h2>\n\u003Cp>This architecture isn’t magic. Here are the real limitations:\u003C/p>\n\u003Ch3 id=\"1-context-isolation-still-exists\">1. Context Isolation Still Exists\u003C/h3>\n\u003Cp>The researcher agent doesn’t have access to the parent’s conversation history. If critical information only exists in the parent’s memory, the researcher will miss it.\u003C/p>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Be explicit in context.md. Don’t assume the researcher “knows” anything.\u003C/p>\n\u003Cp>\u003Cstrong>Example Failure:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>Parent: \"Add error handling like we did for auth\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Researcher: ??? (doesn't know how auth error handling works)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Example Fix:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># context.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Error Handling Pattern\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">See src/auth/handler.ts lines 45-67 for our standard error handling pattern.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Use the same try/catch structure and error response format.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"2-research-can-be-wrong\">2. Research Can Be Wrong\u003C/h3>\n\u003Cp>Haiku is fast and cheap but makes mistakes on complex analysis. The researcher might miss edge cases or misunderstand requirements.\u003C/p>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Review the research report before implementing. Don’t blindly trust it.\u003C/p>\n\u003Cp>\u003Cstrong>Example Failure:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">recommendation\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  approach\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Use Stripe Charges API\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  confidence\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">high\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This is outdated. Payment Intents is the modern approach. A senior engineer would catch this.\u003C/p>\n\u003Ch3 id=\"3-overhead-on-simple-tasks\">3. Overhead on Simple Tasks\u003C/h3>\n\u003Cp>Creating context files, spawning agents, reading reports—this adds 30-60 seconds of overhead.\u003C/p>\n\u003Cp>\u003Cstrong>When to skip delegation:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Task takes &#x3C; 2 minutes to implement directly\u003C/li>\n\u003Cli>You already know exactly what to do\u003C/li>\n\u003Cli>No external research needed\u003C/li>\n\u003Cli>Single file change with obvious solution\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Numbers:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Simple task direct: 2 minutes\u003C/li>\n\u003Cli>Simple task with delegation: 3 minutes (50% overhead)\u003C/li>\n\u003Cli>Complex task direct: 30 minutes\u003C/li>\n\u003Cli>Complex task with delegation: 15 minutes (50% time saved)\u003C/li>\n\u003C/ul>\n\u003Cp>Delegation shines on complex, research-heavy tasks. It’s overkill for simple edits.\u003C/p>\n\u003Ch3 id=\"4-file-coordination-complexity\">4. File Coordination Complexity\u003C/h3>\n\u003Cp>Multiple sub-agents writing to files simultaneously can cause conflicts. If Agent A writes \u003Ccode>research-stripe.md\u003C/code> while Agent B tries to read it, race conditions occur.\u003C/p>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Use distinct file names with timestamps or task IDs.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Good\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">tmp/context-stripe-1703012400.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">tmp/research-stripe-1703012400.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Bad\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">tmp/context.md\u003C/span>\u003Cspan style=\"color:#6A737D\">  # Which task is this for?\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"5-debugging-gets-harder\">5. Debugging Gets Harder\u003C/h3>\n\u003Cp>When implementation fails, you now have three places to debug:\u003C/p>\n\u003Col>\n\u003Cli>The context file (was the request clear?)\u003C/li>\n\u003Cli>The research report (was the research correct?)\u003C/li>\n\u003Cli>The implementation (was the code correct?)\u003C/li>\n\u003C/ol>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Keep research reports. Don’t delete them. When debugging, check all three layers.\u003C/p>\n\u003Ch3 id=\"6-cost-on-failed-research\">6. Cost on Failed Research\u003C/h3>\n\u003Cp>If the researcher misunderstands the task and produces useless output, you’ve wasted:\u003C/p>\n\u003Cul>\n\u003Cli>Haiku API calls (cheap but not free)\u003C/li>\n\u003Cli>30-60 seconds of time\u003C/li>\n\u003Cli>Mental context switching\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Write very specific context files. Vague requests produce vague research.\u003C/p>\n\u003Cp>\u003Cstrong>Example Vague Request:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Research Needed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> How to add payments\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Example Specific Request:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Research Needed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Which Stripe API version should we use? (prefer latest stable)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Payment Intents vs Charges API - which for one-time purchases?\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> What webhook events do we need to handle for payment confirmation?\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> How to handle failed payments and retry logic?\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">5.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> What test mode setup is needed?\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>The specific version gets useful research. The vague version gets generic documentation summaries.\u003C/p>\n\u003Ch2 id=\"model-selection-strategy\">Model Selection Strategy\u003C/h2>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Task Type\u003C/th>\u003Cth>Model\u003C/th>\u003Cth>Cost/M\u003C/th>\u003Cth>Speed\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Simple routing\u003C/td>\u003Ctd>Haiku\u003C/td>\u003Ctd>$0.25\u003C/td>\u003Ctd>⚡⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Text extraction\u003C/td>\u003Ctd>Haiku\u003C/td>\u003Ctd>$0.25\u003C/td>\u003Ctd>⚡⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Classification\u003C/td>\u003Ctd>Haiku\u003C/td>\u003Ctd>$0.25\u003C/td>\u003Ctd>⚡⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Research (simple)\u003C/td>\u003Ctd>Haiku\u003C/td>\u003Ctd>$0.25\u003C/td>\u003Ctd>⚡⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Code review\u003C/td>\u003Ctd>Sonnet\u003C/td>\u003Ctd>$3\u003C/td>\u003Ctd>⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Implementation\u003C/td>\u003Ctd>Sonnet\u003C/td>\u003Ctd>$3\u003C/td>\u003Ctd>⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Analysis\u003C/td>\u003Ctd>Sonnet\u003C/td>\u003Ctd>$3\u003C/td>\u003Ctd>⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Research (complex)\u003C/td>\u003Ctd>Sonnet\u003C/td>\u003Ctd>$3\u003C/td>\u003Ctd>⚡⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Complex reasoning\u003C/td>\u003Ctd>Opus\u003C/td>\u003Ctd>$15\u003C/td>\u003Ctd>⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Architecture decisions\u003C/td>\u003Ctd>Opus\u003C/td>\u003Ctd>$15\u003C/td>\u003Ctd>⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Edge case handling\u003C/td>\u003Ctd>Opus\u003C/td>\u003Ctd>$15\u003C/td>\u003Ctd>⚡\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Research (critical)\u003C/td>\u003Ctd>Opus\u003C/td>\u003Ctd>$15\u003C/td>\u003Ctd>⚡\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cblockquote>\n\u003Cp>\u003Cstrong>Rule:\u003C/strong> Use the cheapest model that solves the problem. Most tasks are Haiku tasks. Don’t over-engineer.\u003C/p>\n\u003C/blockquote>\n\u003Cp>For researchers:\u003C/p>\n\u003Cul>\n\u003Cli>\u003Cstrong>Haiku:\u003C/strong> Documentation lookup, simple API pattern research, file structure analysis\u003C/li>\n\u003Cli>\u003Cstrong>Sonnet:\u003C/strong> Cross-service integration research, security pattern analysis, performance optimization research\u003C/li>\n\u003Cli>\u003Cstrong>Opus:\u003C/strong> Architecture decisions, critical production patterns, edge case exploration\u003C/li>\n\u003C/ul>\n\u003Cp>Start with Haiku. Upgrade only if the research is inadequate.\u003C/p>\n\u003Ch2 id=\"architecture-custom-agent-stack\">Architecture: Custom Agent Stack\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart TB\n    subgraph \"Custom Agent\"\n        SP[System Prompt]\n        UP[User Prompt]\n        T[Custom Tools]\n        M[Model Selection]\n    end\n\n    subgraph \"Execution\"\n        API[Claude API]\n        TE[Tool Execution]\n        R[Response]\n    end\n\n    SP --> API\n    UP --> API\n    T --> API\n    M --> API\n\n    API --> |tool_use| TE\n    TE --> |tool_result| API\n    API --> R\n\n    style SP fill:#ffccbc\n    style T fill:#c8e6c9\n    style R fill:#bbdefb\n\u003C/pre>\n\u003Cp>System prompts define what the agent does. Tools define how it does it. Model selection defines cost and quality. Context files enable delegation.\u003C/p>\n\u003Ch2 id=\"what-this-architecture-enables\">What This Architecture Enables\u003C/h2>\n\u003Cp>\u003Cstrong>Domain-specific logic\u003C/strong> — Operations the model can’t reason through reliably become deterministic tool calls.\u003C/p>\n\u003Cp>\u003Cstrong>Optimized context\u003C/strong> — Strip out the 12 tools you never use. Add the 3 you always need.\u003C/p>\n\u003Cp>\u003Cstrong>Specialized behavior\u003C/strong> — System prompts tuned for exactly your use cases.\u003C/p>\n\u003Cp>\u003Cstrong>Cost control\u003C/strong> — Haiku for simple tasks, Sonnet for complex ones. No over-engineering.\u003C/p>\n\u003Cp>\u003Cstrong>Team patterns\u003C/strong> — Shared agents that enforce your team’s conventions.\u003C/p>\n\u003Cp>\u003Cstrong>Parallel research\u003C/strong> — Multiple sub-agents researching different aspects simultaneously.\u003C/p>\n\u003Cp>\u003Cstrong>Persistent knowledge\u003C/strong> — Research reports accumulate in your project. Future work references past decisions.\u003C/p>\n\u003Cp>\u003Cstrong>Debuggable workflows\u003C/strong> — Always know what was planned and why. Three months later, \u003Ccode>git log\u003C/code> shows the research report that led to the implementation.\u003C/p>\n\u003Ch2 id=\"the-data-flow\">The Data Flow\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart TB\n    subgraph Parent[\"PARENT AGENT\"]\n        CH[Conversation History&#x3C;br/>compacts over time]\n        CH --> CTX[context.md&#x3C;br/>persists]\n    end\n\n    subgraph Sub[\"SUB-AGENT\"]\n        READ[Reads context.md]\n        RESEARCH[Does research]\n        REPORT[research-report.md&#x3C;br/>persists]\n        READ --> RESEARCH --> REPORT\n    end\n\n    CTX --> READ\n    REPORT --> RESULT\n\n    subgraph RESULT[Parent reads research-report.md]\n        R1[Full context available]\n        R2[Can implement correctly]\n        R3[Can debug if issues arise]\n    end\n\n    style CTX fill:#c8e6c9\n    style REPORT fill:#c8e6c9\n\u003C/pre>\n\u003Cp>Conversation history compacts. Files don’t. This is the key insight.\u003C/p>\n\u003Ch2 id=\"rules-that-prevent-disasters\">Rules That Prevent Disasters\u003C/h2>\n\u003Cp>Add these to your research agent definitions:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Mandatory Rules\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Always read context file first**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Never start work without understanding the context\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> If context file doesn't exist, stop and report error\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Never implement, only research**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Your job is to create the plan\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> The parent agent implements\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Never spawn sub-agents**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> One level of delegation maximum\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Prevents recursive loops and cost explosions\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Always write findings to file**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Summary in conversation: &#x3C; 100 words\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Full report in file: as detailed as needed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">5.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Update context file when done**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Add \"Last researched: [\u003C/span>\u003Cspan style=\"color:#DBEDFF;text-decoration:underline\">timestamp\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note any assumptions made\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>One level of delegation. Researcher agents never spawn their own sub-agents. This prevents:\u003C/p>\n\u003Cul>\n\u003Cli>Recursive delegation loops\u003C/li>\n\u003Cli>Cost explosions (agent spawns agent spawns agent…)\u003C/li>\n\u003Cli>Context fragmentation\u003C/li>\n\u003Cli>Debugging nightmares\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"quick-start-your-first-custom-agent\">Quick Start: Your First Custom Agent\u003C/h2>\n\u003Col>\n\u003Cli>Identify your most repetitive AI task\u003C/li>\n\u003Cli>Write a system prompt that focuses on that task\u003C/li>\n\u003Cli>Choose the cheapest model that works (probably Haiku)\u003C/li>\n\u003Cli>Add tools only if you need deterministic execution\u003C/li>\n\u003Cli>Test with edge cases\u003C/li>\n\u003Cli>Deploy and iterate\u003C/li>\n\u003C/ol>\n\u003Cp>For delegation:\u003C/p>\n\u003Col>\n\u003Cli>Create the context template (\u003Ccode>.claude/templates/context.md\u003C/code>)\u003C/li>\n\u003Cli>Create the researcher agent (\u003Ccode>.claude/agents/researcher.md\u003C/code>)\u003C/li>\n\u003Cli>Next time you need research, write a context file and spawn the agent\u003C/li>\n\u003Cli>Read the research report\u003C/li>\n\u003Cli>Implement based on the plan\u003C/li>\n\u003C/ol>\n\u003Cp>The endgame isn’t renting computational power from default agents. The endgame is owning specialized agents tuned precisely for your problems, with reliable delegation patterns that actually work.\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cstrong>Key Takeaways:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>System prompt = agent identity (same model, different prompt = different product)\u003C/li>\n\u003Cli>Tools provide deterministic execution when reasoning isn’t reliable\u003C/li>\n\u003Cli>Sub-agents research, parent agents implement (context isolation is real)\u003C/li>\n\u003Cli>File system is persistent memory between agent sessions (conversation history compacts, files don’t)\u003C/li>\n\u003Cli>Context files define what to research, research reports contain the full plan\u003C/li>\n\u003Cli>80% token reduction by returning file paths not content\u003C/li>\n\u003Cli>One level of delegation prevents recursive loops and cost explosions\u003C/li>\n\u003Cli>Match model to task complexity (Haiku → Sonnet → Opus, most tasks are Haiku tasks)\u003C/li>\n\u003Cli>Delegation overhead is 30-60 seconds (only worth it for complex tasks)\u003C/li>\n\u003Cli>Review research reports before implementing (Haiku makes mistakes on complex analysis)\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Try It Now:\u003C/strong>\nCreate \u003Ccode>.claude/agents/researcher.md\u003C/code> using the template above. Next time you need to research a new API integration or library, write a context file and delegate to the researcher. Read the report. Implement based on the plan. See if you save time.\u003C/p>",{"headings":104,"localImagePaths":181,"remoteImagePaths":182,"frontmatter":183,"imagePaths":187},[105,108,111,114,117,120,123,127,130,133,136,139,142,145,148,151,154,157,160,163,166,169,172,175,178],{"depth":44,"slug":106,"text":107},"why-custom-agents-matter","Why Custom Agents Matter",{"depth":44,"slug":109,"text":110},"poc-1-the-simplest-custom-agent","POC 1: The Simplest Custom Agent",{"depth":44,"slug":112,"text":113},"poc-2-agent-with-custom-tools","POC 2: Agent with Custom Tools",{"depth":44,"slug":115,"text":116},"the-key-pattern-sub-agents-as-researchers","The Key Pattern: Sub-Agents as Researchers",{"depth":44,"slug":118,"text":119},"file-based-context-the-solution","File-Based Context: The Solution",{"depth":44,"slug":121,"text":122},"poc-3-complete-file-based-context-system","POC 3: Complete File-Based Context System",{"depth":124,"slug":125,"text":126},3,"step-1-context-file-template","Step 1: Context File Template",{"depth":124,"slug":128,"text":129},"step-2-research-agent-definition","Step 2: Research Agent Definition",{"depth":124,"slug":131,"text":132},"step-3-implementation-flow","Step 3: Implementation Flow",{"depth":124,"slug":134,"text":135},"step-4-putting-it-together","Step 4: Putting It Together",{"depth":44,"slug":137,"text":138},"poc-4-service-specific-researchers","POC 4: Service-Specific Researchers",{"depth":124,"slug":140,"text":141},"stripe-research-agent","Stripe Research Agent",{"depth":44,"slug":143,"text":144},"when-this-fails","When This Fails",{"depth":124,"slug":146,"text":147},"1-context-isolation-still-exists","1. Context Isolation Still Exists",{"depth":124,"slug":149,"text":150},"2-research-can-be-wrong","2. Research Can Be Wrong",{"depth":124,"slug":152,"text":153},"3-overhead-on-simple-tasks","3. Overhead on Simple Tasks",{"depth":124,"slug":155,"text":156},"4-file-coordination-complexity","4. File Coordination Complexity",{"depth":124,"slug":158,"text":159},"5-debugging-gets-harder","5. Debugging Gets Harder",{"depth":124,"slug":161,"text":162},"6-cost-on-failed-research","6. Cost on Failed Research",{"depth":44,"slug":164,"text":165},"model-selection-strategy","Model Selection Strategy",{"depth":44,"slug":167,"text":168},"architecture-custom-agent-stack","Architecture: Custom Agent Stack",{"depth":44,"slug":170,"text":171},"what-this-architecture-enables","What This Architecture Enables",{"depth":44,"slug":173,"text":174},"the-data-flow","The Data Flow",{"depth":44,"slug":176,"text":177},"rules-that-prevent-disasters","Rules That Prevent Disasters",{"depth":44,"slug":179,"text":180},"quick-start-your-first-custom-agent","Quick Start: Your First Custom Agent",[],[],{"title":79,"description":80,"pubDate":184,"author":17,"tags":185,"banner":87,"category":96,"difficulty":97,"tldr":89,"keyTakeaways":186},["Date","2025-12-15T00:00:00.000Z"],[19,83,21,84,85,86],[91,92,93,94,95],[],"agent-architecture.md","context-engineering",{"id":189,"data":191,"body":210,"filePath":211,"digest":212,"rendered":213,"legacyId":281},{"title":192,"description":193,"pubDate":194,"author":17,"tags":195,"draft":24,"banner":200,"seoKeywords":201,"tldr":202,"keyTakeaways":203,"category":209,"difficulty":97},"Context Engineering: From Token Optimization to Large Codebase Mastery","Progressive disclosure and semantic search: the difference between burning tokens and shipping features. Working code and hard numbers inside.",["Date","2025-12-15T00:00:00.000Z"],[19,196,197,198,199],"context-window","mcp","semantic-search","optimization","/assets/posts/context-engineering-banner.png",[],"Context is your budget—every token loaded is a tax on productivity. Progressive disclosure reduces context consumption by 94% by loading tools only when needed. For large codebases (55K+ files), semantic search with tools like Serena MCP provides 36x performance improvements over naive approaches.",[204,205,206,207,208],"MCP servers can consume 20% of your context before work begins—if tools consume >15%, you have an architecture problem","Progressive disclosure with UV scripts reduces context from 40,000 to 2,500 tokens (94% reduction)","Semantic search outperforms ripgrep at scale: 36x faster search, 28x faster symbol navigation, 23x faster references","Real cost savings: $2.40 per 100 queries with semantic search vs $86.40 with full context loading","The 15% rule: if upfront context consumption exceeds 15%, refactor to progressive disclosure","Context Engineering","Context is finite. Every token your agent loads before it starts working is a tax on productivity.\n\nThis post shows you how to engineer context consumption—from basic token optimization with progressive disclosure, to large codebase mastery with semantic search. Working code, hard numbers, honest failure modes included.\n\n## The Core Problem: Context is Precious\n\nYour context window is your budget. MCP servers spend it like a trust fund kid.\n\n```mermaid\nflowchart TD\n    A([Agent starts]) --> B[Load ALL tools\u003Cbr/>from ALL MCPs]\n    B --> |10,000 tokens\u003Cbr/>per MCP server| C[40,000 tokens consumed]\n    C --> |20% of context GONE\u003Cbr/>before any work starts| D([Agent begins work\u003Cbr/>with 80% remaining])\n\n    style C fill:#ffcdd2\n```\n\nFour MCP servers at 10,000 tokens each = 40,000 tokens consumed before you type a single character.\n\nIf tools consume more than 15% of your context, you have an architecture problem.\n\n## Pattern 1: Progressive Disclosure\n\nProgressive disclosure loads tools only when needed. Instead of front-loading everything, give your agent an index of what exists—and let it load only what it uses.\n\n```mermaid\nflowchart TD\n    A([Agent starts]) --> B[Load PRIME only\u003Cbr/>index of tools]\n    B --> |~500 tokens| C{Agent needs\u003Cbr/>market data?}\n    C --> |Yes| D[Load ONLY\u003Cbr/>market_search.py]\n    D --> |2,000 tokens| E([Agent continues\u003Cbr/>with 98% context remaining])\n\n    style B fill:#c8e6c9\n    style E fill:#c8e6c9\n```\n\nResult: 2,500 tokens instead of 40,000. 94% reduction.\n\n### Implementation: Tool Index + UV Scripts\n\nCreate a tool index as a simple markdown file:\n\n**`~/tools/README.md`**\n```markdown\n# Available Tools\n\nYou have access to the following tool scripts. **Do not read script contents unless --help doesn't provide enough information.**\n\n## Market Tools\nLocated in: `~/tools/market/`\n- `search.py` - Search prediction markets by keyword\n- `get_market.py` - Get details for specific market ID\n- `get_orderbook.py` - Get current orderbook for market\n\n## Data Tools\nLocated in: `~/tools/data/`\n- `fetch_csv.py` - Download CSV from URL\n- `analyze_csv.py` - Basic statistical analysis\n- `transform_csv.py` - Transform/filter CSV data\n\n## When you need a tool:\n1. Run `uv run ~/tools/{category}/{script}.py --help`\n2. Read the help output to understand usage\n3. Run the tool with appropriate arguments\n4. Only read script source if help is insufficient\n```\n\nThis index costs ~200 tokens. The agent knows WHERE tools are without loading them.\n\nEach tool is a UV single-file script with embedded dependencies:\n\n**`~/tools/market/search.py`**\n```python\n#!/usr/bin/env -S uv run\n# /// script\n# dependencies = [\n#   \"requests>=2.31.0\",\n#   \"rich>=13.0.0\",\n# ]\n# ///\n\"\"\"\nSearch prediction markets by keyword.\n\nUsage:\n    uv run search.py --query \"election\" [--limit 10]\n\nArguments:\n    --query, -q    Search term (required)\n    --limit, -l    Max results (default: 10)\n    --format, -f   Output format: json|table (default: table)\n\"\"\"\n\nimport argparse\nimport json\nimport requests\nfrom rich.console import Console\nfrom rich.table import Table\n\nKALSHI_API = \"https://trading-api.kalshi.com/trade-api/v2\"\n\ndef search_markets(query: str, limit: int = 10) -> list:\n    \"\"\"Search Kalshi markets by keyword.\"\"\"\n    response = requests.get(\n        f\"{KALSHI_API}/markets\",\n        params={\"status\": \"open\", \"limit\": limit},\n        headers={\"Accept\": \"application/json\"}\n    )\n    response.raise_for_status()\n\n    markets = response.json().get(\"markets\", [])\n    # Filter by query in title\n    return [m for m in markets if query.lower() in m.get(\"title\", \"\").lower()][:limit]\n\ndef main():\n    parser = argparse.ArgumentParser(description=\"Search prediction markets\")\n    parser.add_argument(\"-q\", \"--query\", required=True, help=\"Search term\")\n    parser.add_argument(\"-l\", \"--limit\", type=int, default=10, help=\"Max results\")\n    parser.add_argument(\"-f\", \"--format\", choices=[\"json\", \"table\"], default=\"table\")\n\n    args = parser.parse_args()\n\n    markets = search_markets(args.query, args.limit)\n\n    if args.format == \"json\":\n        print(json.dumps(markets, indent=2))\n    else:\n        console = Console()\n        table = Table(title=f\"Markets matching '{args.query}'\")\n        table.add_column(\"ID\", style=\"cyan\")\n        table.add_column(\"Title\", style=\"green\")\n        table.add_column(\"Volume\", justify=\"right\")\n\n        for m in markets:\n            table.add_row(\n                m.get(\"ticker\", \"\"),\n                m.get(\"title\", \"\")[:50],\n                str(m.get(\"volume\", 0))\n            )\n\n        console.print(table)\n\nif __name__ == \"__main__\":\n    main()\n```\n\n### The Flow in Practice\n\n```\nUser: \"What's the current price on election markets?\"\n\nAgent:\n1. Reads ~/tools/README.md (200 tokens)\n2. Sees market/search.py exists\n3. Runs: uv run ~/tools/market/search.py --help (500 tokens)\n4. Learns usage from help output\n5. Runs: uv run ~/tools/market/search.py -q \"election\"\n6. Returns results\n\nTotal context: ~2,700 tokens\nMCP equivalent: ~10,000 tokens\n```\n\n### Progressive Disclosure Numbers\n\n| Approach | Initial Load | Per-Tool Cost | 4 Tools Used |\n|----------|-------------|---------------|--------------|\n| MCP Server | 10,000 tokens | 0 (pre-loaded) | 10,000 |\n| Progressive | 200 tokens | 500-2,000 | 2,200-8,200 |\n\nProgressive disclosure wins when you use fewer than all available tools—which is almost always. Most tasks use 2-3 tools out of 20 available.\n\n## Pattern 2: Semantic Search for Large Codebases\n\nProgressive disclosure optimizes tool loading. But when you're working with large codebases, the problem isn't tool overhead—it's search strategy.\n\nBrute-force text search doesn't scale. Semantic search does.\n\n### Why Text Search Fails\n\n```mermaid\nflowchart TD\n    TASK[\"Task: Rename UserService → UserManager\"]\n    TASK --> S1\n\n    subgraph S1[\"Step 1: grep -r\"]\n        G1[847 matches across 312 files]\n        G2[Includes comments, strings, similar names]\n        G3[15,000 tokens consumed]\n    end\n\n    S1 --> S2\n    subgraph S2[\"Step 2: Read files\"]\n        R1[Agent reads each file]\n        R2[Looking for actual type usage]\n        R3[More tokens consumed]\n    end\n\n    S2 --> S3\n    subgraph S3[\"Step 3: Make changes\"]\n        C1[Text replacement]\n        C2[Misses generic constraints]\n        C3[Misses reflection usage]\n    end\n\n    S3 --> S4\n    subgraph S4[\"Step 4: Build fails\"]\n        F1[Agent scans again]\n        F2[More tokens]\n        F3[Loop continues...]\n    end\n\n    S4 --> |Retry loop| S1\n    S4 --> RESULT[3 hours, 28M tokens, $14, still broken]\n\n    style RESULT fill:#ffcdd2\n```\n\nThe build-fail-retry cycle is the productivity bottleneck. Text search guarantees you'll hit it.\n\n### How Semantic Search Works\n\n```mermaid\nflowchart TD\n    TASK[\"Task: Rename UserService → UserManager\"]\n    TASK --> S1\n\n    subgraph S1[\"Step 1: find_symbol\"]\n        F1[\"find_symbol('UserService', type='class')\"]\n        F2[Semantic understanding of code structure]\n        F3[Returns: definition location, all usages]\n        F4[500 tokens consumed]\n    end\n\n    S1 --> S2\n    subgraph S2[\"Step 2: rename_symbol\"]\n        R1[\"rename_symbol('UserService', 'UserManager')\"]\n        R2[Uses compiler's refactoring engine]\n        R3[Handles generics, reflection, inheritance]\n    end\n\n    S2 --> S3\n    subgraph S3[\"Step 3: Done\"]\n        D1[Build passes first try]\n        D2[5 minutes total]\n    end\n\n    S3 --> RESULT[5 minutes, 1M tokens, $0.60, works]\n\n    style RESULT fill:#c8e6c9\n```\n\nThe key difference:\n- Text search: \"Find this string anywhere\"\n- Semantic search: \"Find this symbol in the AST\"\n\nSemantic search understands code structure. It knows the difference between a type name, a string literal that happens to contain that text, and a comment mentioning it.\n\n### Setting Up Serena MCP\n\nSerena provides semantic search for multiple languages (TypeScript, JavaScript, Python, Go, Rust).\n\n**Installation:**\n\n```bash\n# Clone the repository\ngit clone https://github.com/oramasearch/serena.git\ncd serena\n\n# Install dependencies\nnpm install\n\n# Build the project\nnpm run build\n```\n\n**Configuration for Claude Code:**\n\nAdd to `~/.claude/mcp.json`:\n\n```json\n{\n  \"mcpServers\": {\n    \"serena\": {\n      \"command\": \"node\",\n      \"args\": [\"/absolute/path/to/serena/dist/index.js\"],\n      \"env\": {\n        \"PROJECT_ROOT\": \".\"\n      }\n    }\n  }\n}\n```\n\n**Available tools:**\n\n| Tool | Description |\n|------|-------------|\n| `find_symbol` | Find symbol definition and all usages |\n| `find_references` | Find all references to a symbol |\n| `get_definition` | Get the definition of a symbol at a location |\n| `semantic_search` | Search code semantically, not just text |\n| `get_file_symbols` | List all symbols in a file |\n\n### Adding Language-Specific Refactoring\n\nFor C#/.NET, add Refactor MCP for Roslyn-powered operations:\n\n```bash\n# Clone the repository\ngit clone https://github.com/JetBrains/refactor-mcp.git\ncd refactor-mcp\n\n# Build\ndotnet build\n```\n\nAdd to MCP config:\n\n```json\n{\n  \"mcpServers\": {\n    \"refactor\": {\n      \"command\": \"dotnet\",\n      \"args\": [\"run\", \"--project\", \"/path/to/refactor-mcp\"],\n      \"env\": {\n        \"SOLUTION_PATH\": \"/path/to/your/solution.sln\"\n      }\n    }\n  }\n}\n```\n\n**Available refactoring operations:**\n\n| Tool | Description |\n|------|-------------|\n| `rename_symbol` | Rename with full semantic awareness |\n| `extract_method` | Extract code into a new method |\n| `inline_method` | Inline a method at call sites |\n| `extract_interface` | Create interface from class |\n| `move_type` | Move type to another file/namespace |\n\n### The Numbers: 55,000 File Codebase\n\nReal measurements from a production codebase:\n\n| Metric | Text Search | Semantic Search | Improvement |\n|--------|-------------|-----------------|-------------|\n| Time | 3 hours | 5 minutes | 36x |\n| Tokens | 28M | 1M | 28x |\n| Cost | $14 | $0.60 | 23x |\n| Human intervention | Constant | None | ∞ |\n| Build failures | 4 | 0 | - |\n\nThe cost of NOT having semantic tools scales with codebase size. A 10x larger codebase isn't 10x worse—it's 100x worse with text search.\n\n### Workflow Comparison\n\n**Without semantic tools (3 hours):**\n\n```\nUser: \"Rename UserService to UserManager across the codebase\"\n\nAgent:\n1. grep -r \"UserService\" . → 847 results\n2. Read 312 files → 28M tokens consumed\n3. Text-replace in each file\n4. Build fails (missed generic constraints)\n5. grep again for the error\n6. Fix, rebuild\n7. Build fails (missed reflection usage)\n8. Loop continues...\n\nResult: 3 hours, multiple human interventions, $14\n```\n\n**With semantic tools (5 minutes):**\n\n```\nUser: \"Rename UserService to UserManager across the codebase\"\n\nAgent:\n1. find_symbol(\"UserService\") → 42 actual usages\n2. rename_symbol(\"UserService\", \"UserManager\")\n3. Build passes\n\nResult: 5 minutes, autonomous, $0.60\n```\n\n## When This Fails: Honest Limitations\n\nBoth patterns have failure modes. Here's what doesn't work.\n\n### Progressive Disclosure Failures\n\n**Setup overhead becomes the bottleneck:**\n- If you're prototyping and need 15 different tools quickly, progressive disclosure adds friction\n- Writing UV scripts and maintaining a tool index takes time\n- For one-off tasks, the setup cost exceeds the savings\n\n**Language and dependency constraints:**\n- UV is Python-focused; other languages need different patterns\n- Binary tools require wrapper scripts\n- Complex authentication flows are harder to embed in single files\n\n**When tool reuse is low:**\n- If every task needs a new custom script, you're not saving context\n- The index becomes noise if most tools are one-time use\n\n### Semantic Search Failures\n\n**Initial indexing cost:**\n- First run on a large codebase can take minutes to hours\n- Index storage can be GBs for very large projects\n- Re-indexing after major refactors adds overhead\n\n**Language support gaps:**\n- Not all languages have mature semantic tooling\n- Dynamic languages (Ruby, PHP) have weaker semantic analysis\n- Mixed codebases (Python + JavaScript + Go) need multiple MCP servers\n\n**False confidence in refactoring:**\n- Semantic tools can't catch runtime-only issues\n- Reflection-heavy code may still break\n- Cross-service boundaries aren't tracked\n\n**Setup complexity:**\n- Requires building/installing language-specific servers\n- Configuration mistakes lead to silent failures\n- Version mismatches between tools and target code\n\n**Cost isn't always lower:**\n- For small codebases (\u003C 100 files), text search is faster\n- For simple string replacements, grep is sufficient\n- If you only search once, indexing overhead dominates\n\n## Decision Framework: When to Use Which Pattern\n\n```mermaid\nflowchart LR\n    subgraph MCP[\"Standard MCP (80%)\"]\n        M1[External APIs]\n        M2[Vendor tools]\n        M3[Quick prototyping]\n        M4[\"Small codebases (\u003C 100 files)\"]\n    end\n\n    subgraph PD[\"Progressive Disclosure (15%)\"]\n        P1[Custom internal tools]\n        P2[Team-wide utilities]\n        P3[Long-running sessions]\n        P4[Precise token control]\n    end\n\n    subgraph SS[\"Semantic Search (5%)\"]\n        S1[\"Large codebases (> 1,000 files)\"]\n        S2[Type/symbol renaming]\n        S3[Complex type usages]\n        S4[Build-fail-retry cycles]\n    end\n\n    subgraph COMBO[\"Combine Progressive + Semantic\"]\n        C1[Load semantic MCP only when refactoring]\n        C2[Keep tool index lightweight]\n        C3[Semantic for code, progressive for APIs]\n    end\n\n    style MCP fill:#e3f2fd\n    style PD fill:#fff3e0\n    style SS fill:#fce4ec\n    style COMBO fill:#e8f5e9\n```\n\n### The Selection Test\n\nAsk these questions:\n\n1. **How many files will be touched?**\n   - \u003C 10 files: Text search is fine\n   - 10-100 files: Text search with careful prompting\n   - 100-1,000 files: Consider semantic\n   - 1,000+ files: Semantic is required\n\n2. **How many tools will be used?**\n   - All of them: MCP upfront loading is fine\n   - Most of them: MCP is fine\n   - Some of them: Progressive disclosure wins\n   - Few of them: Progressive disclosure wins heavily\n\n3. **What's the task complexity?**\n   - String replacement: Text search works\n   - Symbol renaming: Semantic required\n   - Cross-file refactoring: Semantic required\n   - Type hierarchy changes: Semantic required\n\n4. **Is this a one-off or repeated work?**\n   - One-off: Setup cost dominates, use simple tools\n   - Repeated: Setup cost amortizes, invest in optimization\n\n## Key Takeaways\n\n- Context is finite; every pre-loaded token is a tax on productivity\n- Progressive disclosure reduces tool overhead by 90%+ when you don't use all tools\n- Semantic search provides 28x token reduction and 36x speed improvement on large codebases\n- Combine both: use progressive disclosure for tool loading, semantic search for code operations\n- Text search fails at scale due to build-fail-retry cycles\n- Setup overhead is real; optimize only when the math supports it\n- Most codebases (\u003C 100 files) don't need semantic tools\n- Tool sophistication matters more than raw model capability for large codebases\n\n## Try It Now\n\n**For progressive disclosure:**\nCreate `~/tools/README.md` with an index of 3 UV scripts. Point your agent at it instead of loading an MCP server. Track token consumption with `/context` in Claude Code.\n\n**For semantic search:**\nInstall Serena MCP. Run `find_symbol` on a type in your codebase. Compare the results and token usage to `grep -r`. If you're touching more than 100 files, measure the difference.\n\nThe best context engineering is invisible. Your agent just works faster, costs less, and fails less often.","src/content/blog/context-engineering.md","32a35e749ebd3956",{"html":214,"metadata":215},"\u003Cp>Context is finite. Every token your agent loads before it starts working is a tax on productivity.\u003C/p>\n\u003Cp>This post shows you how to engineer context consumption—from basic token optimization with progressive disclosure, to large codebase mastery with semantic search. Working code, hard numbers, honest failure modes included.\u003C/p>\n\u003Ch2 id=\"the-core-problem-context-is-precious\">The Core Problem: Context is Precious\u003C/h2>\n\u003Cp>Your context window is your budget. MCP servers spend it like a trust fund kid.\u003C/p>\n\u003Cpre class=\"mermaid\">flowchart TD\n    A([Agent starts]) --> B[Load ALL tools&#x3C;br/>from ALL MCPs]\n    B --> |10,000 tokens&#x3C;br/>per MCP server| C[40,000 tokens consumed]\n    C --> |20% of context GONE&#x3C;br/>before any work starts| D([Agent begins work&#x3C;br/>with 80% remaining])\n\n    style C fill:#ffcdd2\n\u003C/pre>\n\u003Cp>Four MCP servers at 10,000 tokens each = 40,000 tokens consumed before you type a single character.\u003C/p>\n\u003Cp>If tools consume more than 15% of your context, you have an architecture problem.\u003C/p>\n\u003Ch2 id=\"pattern-1-progressive-disclosure\">Pattern 1: Progressive Disclosure\u003C/h2>\n\u003Cp>Progressive disclosure loads tools only when needed. Instead of front-loading everything, give your agent an index of what exists—and let it load only what it uses.\u003C/p>\n\u003Cpre class=\"mermaid\">flowchart TD\n    A([Agent starts]) --> B[Load PRIME only&#x3C;br/>index of tools]\n    B --> |~500 tokens| C{Agent needs&#x3C;br/>market data?}\n    C --> |Yes| D[Load ONLY&#x3C;br/>market_search.py]\n    D --> |2,000 tokens| E([Agent continues&#x3C;br/>with 98% context remaining])\n\n    style B fill:#c8e6c9\n    style E fill:#c8e6c9\n\u003C/pre>\n\u003Cp>Result: 2,500 tokens instead of 40,000. 94% reduction.\u003C/p>\n\u003Ch3 id=\"implementation-tool-index--uv-scripts\">Implementation: Tool Index + UV Scripts\u003C/h3>\n\u003Cp>Create a tool index as a simple markdown file:\u003C/p>\n\u003Cp>\u003Cstrong>\u003Ccode>~/tools/README.md\u003C/code>\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Available Tools\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">You have access to the following tool scripts. \u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\">**Do not read script contents unless --help doesn't provide enough information.**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Market Tools\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Located in: \u003C/span>\u003Cspan style=\"color:#79B8FF\">`~/tools/market/`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> `search.py`\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> - Search prediction markets by keyword\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> `get_market.py`\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> - Get details for specific market ID\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> `get_orderbook.py`\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> - Get current orderbook for market\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Data Tools\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Located in: \u003C/span>\u003Cspan style=\"color:#79B8FF\">`~/tools/data/`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> `fetch_csv.py`\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> - Download CSV from URL\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> `analyze_csv.py`\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> - Basic statistical analysis\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> `transform_csv.py`\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> - Transform/filter CSV data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## When you need a tool:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Run \u003C/span>\u003Cspan style=\"color:#79B8FF\">`uv run ~/tools/{category}/{script}.py --help`\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Read the help output to understand usage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Run the tool with appropriate arguments\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Only read script source if help is insufficient\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This index costs ~200 tokens. The agent knows WHERE tools are without loading them.\u003C/p>\n\u003Cp>Each tool is a UV single-file script with embedded dependencies:\u003C/p>\n\u003Cp>\u003Cstrong>\u003Ccode>~/tools/market/search.py\u003C/code>\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#!/usr/bin/env -S uv run\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># /// script\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># dependencies = [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"requests>=2.31.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"rich>=13.0.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ///\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Search prediction markets by keyword.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Usage:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    uv run search.py --query \"election\" [--limit 10]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Arguments:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    --query, -q    Search term (required)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    --limit, -l    Max results (default: 10)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    --format, -f   Output format: json|table (default: table)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> argparse\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rich.console \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Console\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rich.table \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Table\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">KALSHI_API\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"https://trading-api.kalshi.com/trade-api/v2\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> search_markets\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(query: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, limit: \u003C/span>\u003Cspan style=\"color:#79B8FF\">int\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">list\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"Search Kalshi markets by keyword.\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.get(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{KALSHI_API}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">/markets\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        params\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"status\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"open\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"limit\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: limit},\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        headers\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Accept\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"application/json\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    response.raise_for_status()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    markets \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.json().get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"markets\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, [])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Filter by query in title\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [m \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> m \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> markets \u003C/span>\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> query.lower() \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> m.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"title\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).lower()][:limit]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> main\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> argparse.ArgumentParser(\u003C/span>\u003Cspan style=\"color:#FFAB70\">description\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Search prediction markets\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser.add_argument(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"-q\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--query\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">required\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">help\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Search term\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser.add_argument(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"-l\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--limit\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">type\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">default\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">help\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Max results\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser.add_argument(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"-f\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--format\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">choices\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"json\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"table\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">], \u003C/span>\u003Cspan style=\"color:#FFAB70\">default\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"table\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    args \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> parser.parse_args()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    markets \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> search_markets(args.query, args.limit)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> args.format \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"json\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(json.dumps(markets, \u003C/span>\u003Cspan style=\"color:#FFAB70\">indent\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Console()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        table \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Table(\u003C/span>\u003Cspan style=\"color:#FFAB70\">title\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Markets matching '\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">args.query\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        table.add_column(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ID\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">style\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"cyan\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        table.add_column(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Title\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">style\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"green\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        table.add_column(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Volume\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">justify\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"right\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> m \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> markets:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            table.add_row(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                m.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ticker\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                m.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"title\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)[:\u003C/span>\u003Cspan style=\"color:#79B8FF\">50\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">                str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(m.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"volume\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(table)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __name__\u003C/span>\u003Cspan style=\"color:#F97583\"> ==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"__main__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    main()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"the-flow-in-practice\">The Flow in Practice\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>User: \"What's the current price on election markets?\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Agent:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>1. Reads ~/tools/README.md (200 tokens)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>2. Sees market/search.py exists\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>3. Runs: uv run ~/tools/market/search.py --help (500 tokens)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>4. Learns usage from help output\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5. Runs: uv run ~/tools/market/search.py -q \"election\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>6. Returns results\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Total context: ~2,700 tokens\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>MCP equivalent: ~10,000 tokens\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"progressive-disclosure-numbers\">Progressive Disclosure Numbers\u003C/h3>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Approach\u003C/th>\u003Cth>Initial Load\u003C/th>\u003Cth>Per-Tool Cost\u003C/th>\u003Cth>4 Tools Used\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>MCP Server\u003C/td>\u003Ctd>10,000 tokens\u003C/td>\u003Ctd>0 (pre-loaded)\u003C/td>\u003Ctd>10,000\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Progressive\u003C/td>\u003Ctd>200 tokens\u003C/td>\u003Ctd>500-2,000\u003C/td>\u003Ctd>2,200-8,200\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>Progressive disclosure wins when you use fewer than all available tools—which is almost always. Most tasks use 2-3 tools out of 20 available.\u003C/p>\n\u003Ch2 id=\"pattern-2-semantic-search-for-large-codebases\">Pattern 2: Semantic Search for Large Codebases\u003C/h2>\n\u003Cp>Progressive disclosure optimizes tool loading. But when you’re working with large codebases, the problem isn’t tool overhead—it’s search strategy.\u003C/p>\n\u003Cp>Brute-force text search doesn’t scale. Semantic search does.\u003C/p>\n\u003Ch3 id=\"why-text-search-fails\">Why Text Search Fails\u003C/h3>\n\u003Cpre class=\"mermaid\">flowchart TD\n    TASK[\"Task: Rename UserService → UserManager\"]\n    TASK --> S1\n\n    subgraph S1[\"Step 1: grep -r\"]\n        G1[847 matches across 312 files]\n        G2[Includes comments, strings, similar names]\n        G3[15,000 tokens consumed]\n    end\n\n    S1 --> S2\n    subgraph S2[\"Step 2: Read files\"]\n        R1[Agent reads each file]\n        R2[Looking for actual type usage]\n        R3[More tokens consumed]\n    end\n\n    S2 --> S3\n    subgraph S3[\"Step 3: Make changes\"]\n        C1[Text replacement]\n        C2[Misses generic constraints]\n        C3[Misses reflection usage]\n    end\n\n    S3 --> S4\n    subgraph S4[\"Step 4: Build fails\"]\n        F1[Agent scans again]\n        F2[More tokens]\n        F3[Loop continues...]\n    end\n\n    S4 --> |Retry loop| S1\n    S4 --> RESULT[3 hours, 28M tokens, $14, still broken]\n\n    style RESULT fill:#ffcdd2\n\u003C/pre>\n\u003Cp>The build-fail-retry cycle is the productivity bottleneck. Text search guarantees you’ll hit it.\u003C/p>\n\u003Ch3 id=\"how-semantic-search-works\">How Semantic Search Works\u003C/h3>\n\u003Cpre class=\"mermaid\">flowchart TD\n    TASK[\"Task: Rename UserService → UserManager\"]\n    TASK --> S1\n\n    subgraph S1[\"Step 1: find_symbol\"]\n        F1[\"find_symbol('UserService', type='class')\"]\n        F2[Semantic understanding of code structure]\n        F3[Returns: definition location, all usages]\n        F4[500 tokens consumed]\n    end\n\n    S1 --> S2\n    subgraph S2[\"Step 2: rename_symbol\"]\n        R1[\"rename_symbol('UserService', 'UserManager')\"]\n        R2[Uses compiler's refactoring engine]\n        R3[Handles generics, reflection, inheritance]\n    end\n\n    S2 --> S3\n    subgraph S3[\"Step 3: Done\"]\n        D1[Build passes first try]\n        D2[5 minutes total]\n    end\n\n    S3 --> RESULT[5 minutes, 1M tokens, $0.60, works]\n\n    style RESULT fill:#c8e6c9\n\u003C/pre>\n\u003Cp>The key difference:\u003C/p>\n\u003Cul>\n\u003Cli>Text search: “Find this string anywhere”\u003C/li>\n\u003Cli>Semantic search: “Find this symbol in the AST”\u003C/li>\n\u003C/ul>\n\u003Cp>Semantic search understands code structure. It knows the difference between a type name, a string literal that happens to contain that text, and a comment mentioning it.\u003C/p>\n\u003Ch3 id=\"setting-up-serena-mcp\">Setting Up Serena MCP\u003C/h3>\n\u003Cp>Serena provides semantic search for multiple languages (TypeScript, JavaScript, Python, Go, Rust).\u003C/p>\n\u003Cp>\u003Cstrong>Installation:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Clone the repository\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">git\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> clone\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> https://github.com/oramasearch/serena.git\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">cd\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> serena\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Install dependencies\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">npm\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> install\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Build the project\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">npm\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> build\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Configuration for Claude Code:\u003C/strong>\u003C/p>\n\u003Cp>Add to \u003Ccode>~/.claude/mcp.json\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"mcpServers\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"serena\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"command\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"node\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"args\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"/absolute/path/to/serena/dist/index.js\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"env\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        \"PROJECT_ROOT\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\".\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Available tools:\u003C/strong>\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Tool\u003C/th>\u003Cth>Description\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>\u003Ccode>find_symbol\u003C/code>\u003C/td>\u003Ctd>Find symbol definition and all usages\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>find_references\u003C/code>\u003C/td>\u003Ctd>Find all references to a symbol\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>get_definition\u003C/code>\u003C/td>\u003Ctd>Get the definition of a symbol at a location\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>semantic_search\u003C/code>\u003C/td>\u003Ctd>Search code semantically, not just text\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>get_file_symbols\u003C/code>\u003C/td>\u003Ctd>List all symbols in a file\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Ch3 id=\"adding-language-specific-refactoring\">Adding Language-Specific Refactoring\u003C/h3>\n\u003Cp>For C#/.NET, add Refactor MCP for Roslyn-powered operations:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Clone the repository\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">git\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> clone\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> https://github.com/JetBrains/refactor-mcp.git\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">cd\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> refactor-mcp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Build\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">dotnet\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> build\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Add to MCP config:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"mcpServers\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"refactor\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"command\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"dotnet\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"args\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"run\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--project\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"/path/to/refactor-mcp\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"env\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        \"SOLUTION_PATH\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"/path/to/your/solution.sln\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Available refactoring operations:\u003C/strong>\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Tool\u003C/th>\u003Cth>Description\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>\u003Ccode>rename_symbol\u003C/code>\u003C/td>\u003Ctd>Rename with full semantic awareness\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>extract_method\u003C/code>\u003C/td>\u003Ctd>Extract code into a new method\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>inline_method\u003C/code>\u003C/td>\u003Ctd>Inline a method at call sites\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>extract_interface\u003C/code>\u003C/td>\u003Ctd>Create interface from class\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Ccode>move_type\u003C/code>\u003C/td>\u003Ctd>Move type to another file/namespace\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Ch3 id=\"the-numbers-55000-file-codebase\">The Numbers: 55,000 File Codebase\u003C/h3>\n\u003Cp>Real measurements from a production codebase:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Metric\u003C/th>\u003Cth>Text Search\u003C/th>\u003Cth>Semantic Search\u003C/th>\u003Cth>Improvement\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Time\u003C/td>\u003Ctd>3 hours\u003C/td>\u003Ctd>5 minutes\u003C/td>\u003Ctd>36x\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Tokens\u003C/td>\u003Ctd>28M\u003C/td>\u003Ctd>1M\u003C/td>\u003Ctd>28x\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Cost\u003C/td>\u003Ctd>$14\u003C/td>\u003Ctd>$0.60\u003C/td>\u003Ctd>23x\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Human intervention\u003C/td>\u003Ctd>Constant\u003C/td>\u003Ctd>None\u003C/td>\u003Ctd>∞\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Build failures\u003C/td>\u003Ctd>4\u003C/td>\u003Ctd>0\u003C/td>\u003Ctd>-\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>The cost of NOT having semantic tools scales with codebase size. A 10x larger codebase isn’t 10x worse—it’s 100x worse with text search.\u003C/p>\n\u003Ch3 id=\"workflow-comparison\">Workflow Comparison\u003C/h3>\n\u003Cp>\u003Cstrong>Without semantic tools (3 hours):\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>User: \"Rename UserService to UserManager across the codebase\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Agent:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>1. grep -r \"UserService\" . → 847 results\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>2. Read 312 files → 28M tokens consumed\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>3. Text-replace in each file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>4. Build fails (missed generic constraints)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>5. grep again for the error\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>6. Fix, rebuild\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>7. Build fails (missed reflection usage)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>8. Loop continues...\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Result: 3 hours, multiple human interventions, $14\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>With semantic tools (5 minutes):\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>User: \"Rename UserService to UserManager across the codebase\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Agent:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>1. find_symbol(\"UserService\") → 42 actual usages\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>2. rename_symbol(\"UserService\", \"UserManager\")\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>3. Build passes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Result: 5 minutes, autonomous, $0.60\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"when-this-fails-honest-limitations\">When This Fails: Honest Limitations\u003C/h2>\n\u003Cp>Both patterns have failure modes. Here’s what doesn’t work.\u003C/p>\n\u003Ch3 id=\"progressive-disclosure-failures\">Progressive Disclosure Failures\u003C/h3>\n\u003Cp>\u003Cstrong>Setup overhead becomes the bottleneck:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>If you’re prototyping and need 15 different tools quickly, progressive disclosure adds friction\u003C/li>\n\u003Cli>Writing UV scripts and maintaining a tool index takes time\u003C/li>\n\u003Cli>For one-off tasks, the setup cost exceeds the savings\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Language and dependency constraints:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>UV is Python-focused; other languages need different patterns\u003C/li>\n\u003Cli>Binary tools require wrapper scripts\u003C/li>\n\u003Cli>Complex authentication flows are harder to embed in single files\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>When tool reuse is low:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>If every task needs a new custom script, you’re not saving context\u003C/li>\n\u003Cli>The index becomes noise if most tools are one-time use\u003C/li>\n\u003C/ul>\n\u003Ch3 id=\"semantic-search-failures\">Semantic Search Failures\u003C/h3>\n\u003Cp>\u003Cstrong>Initial indexing cost:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>First run on a large codebase can take minutes to hours\u003C/li>\n\u003Cli>Index storage can be GBs for very large projects\u003C/li>\n\u003Cli>Re-indexing after major refactors adds overhead\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Language support gaps:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Not all languages have mature semantic tooling\u003C/li>\n\u003Cli>Dynamic languages (Ruby, PHP) have weaker semantic analysis\u003C/li>\n\u003Cli>Mixed codebases (Python + JavaScript + Go) need multiple MCP servers\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>False confidence in refactoring:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Semantic tools can’t catch runtime-only issues\u003C/li>\n\u003Cli>Reflection-heavy code may still break\u003C/li>\n\u003Cli>Cross-service boundaries aren’t tracked\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Setup complexity:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Requires building/installing language-specific servers\u003C/li>\n\u003Cli>Configuration mistakes lead to silent failures\u003C/li>\n\u003Cli>Version mismatches between tools and target code\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Cost isn’t always lower:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>For small codebases (&#x3C; 100 files), text search is faster\u003C/li>\n\u003Cli>For simple string replacements, grep is sufficient\u003C/li>\n\u003Cli>If you only search once, indexing overhead dominates\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"decision-framework-when-to-use-which-pattern\">Decision Framework: When to Use Which Pattern\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart LR\n    subgraph MCP[\"Standard MCP (80%)\"]\n        M1[External APIs]\n        M2[Vendor tools]\n        M3[Quick prototyping]\n        M4[\"Small codebases (&#x3C; 100 files)\"]\n    end\n\n    subgraph PD[\"Progressive Disclosure (15%)\"]\n        P1[Custom internal tools]\n        P2[Team-wide utilities]\n        P3[Long-running sessions]\n        P4[Precise token control]\n    end\n\n    subgraph SS[\"Semantic Search (5%)\"]\n        S1[\"Large codebases (> 1,000 files)\"]\n        S2[Type/symbol renaming]\n        S3[Complex type usages]\n        S4[Build-fail-retry cycles]\n    end\n\n    subgraph COMBO[\"Combine Progressive + Semantic\"]\n        C1[Load semantic MCP only when refactoring]\n        C2[Keep tool index lightweight]\n        C3[Semantic for code, progressive for APIs]\n    end\n\n    style MCP fill:#e3f2fd\n    style PD fill:#fff3e0\n    style SS fill:#fce4ec\n    style COMBO fill:#e8f5e9\n\u003C/pre>\n\u003Ch3 id=\"the-selection-test\">The Selection Test\u003C/h3>\n\u003Cp>Ask these questions:\u003C/p>\n\u003Col>\n\u003Cli>\n\u003Cp>\u003Cstrong>How many files will be touched?\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>&#x3C; 10 files: Text search is fine\u003C/li>\n\u003Cli>10-100 files: Text search with careful prompting\u003C/li>\n\u003Cli>100-1,000 files: Consider semantic\u003C/li>\n\u003Cli>1,000+ files: Semantic is required\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>How many tools will be used?\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>All of them: MCP upfront loading is fine\u003C/li>\n\u003Cli>Most of them: MCP is fine\u003C/li>\n\u003Cli>Some of them: Progressive disclosure wins\u003C/li>\n\u003Cli>Few of them: Progressive disclosure wins heavily\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>What’s the task complexity?\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>String replacement: Text search works\u003C/li>\n\u003Cli>Symbol renaming: Semantic required\u003C/li>\n\u003Cli>Cross-file refactoring: Semantic required\u003C/li>\n\u003Cli>Type hierarchy changes: Semantic required\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003Cli>\n\u003Cp>\u003Cstrong>Is this a one-off or repeated work?\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>One-off: Setup cost dominates, use simple tools\u003C/li>\n\u003Cli>Repeated: Setup cost amortizes, invest in optimization\u003C/li>\n\u003C/ul>\n\u003C/li>\n\u003C/ol>\n\u003Ch2 id=\"key-takeaways\">Key Takeaways\u003C/h2>\n\u003Cul>\n\u003Cli>Context is finite; every pre-loaded token is a tax on productivity\u003C/li>\n\u003Cli>Progressive disclosure reduces tool overhead by 90%+ when you don’t use all tools\u003C/li>\n\u003Cli>Semantic search provides 28x token reduction and 36x speed improvement on large codebases\u003C/li>\n\u003Cli>Combine both: use progressive disclosure for tool loading, semantic search for code operations\u003C/li>\n\u003Cli>Text search fails at scale due to build-fail-retry cycles\u003C/li>\n\u003Cli>Setup overhead is real; optimize only when the math supports it\u003C/li>\n\u003Cli>Most codebases (&#x3C; 100 files) don’t need semantic tools\u003C/li>\n\u003Cli>Tool sophistication matters more than raw model capability for large codebases\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"try-it-now\">Try It Now\u003C/h2>\n\u003Cp>\u003Cstrong>For progressive disclosure:\u003C/strong>\nCreate \u003Ccode>~/tools/README.md\u003C/code> with an index of 3 UV scripts. Point your agent at it instead of loading an MCP server. Track token consumption with \u003Ccode>/context\u003C/code> in Claude Code.\u003C/p>\n\u003Cp>\u003Cstrong>For semantic search:\u003C/strong>\nInstall Serena MCP. Run \u003Ccode>find_symbol\u003C/code> on a type in your codebase. Compare the results and token usage to \u003Ccode>grep -r\u003C/code>. If you’re touching more than 100 files, measure the difference.\u003C/p>\n\u003Cp>The best context engineering is invisible. Your agent just works faster, costs less, and fails less often.\u003C/p>",{"headings":216,"localImagePaths":274,"remoteImagePaths":275,"frontmatter":276,"imagePaths":280},[217,220,223,226,229,232,235,238,241,244,247,250,253,256,259,262,265,268,271],{"depth":44,"slug":218,"text":219},"the-core-problem-context-is-precious","The Core Problem: Context is Precious",{"depth":44,"slug":221,"text":222},"pattern-1-progressive-disclosure","Pattern 1: Progressive Disclosure",{"depth":124,"slug":224,"text":225},"implementation-tool-index--uv-scripts","Implementation: Tool Index + UV Scripts",{"depth":124,"slug":227,"text":228},"the-flow-in-practice","The Flow in Practice",{"depth":124,"slug":230,"text":231},"progressive-disclosure-numbers","Progressive Disclosure Numbers",{"depth":44,"slug":233,"text":234},"pattern-2-semantic-search-for-large-codebases","Pattern 2: Semantic Search for Large Codebases",{"depth":124,"slug":236,"text":237},"why-text-search-fails","Why Text Search Fails",{"depth":124,"slug":239,"text":240},"how-semantic-search-works","How Semantic Search Works",{"depth":124,"slug":242,"text":243},"setting-up-serena-mcp","Setting Up Serena MCP",{"depth":124,"slug":245,"text":246},"adding-language-specific-refactoring","Adding Language-Specific Refactoring",{"depth":124,"slug":248,"text":249},"the-numbers-55000-file-codebase","The Numbers: 55,000 File Codebase",{"depth":124,"slug":251,"text":252},"workflow-comparison","Workflow Comparison",{"depth":44,"slug":254,"text":255},"when-this-fails-honest-limitations","When This Fails: Honest Limitations",{"depth":124,"slug":257,"text":258},"progressive-disclosure-failures","Progressive Disclosure Failures",{"depth":124,"slug":260,"text":261},"semantic-search-failures","Semantic Search Failures",{"depth":44,"slug":263,"text":264},"decision-framework-when-to-use-which-pattern","Decision Framework: When to Use Which Pattern",{"depth":124,"slug":266,"text":267},"the-selection-test","The Selection Test",{"depth":44,"slug":269,"text":270},"key-takeaways","Key Takeaways",{"depth":44,"slug":272,"text":273},"try-it-now","Try It Now",[],[],{"title":192,"description":193,"pubDate":277,"author":17,"tags":278,"banner":200,"category":209,"difficulty":97,"tldr":202,"keyTakeaways":279},["Date","2025-12-15T00:00:00.000Z"],[19,196,197,198,199],[204,205,206,207,208],[],"context-engineering.md","document-generation-skills",{"id":282,"data":284,"body":305,"filePath":306,"digest":307,"rendered":308,"legacyId":377},{"title":285,"description":286,"pubDate":287,"author":17,"tags":288,"draft":24,"banner":295,"seoKeywords":296,"tldr":297,"keyTakeaways":298,"category":304,"difficulty":35},"AI Document Skills: Automated File Generation That Actually Ships","Skills generate Excel, PowerPoint, and PDF files in minutes. Complete POC code, real token numbers, and honest failure modes for production.",["Date","2025-12-17T00:00:00.000Z"],[19,289,290,23,291,292,293,294],"claude","skills","document-generation","excel","powerpoint","pdf","/assets/posts/document-generation-skills-banner.png",[],"Claude Skills API automates Excel, PowerPoint, and PDF generation in 5-6 minutes instead of 100+ minutes of manual work. Chain skills together for complete document pipelines. Real production use saves 95% of effort with ~$2-3 token cost per run.",[299,300,301,302,303],"Document generation is unsexy but saves massive hours—100 minutes manual → 5 minutes automated","Skills API chains: Data → Excel → PowerPoint → PDF in a single pipeline","Token cost is minimal: ~$2-3 per complete document generation run","Failure modes: complex formatting, conditional logic, multi-sheet references","Human review is still required—5 minutes of review vs 100 minutes of creation","Production Patterns","Document generation is the unsexy automation that saves hours.\n\nNot code generation. Not chat interfaces. Document generation—the Excel reports, PowerPoint decks, and PDFs that every business runs on. Claude Skills turn this from hours of manual work into minutes of automated execution.\n\nThis is Part 1 of a series on AI document skills. We'll cover the core pattern, build a working POC, and measure what actually happens in production. Financial reporting is the example, but the pattern applies anywhere you need structured documents from data.\n\n## The Core Problem: Manual Documents Don't Scale\n\n```mermaid\nflowchart TD\n    A([Data arrives]) --> B[Analyst opens\u003Cbr/>Excel template]\n    B --> |10 minutes| C[Copy-paste data\u003Cbr/>Update formulas\u003Cbr/>Fix formatting]\n    C --> |30 minutes| D[Create PowerPoint\u003Cbr/>Summarize insights\u003Cbr/>Make it pretty]\n    D --> |45 minutes| E[Generate PDF\u003Cbr/>Final review]\n    E --> |15 minutes| F[Total: 100 minutes]\n\n    F --> G[\"Quarterly = 6+ hours/year\"]\n    G --> H[\"With 10 analysts = 60+ hours/year\"]\n\n    style F fill:#ffcdd2\n    style H fill:#ffcdd2\n```\n\nThis is busy work. Highly paid knowledge workers doing copy-paste operations.\n\n## The Pattern: Skills API Document Pipeline\n\n```mermaid\nflowchart TD\n    A([Data arrives]) --> B[\"Skills API Call\u003Cbr/>'Generate Excel with this data'\"]\n    B --> |1-2 min| C[Claude generates\u003Cbr/>Excel with formulas,\u003Cbr/>charts, formatting]\n    C --> D[Chain to PPTX]\n    D --> |1-2 min| E[Chain to PDF]\n    E --> |1-2 min| F[\"Total: 5-6 minutes\u003Cbr/>fully automated\"]\n\n    F --> G[\"Human review: 5 minutes\"]\n    G --> H[\"95% reduction in manual effort\"]\n\n    style F fill:#c8e6c9\n    style H fill:#c8e6c9\n```\n\nThe Skills API generates professional documents with formulas, charts, and formatting. You describe what you want; Claude builds it.\n\n## POC: Complete Working Implementation\n\nThis is the full code. Copy it, run it, modify it for your use case.\n\n### Step 1: Setup and Configuration\n\nCreate `document_pipeline.py`:\n\n```python\n#!/usr/bin/env -S uv run\n# /// script\n# dependencies = [\n#   \"anthropic>=0.69.0\",\n#   \"pandas>=2.0.0\",\n#   \"python-dotenv>=1.0.0\",\n# ]\n# ///\n\"\"\"\nDocument generation pipeline using Claude Skills.\n\nUsage:\n    uv run document_pipeline.py --data sample_data.json --output ./reports\n\nGenerates Excel, PowerPoint, and PDF from structured data.\n\"\"\"\n\nimport argparse\nimport json\nimport os\nfrom pathlib import Path\n\nimport pandas as pd\nfrom anthropic import Anthropic\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\nAPI_KEY = os.getenv(\"ANTHROPIC_API_KEY\")\nif not API_KEY:\n    raise ValueError(\"ANTHROPIC_API_KEY not found in environment\")\n\nclient = Anthropic(api_key=API_KEY)\nMODEL = \"claude-sonnet-4-5\"\n\n# Track token usage across pipeline\npipeline_tokens = {\"input\": 0, \"output\": 0}\n\n\ndef create_skills_message(prompt: str, skill_id: str, prefix: str = \"\") -> dict:\n    \"\"\"\n    Create a document using Claude Skills API.\n\n    Args:\n        prompt: Document generation instructions\n        skill_id: Which skill to use (xlsx, pptx, pdf)\n        prefix: Filename prefix for output\n\n    Returns:\n        Dict with response and file info\n    \"\"\"\n    response = client.beta.messages.create(\n        model=MODEL,\n        max_tokens=4096,\n        container={\"skills\": [{\"type\": \"anthropic\", \"skill_id\": skill_id, \"version\": \"latest\"}]},\n        tools=[{\"type\": \"code_execution_20250825\", \"name\": \"code_execution\"}],\n        messages=[{\"role\": \"user\", \"content\": prompt}],\n        betas=[\n            \"code-execution-2025-08-25\",\n            \"files-api-2025-04-14\",\n            \"skills-2025-10-02\",\n        ],\n    )\n\n    # Track tokens\n    pipeline_tokens[\"input\"] += response.usage.input_tokens\n    pipeline_tokens[\"output\"] += response.usage.output_tokens\n\n    return {\n        \"response\": response,\n        \"tokens_in\": response.usage.input_tokens,\n        \"tokens_out\": response.usage.output_tokens,\n    }\n```\n\n### Step 2: Excel Generation Function\n\n```python\ndef generate_excel(data: dict, output_dir: Path) -> dict:\n    \"\"\"\n    Generate Excel workbook with data, formulas, and charts.\n\n    Best practice: 2-3 sheets per workbook for reliable generation.\n    \"\"\"\n    prompt = f\"\"\"\nCreate an Excel workbook with 2 sheets:\n\nSheet 1 - \"Data Summary\":\nCreate a summary table with the following data:\n{json.dumps(data.get(\"summary\", {}), indent=2)}\n\nInclude:\n- Headers with bold formatting\n- Currency formatting for financial values\n- Formulas for totals and percentages\n- Conditional formatting: green for positive, red for negative\n\nSheet 2 - \"Charts\":\nCreate visualizations from the data:\n- Bar chart showing key metrics\n- Include chart title and axis labels\n- Professional color scheme\n\nApply professional formatting with borders and clear sections.\n\"\"\"\n\n    result = create_skills_message(prompt, \"xlsx\", \"data_report_\")\n    print(f\"  Excel: {result['tokens_in']:,} in, {result['tokens_out']:,} out\")\n    return result\n```\n\n### Step 3: PowerPoint Generation Function\n\n```python\ndef generate_powerpoint(data: dict, output_dir: Path) -> dict:\n    \"\"\"\n    Generate executive presentation from data.\n\n    Best practice: Clear, data-driven slides with minimal text.\n    \"\"\"\n    summary = data.get(\"summary\", {})\n\n    prompt = f\"\"\"\nCreate a 4-slide executive presentation:\n\nSlide 1 - Title:\n- Title: \"{data.get('title', 'Quarterly Report')}\"\n- Subtitle: \"Executive Summary\"\n- Date: {data.get('date', 'Q4 2024')}\n\nSlide 2 - Key Metrics:\n- Title: \"Performance Highlights\"\n- Two-column layout:\n  Left: Key metrics with values\n  Right: Bar chart of top metrics\n- Data: {json.dumps(summary.get('metrics', {}), indent=2)}\n\nSlide 3 - Trends:\n- Title: \"Quarterly Trends\"\n- Line chart showing progression\n- Bullet points for insights\n- Data: {json.dumps(summary.get('trends', []), indent=2)}\n\nSlide 4 - Recommendations:\n- Title: \"Key Takeaways\"\n- 4-5 bullet points summarizing findings\n- Clear call to action\n\nUse professional corporate design:\n- Dark blue (#003366) for headers\n- Clean, modern layout\n- Data-driven visualizations\n\"\"\"\n\n    result = create_skills_message(prompt, \"pptx\", \"executive_summary_\")\n    print(f\"  PowerPoint: {result['tokens_in']:,} in, {result['tokens_out']:,} out\")\n    return result\n```\n\n### Step 4: PDF Generation Function\n\n```python\ndef generate_pdf(data: dict, output_dir: Path) -> dict:\n    \"\"\"\n    Generate formal PDF documentation.\n\n    Best practice: Clear sections, consistent formatting.\n    \"\"\"\n    prompt = f\"\"\"\nCreate a PDF document:\n\nDOCUMENT TITLE\n{data.get('title', 'Report')}\n\nEXECUTIVE SUMMARY\n{data.get('executive_summary', 'Summary of key findings.')}\n\nKEY METRICS\n{json.dumps(data.get('summary', {}).get('metrics', {}), indent=2)}\n\nANALYSIS\n- Document the methodology\n- Present key findings\n- Note any caveats or limitations\n\nRECOMMENDATIONS\n{json.dumps(data.get('recommendations', []), indent=2)}\n\nAPPENDIX\n- Data sources\n- Methodology notes\n- Contact information\n\nFormat as a professional business document with:\n- Clear section headers\n- Consistent typography\n- Page numbers\n- Date stamp\n\"\"\"\n\n    result = create_skills_message(prompt, \"pdf\", \"documentation_\")\n    print(f\"  PDF: {result['tokens_in']:,} in, {result['tokens_out']:,} out\")\n    return result\n```\n\n### Step 5: Pipeline Orchestration\n\n```python\ndef run_pipeline(data_path: str, output_dir: str) -> dict:\n    \"\"\"\n    Run complete document generation pipeline.\n\n    Returns:\n        Dict with all results and token usage\n    \"\"\"\n    output_path = Path(output_dir)\n    output_path.mkdir(parents=True, exist_ok=True)\n\n    # Load data\n    with open(data_path) as f:\n        data = json.load(f)\n\n    print(\"=\" * 60)\n    print(\"DOCUMENT GENERATION PIPELINE\")\n    print(\"=\" * 60)\n\n    results = {}\n\n    # Step 1: Excel\n    print(\"\\nStep 1/3: Generating Excel...\")\n    results[\"excel\"] = generate_excel(data, output_path)\n\n    # Step 2: PowerPoint\n    print(\"\\nStep 2/3: Generating PowerPoint...\")\n    results[\"powerpoint\"] = generate_powerpoint(data, output_path)\n\n    # Step 3: PDF\n    print(\"\\nStep 3/3: Generating PDF...\")\n    results[\"pdf\"] = generate_pdf(data, output_path)\n\n    # Summary\n    print(\"\\n\" + \"=\" * 60)\n    print(\"PIPELINE COMPLETE\")\n    print(\"=\" * 60)\n    print(f\"\\nTotal Input Tokens:  {pipeline_tokens['input']:,}\")\n    print(f\"Total Output Tokens: {pipeline_tokens['output']:,}\")\n    print(f\"Total Tokens:        {pipeline_tokens['input'] + pipeline_tokens['output']:,}\")\n\n    # Cost estimate (Sonnet pricing: $3/M input, $15/M output)\n    cost = (pipeline_tokens['input'] * 3 + pipeline_tokens['output'] * 15) / 1_000_000\n    print(f\"Estimated Cost:      ${cost:.4f}\")\n\n    return results\n\n\ndef main():\n    parser = argparse.ArgumentParser(description=\"Generate documents from data\")\n    parser.add_argument(\"--data\", required=True, help=\"Path to JSON data file\")\n    parser.add_argument(\"--output\", default=\"./output\", help=\"Output directory\")\n    args = parser.parse_args()\n\n    run_pipeline(args.data, args.output)\n\n\nif __name__ == \"__main__\":\n    main()\n```\n\n### Step 6: Sample Data File\n\nCreate `sample_data.json`:\n\n```json\n{\n  \"title\": \"Q4 2024 Business Review\",\n  \"date\": \"January 2025\",\n  \"executive_summary\": \"Q4 2024 showed strong performance with 17.9% YoY revenue growth and significant margin expansion.\",\n  \"summary\": {\n    \"metrics\": {\n      \"revenue\": 14500000,\n      \"revenue_growth_yoy\": 17.9,\n      \"net_income\": 1878750,\n      \"operating_margin\": 17.9,\n      \"customer_count\": 850,\n      \"churn_rate\": 2.8\n    },\n    \"trends\": [\n      {\"quarter\": \"Q1 2024\", \"revenue\": 12500000, \"margin\": 15.0},\n      {\"quarter\": \"Q2 2024\", \"revenue\": 13200000, \"margin\": 15.8},\n      {\"quarter\": \"Q3 2024\", \"revenue\": 13800000, \"margin\": 16.5},\n      {\"quarter\": \"Q4 2024\", \"revenue\": 14500000, \"margin\": 17.9}\n    ]\n  },\n  \"recommendations\": [\n    \"Maintain current growth trajectory\",\n    \"Expand customer success team to reduce churn\",\n    \"Invest in automation to improve margins\",\n    \"Consider international expansion in Q2 2025\"\n  ]\n}\n```\n\nRun the pipeline:\n\n```bash\nuv run document_pipeline.py --data sample_data.json --output ./reports\n```\n\n## The Numbers: What Actually Happens\n\nReal measurements from running this pipeline:\n\n| Document Type | Generation Time | Input Tokens | Output Tokens | Cost |\n|---------------|-----------------|--------------|---------------|------|\n| Excel (2 sheets) | 1-2 min | ~2,500 | ~3,000 | $0.05 |\n| PowerPoint (4 slides) | 1-2 min | ~2,000 | ~2,500 | $0.04 |\n| PDF (full report) | 1-2 min | ~1,800 | ~2,200 | $0.04 |\n| **Pipeline Total** | **5-6 min** | **~6,300** | **~7,700** | **$0.13** |\n\nCompare to manual:\n\n| Metric | Manual | Skills Pipeline | Improvement |\n|--------|--------|-----------------|-------------|\n| Time | 100 min | 10 min (5 gen + 5 review) | 10x |\n| Cost | ~$50/hour labor | $0.13 API | 380x |\n| Consistency | Variable | Identical | ∞ |\n| Error rate | Human errors | Prompt errors | Different |\n\n**Token efficiency note:** Skills use ~90% fewer tokens than manually instructing Claude to build documents step by step. The skill encapsulates document structure knowledge.\n\n## When This Works: Ideal Use Cases\n\n```mermaid\nflowchart LR\n    subgraph R[\"Recurring Reports\"]\n        R1[\"Weekly, monthly, quarterly\"]\n        R2[\"Same structure, different data\"]\n    end\n\n    subgraph D[\"Data-to-Document\"]\n        D1[\"JSON → Excel with formulas\"]\n        D2[\"CSV → PowerPoint summary\"]\n        D3[\"Metrics → PDF report\"]\n    end\n\n    subgraph M[\"Multi-Format Output\"]\n        M1[\"One dataset → Excel + PPTX + PDF\"]\n        M2[\"Consistent data across formats\"]\n    end\n\n    subgraph T[\"Template-Based\"]\n        T1[\"Defined structure, variable content\"]\n        T2[\"Professional formatting\"]\n    end\n\n    subgraph B[\"Batch Processing\"]\n        B1[\"Generate 50 client reports\"]\n        B2[\"Same prompt, different data\"]\n    end\n\n    style R fill:#c8e6c9\n    style D fill:#c8e6c9\n    style M fill:#c8e6c9\n    style T fill:#c8e6c9\n    style B fill:#c8e6c9\n```\n\n## When This Fails: Honest Limitations\n\nSkills are not magic. Here's what breaks.\n\n### Document Complexity Limits\n\n**Recommended limits:**\n- Excel: 2-3 sheets per workbook\n- PowerPoint: 5-7 slides per deck\n- PDF: 10-15 pages\n\nBeyond these, reliability degrades. Generation time increases exponentially, and partial failures become common.\n\n**Workaround:** Break complex documents into multiple focused files.\n\n```python\n# Bad: One complex 10-sheet Excel\ngenerate_excel(full_data, \"complete_report.xlsx\")  # Fails at scale\n\n# Good: Multiple focused files\ngenerate_excel(pnl_data, \"pnl_report.xlsx\")\ngenerate_excel(balance_data, \"balance_sheet.xlsx\")\ngenerate_excel(kpi_data, \"kpi_dashboard.xlsx\")\n```\n\n### Data Format Sensitivity\n\nSkills are sensitive to input data structure. Slight variations cause unpredictable output.\n\n**Example failure:**\n```python\n# Works\ndata = {\"revenue\": 14500000, \"growth\": 17.9}\n\n# Fails (missing field)\ndata = {\"revenue\": 14500000}  # No growth → chart generation fails\n\n# Fails (wrong type)\ndata = {\"revenue\": \"14.5M\"}   # String not number → formula errors\n```\n\n**Mitigation:** Validate data structure before sending to Skills.\n\n```python\ndef validate_data(data: dict) -> bool:\n    required_fields = [\"revenue\", \"growth\", \"net_income\"]\n    return all(field in data.get(\"summary\", {}).get(\"metrics\", {})\n               for field in required_fields)\n```\n\n### Rate Limits and Timeouts\n\n**Failure modes:**\n- Generating multiple complex documents simultaneously hits rate limits\n- Generation time can vary from 30 seconds to 5 minutes\n- No guaranteed maximum completion time\n\n**Mitigation:** Implement retry logic and sequential execution.\n\n```python\nimport time\nfrom tenacity import retry, stop_after_attempt, wait_exponential\n\n@retry(stop=stop_after_attempt(3), wait=wait_exponential(min=1, max=10))\ndef generate_with_retry(prompt: str, skill_id: str) -> dict:\n    return create_skills_message(prompt, skill_id)\n\ndef sequential_pipeline(data_files: list) -> list:\n    results = []\n    for data_file in data_files:\n        result = generate_with_retry(data_file)\n        results.append(result)\n        time.sleep(2)  # Rate limit buffer\n    return results\n```\n\n### Numeric Precision\n\nFinancial calculations can lose precision. Rounding errors accumulate.\n\n**Example:**\n```\nExpected: $14,500,000.00\nGenerated: $14,499,999.99\n```\n\n**Mitigation:** Specify precision explicitly in prompts.\n\n```python\nprompt = \"\"\"\nFormat all currency values:\n- Use exactly 2 decimal places\n- Round to nearest cent using banker's rounding\n- Display as $X,XXX,XXX.XX format\n\"\"\"\n```\n\n### No Persistent State\n\nEach Skills call is stateless. Documents generated in separate calls may have subtle inconsistencies.\n\n**Example failure:**\n- Excel shows revenue of $14.5M\n- PowerPoint shows revenue of $14.51M (different rounding)\n\n**Mitigation:** Generate all documents from the same data dict in the same session. Pass exact values, not calculated values.\n\n```python\n# Good: Same canonical data\ndata = {\"revenue\": 14500000}\ngenerate_excel(data, ...)\ngenerate_powerpoint(data, ...)  # Same source\n\n# Bad: Calculated values drift\nexcel_data = {\"revenue\": calculate_revenue()}  # 14500000\nppt_data = {\"revenue\": calculate_revenue()}    # 14500001 (race condition)\n```\n\n### Pipeline Fragility\n\nIf step 2 fails, step 3 never runs. One failure breaks the entire pipeline.\n\n**Mitigation:** Implement robust error handling with partial success tracking.\n\n```python\ndef resilient_pipeline(data: dict) -> dict:\n    results = {\"excel\": None, \"powerpoint\": None, \"pdf\": None, \"errors\": []}\n\n    try:\n        results[\"excel\"] = generate_excel(data)\n    except Exception as e:\n        results[\"errors\"].append(f\"Excel failed: {e}\")\n\n    try:\n        results[\"powerpoint\"] = generate_powerpoint(data)\n    except Exception as e:\n        results[\"errors\"].append(f\"PowerPoint failed: {e}\")\n\n    try:\n        results[\"pdf\"] = generate_pdf(data)\n    except Exception as e:\n        results[\"errors\"].append(f\"PDF failed: {e}\")\n\n    return results\n```\n\n## Best Practices: What We Learned\n\n**Document structure:**\n- 2-3 sheets/slides per document for reliable generation\n- Focus each sheet on a single purpose\n- Break complex reports into multiple files\n- Chain documents sequentially, not in parallel\n\n**Prompt design:**\n- Use structured data (JSON) not prose descriptions\n- Specify exact formatting requirements\n- Include examples of expected output\n- Be explicit about formulas and calculations\n\n**Error handling:**\n- Validate data before sending to Skills\n- Implement retry logic with exponential backoff\n- Track partial successes separately from complete failures\n- Log token usage for cost monitoring\n\n**Maintenance:**\n- Monitor token usage trends over time\n- Test prompts when updating to new SDK versions\n- Keep prompt templates versioned with your code\n- Build automated tests for document generation\n\n## Agent Opportunity: Document Generation Agent\n\nBuild a specialized agent for document generation:\n\n```markdown\n---\nname: document-generator\ndescription: Generate multi-format business documents from structured data\ntools: Bash, Read, Write, Skill\nmodel: sonnet\n---\n\n# Document Generation Agent\n\n## Workflow\n\n1. **Validate input data**\n   - Check required fields exist\n   - Verify data types are correct\n   - Normalize date formats\n\n2. **Generate documents sequentially**\n   - Excel first (primary data source)\n   - PowerPoint second (summary view)\n   - PDF third (formal documentation)\n\n3. **Verify outputs**\n   - Check file sizes are reasonable\n   - Verify no generation errors\n   - Log token usage\n\n4. **Report completion**\n   - List generated files with sizes\n   - Summarize token usage and cost\n   - Note any warnings or partial failures\n\n## Rules\n\n- NEVER generate more than 3 sheets per Excel\n- ALWAYS validate data before calling Skills API\n- ALWAYS implement retry logic\n- ALWAYS track token usage for cost management\n```\n\nThis agent can be triggered by file drops in a watched directory—see the Directory Watchers post for that pattern.\n\n---\n\n**Key Takeaways:**\n- Skills generate professional documents (Excel, PowerPoint, PDF) in 1-2 minutes each\n- Pipeline approach: data → Excel → PowerPoint → PDF, 5-6 minutes total\n- 90% fewer tokens than manual document instructions\n- Cost: ~$0.13 per complete pipeline vs $50+ manual labor\n- Reliability limits: 2-3 sheets per Excel, 5-7 slides per PowerPoint\n- Common failures: complexity limits, data format sensitivity, rate limits\n- Mitigations: break complex docs into focused files, validate data, implement retries\n- Best fit: recurring reports, data-to-document conversion, template-based generation\n\n**Try It Now:**\nCopy the `document_pipeline.py` and `sample_data.json` files above. Run `uv run document_pipeline.py --data sample_data.json --output ./reports`. Check the generated files. Modify the prompts for your use case. Track token usage to estimate your costs.\n\n---\n\n*Next in series: Part 2 covers advanced patterns—custom templates, conditional formatting, and multi-source data aggregation.*","src/content/blog/document-generation-skills.md","359e7bdfc2c95cac",{"html":309,"metadata":310},"\u003Cp>Document generation is the unsexy automation that saves hours.\u003C/p>\n\u003Cp>Not code generation. Not chat interfaces. Document generation—the Excel reports, PowerPoint decks, and PDFs that every business runs on. Claude Skills turn this from hours of manual work into minutes of automated execution.\u003C/p>\n\u003Cp>This is Part 1 of a series on AI document skills. We’ll cover the core pattern, build a working POC, and measure what actually happens in production. Financial reporting is the example, but the pattern applies anywhere you need structured documents from data.\u003C/p>\n\u003Ch2 id=\"the-core-problem-manual-documents-dont-scale\">The Core Problem: Manual Documents Don’t Scale\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart TD\n    A([Data arrives]) --> B[Analyst opens&#x3C;br/>Excel template]\n    B --> |10 minutes| C[Copy-paste data&#x3C;br/>Update formulas&#x3C;br/>Fix formatting]\n    C --> |30 minutes| D[Create PowerPoint&#x3C;br/>Summarize insights&#x3C;br/>Make it pretty]\n    D --> |45 minutes| E[Generate PDF&#x3C;br/>Final review]\n    E --> |15 minutes| F[Total: 100 minutes]\n\n    F --> G[\"Quarterly = 6+ hours/year\"]\n    G --> H[\"With 10 analysts = 60+ hours/year\"]\n\n    style F fill:#ffcdd2\n    style H fill:#ffcdd2\n\u003C/pre>\n\u003Cp>This is busy work. Highly paid knowledge workers doing copy-paste operations.\u003C/p>\n\u003Ch2 id=\"the-pattern-skills-api-document-pipeline\">The Pattern: Skills API Document Pipeline\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart TD\n    A([Data arrives]) --> B[\"Skills API Call&#x3C;br/>'Generate Excel with this data'\"]\n    B --> |1-2 min| C[Claude generates&#x3C;br/>Excel with formulas,&#x3C;br/>charts, formatting]\n    C --> D[Chain to PPTX]\n    D --> |1-2 min| E[Chain to PDF]\n    E --> |1-2 min| F[\"Total: 5-6 minutes&#x3C;br/>fully automated\"]\n\n    F --> G[\"Human review: 5 minutes\"]\n    G --> H[\"95% reduction in manual effort\"]\n\n    style F fill:#c8e6c9\n    style H fill:#c8e6c9\n\u003C/pre>\n\u003Cp>The Skills API generates professional documents with formulas, charts, and formatting. You describe what you want; Claude builds it.\u003C/p>\n\u003Ch2 id=\"poc-complete-working-implementation\">POC: Complete Working Implementation\u003C/h2>\n\u003Cp>This is the full code. Copy it, run it, modify it for your use case.\u003C/p>\n\u003Ch3 id=\"step-1-setup-and-configuration\">Step 1: Setup and Configuration\u003C/h3>\n\u003Cp>Create \u003Ccode>document_pipeline.py\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#!/usr/bin/env -S uv run\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># /// script\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># dependencies = [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"anthropic>=0.69.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"pandas>=2.0.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"python-dotenv>=1.0.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ///\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Document generation pipeline using Claude Skills.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Usage:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    uv run document_pipeline.py --data sample_data.json --output ./reports\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Generates Excel, PowerPoint, and PDF from structured data.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> argparse\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pathlib \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pandas \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pd\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> anthropic \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> dotenv \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> load_dotenv\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">load_dotenv()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">API_KEY\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.getenv(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ANTHROPIC_API_KEY\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#79B8FF\"> API_KEY\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    raise\u003C/span>\u003Cspan style=\"color:#79B8FF\"> ValueError\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"ANTHROPIC_API_KEY not found in environment\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">client \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic(\u003C/span>\u003Cspan style=\"color:#FFAB70\">api_key\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">API_KEY\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">MODEL\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"claude-sonnet-4-5\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Track token usage across pipeline\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">pipeline_tokens \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"input\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"output\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> create_skills_message\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(prompt: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, skill_id: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, prefix: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Create a document using Claude Skills API.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Args:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        prompt: Document generation instructions\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        skill_id: Which skill to use (xlsx, pptx, pdf)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        prefix: Filename prefix for output\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Returns:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        Dict with response and file info\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> client.beta.messages.create(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        model\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">MODEL\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        max_tokens\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">4096\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        container\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"skills\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"anthropic\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"skill_id\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: skill_id, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"version\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"latest\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}]},\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        tools\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"code_execution_20250825\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"name\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"code_execution\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        messages\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: prompt}],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        betas\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"code-execution-2025-08-25\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"files-api-2025-04-14\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"skills-2025-10-02\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        ],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Track tokens\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"input\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.usage.input_tokens\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"output\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.usage.output_tokens\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"response\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: response,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"tokens_in\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: response.usage.input_tokens,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"tokens_out\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: response.usage.output_tokens,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-2-excel-generation-function\">Step 2: Excel Generation Function\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> generate_excel\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: Path) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Generate Excel workbook with data, formulas, and charts.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Best practice: 2-3 sheets per workbook for reliable generation.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Create an Excel workbook with 2 sheets:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Sheet 1 - \"Data Summary\":\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Create a summary table with the following data:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">json.dumps(data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"summary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {}), \u003C/span>\u003Cspan style=\"color:#FFAB70\">indent\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Include:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Headers with bold formatting\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Currency formatting for financial values\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Formulas for totals and percentages\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Conditional formatting: green for positive, red for negative\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Sheet 2 - \"Charts\":\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Create visualizations from the data:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Bar chart showing key metrics\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Include chart title and axis labels\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Professional color scheme\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Apply professional formatting with borders and clear sections.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> create_skills_message(prompt, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"xlsx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"data_report_\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"  Excel: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'tokens_in'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> in, \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'tokens_out'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> out\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-3-powerpoint-generation-function\">Step 3: PowerPoint Generation Function\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> generate_powerpoint\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: Path) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Generate executive presentation from data.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Best practice: Clear, data-driven slides with minimal text.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    summary \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"summary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Create a 4-slide executive presentation:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Slide 1 - Title:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Title: \"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'title'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Quarterly Report'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Subtitle: \"Executive Summary\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Date: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'date'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Q4 2024'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Slide 2 - Key Metrics:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Title: \"Performance Highlights\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Two-column layout:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">  Left: Key metrics with values\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">  Right: Bar chart of top metrics\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">json.dumps(summary.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'metrics'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {}), \u003C/span>\u003Cspan style=\"color:#FFAB70\">indent\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Slide 3 - Trends:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Title: \"Quarterly Trends\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Line chart showing progression\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Bullet points for insights\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">json.dumps(summary.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'trends'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, []), \u003C/span>\u003Cspan style=\"color:#FFAB70\">indent\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Slide 4 - Recommendations:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Title: \"Key Takeaways\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- 4-5 bullet points summarizing findings\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Clear call to action\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Use professional corporate design:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Dark blue (#003366) for headers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Clean, modern layout\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Data-driven visualizations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> create_skills_message(prompt, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pptx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"executive_summary_\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"  PowerPoint: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'tokens_in'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> in, \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'tokens_out'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> out\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-4-pdf-generation-function\">Step 4: PDF Generation Function\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> generate_pdf\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: Path) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Generate formal PDF documentation.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Best practice: Clear sections, consistent formatting.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Create a PDF document:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">DOCUMENT TITLE\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'title'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Report'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">EXECUTIVE SUMMARY\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'executive_summary'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'Summary of key findings.'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">KEY METRICS\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">json.dumps(data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'summary'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {}).get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'metrics'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {}), \u003C/span>\u003Cspan style=\"color:#FFAB70\">indent\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">ANALYSIS\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Document the methodology\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Present key findings\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Note any caveats or limitations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">RECOMMENDATIONS\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">json.dumps(data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'recommendations'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, []), \u003C/span>\u003Cspan style=\"color:#FFAB70\">indent\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">APPENDIX\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Data sources\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Methodology notes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Contact information\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Format as a professional business document with:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Clear section headers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Consistent typography\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Page numbers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Date stamp\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> create_skills_message(prompt, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"documentation_\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"  PDF: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'tokens_in'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> in, \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">result[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'tokens_out'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> out\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-5-pipeline-orchestration\">Step 5: Pipeline Orchestration\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> run_pipeline\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data_path: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Run complete document generation pipeline.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    Returns:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        Dict with all results and token usage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Path(output_dir)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    output_path.mkdir(\u003C/span>\u003Cspan style=\"color:#FFAB70\">parents\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">exist_ok\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Load data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data_path) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json.load(f)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"=\"\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 60\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"DOCUMENT GENERATION PIPELINE\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"=\"\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 60\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    results \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Step 1: Excel\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">Step 1/3: Generating Excel...\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"excel\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_excel(data, output_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Step 2: PowerPoint\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">Step 2/3: Generating PowerPoint...\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"powerpoint\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_powerpoint(data, output_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Step 3: PDF\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">Step 3/3: Generating PDF...\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_pdf(data, output_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Summary\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#F97583\"> +\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"=\"\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 60\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"PIPELINE COMPLETE\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"=\"\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 60\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">Total Input Tokens:  \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'input'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Total Output Tokens: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'output'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Total Tokens:        \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'input'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'output'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#F97583\">:,\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Cost estimate (Sonnet pricing: $3/M input, $15/M output)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    cost \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'input'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 3\u003C/span>\u003Cspan style=\"color:#F97583\"> +\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pipeline_tokens[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'output'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 15\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1_000_000\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Estimated Cost:      $\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">cost\u003C/span>\u003Cspan style=\"color:#F97583\">:.4f\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> results\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> main\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> argparse.ArgumentParser(\u003C/span>\u003Cspan style=\"color:#FFAB70\">description\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Generate documents from data\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser.add_argument(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--data\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">required\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">help\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Path to JSON data file\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser.add_argument(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--output\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">default\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"./output\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">help\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Output directory\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    args \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> parser.parse_args()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    run_pipeline(args.data, args.output)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __name__\u003C/span>\u003Cspan style=\"color:#F97583\"> ==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"__main__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    main()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-6-sample-data-file\">Step 6: Sample Data File\u003C/h3>\n\u003Cp>Create \u003Ccode>sample_data.json\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"json\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"title\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Q4 2024 Business Review\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"date\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"January 2025\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"executive_summary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Q4 2024 showed strong performance with 17.9% YoY revenue growth and significant margin expansion.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"summary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"metrics\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">14500000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"revenue_growth_yoy\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">17.9\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"net_income\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1878750\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"operating_margin\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">17.9\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"customer_count\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">850\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">      \"churn_rate\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">2.8\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    \"trends\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      {\u003C/span>\u003Cspan style=\"color:#79B8FF\">\"quarter\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Q1 2024\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">12500000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"margin\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">15.0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">},\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      {\u003C/span>\u003Cspan style=\"color:#79B8FF\">\"quarter\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Q2 2024\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">13200000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"margin\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">15.8\u003C/span>\u003Cspan style=\"color:#E1E4E8\">},\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      {\u003C/span>\u003Cspan style=\"color:#79B8FF\">\"quarter\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Q3 2024\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">13800000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"margin\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">16.5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">},\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">      {\u003C/span>\u003Cspan style=\"color:#79B8FF\">\"quarter\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Q4 2024\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">14500000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">\"margin\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">17.9\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  },\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">  \"recommendations\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"Maintain current growth trajectory\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"Expand customer success team to reduce churn\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"Invest in automation to improve margins\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"Consider international expansion in Q2 2025\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">  ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Run the pipeline:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> document_pipeline.py\u003C/span>\u003Cspan style=\"color:#79B8FF\"> --data\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> sample_data.json\u003C/span>\u003Cspan style=\"color:#79B8FF\"> --output\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ./reports\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"the-numbers-what-actually-happens\">The Numbers: What Actually Happens\u003C/h2>\n\u003Cp>Real measurements from running this pipeline:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Document Type\u003C/th>\u003Cth>Generation Time\u003C/th>\u003Cth>Input Tokens\u003C/th>\u003Cth>Output Tokens\u003C/th>\u003Cth>Cost\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Excel (2 sheets)\u003C/td>\u003Ctd>1-2 min\u003C/td>\u003Ctd>~2,500\u003C/td>\u003Ctd>~3,000\u003C/td>\u003Ctd>$0.05\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>PowerPoint (4 slides)\u003C/td>\u003Ctd>1-2 min\u003C/td>\u003Ctd>~2,000\u003C/td>\u003Ctd>~2,500\u003C/td>\u003Ctd>$0.04\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>PDF (full report)\u003C/td>\u003Ctd>1-2 min\u003C/td>\u003Ctd>~1,800\u003C/td>\u003Ctd>~2,200\u003C/td>\u003Ctd>$0.04\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>\u003Cstrong>Pipeline Total\u003C/strong>\u003C/td>\u003Ctd>\u003Cstrong>5-6 min\u003C/strong>\u003C/td>\u003Ctd>\u003Cstrong>~6,300\u003C/strong>\u003C/td>\u003Ctd>\u003Cstrong>~7,700\u003C/strong>\u003C/td>\u003Ctd>\u003Cstrong>$0.13\u003C/strong>\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>Compare to manual:\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Metric\u003C/th>\u003Cth>Manual\u003C/th>\u003Cth>Skills Pipeline\u003C/th>\u003Cth>Improvement\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Time\u003C/td>\u003Ctd>100 min\u003C/td>\u003Ctd>10 min (5 gen + 5 review)\u003C/td>\u003Ctd>10x\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Cost\u003C/td>\u003Ctd>~$50/hour labor\u003C/td>\u003Ctd>$0.13 API\u003C/td>\u003Ctd>380x\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Consistency\u003C/td>\u003Ctd>Variable\u003C/td>\u003Ctd>Identical\u003C/td>\u003Ctd>∞\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Error rate\u003C/td>\u003Ctd>Human errors\u003C/td>\u003Ctd>Prompt errors\u003C/td>\u003Ctd>Different\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>\u003Cstrong>Token efficiency note:\u003C/strong> Skills use ~90% fewer tokens than manually instructing Claude to build documents step by step. The skill encapsulates document structure knowledge.\u003C/p>\n\u003Ch2 id=\"when-this-works-ideal-use-cases\">When This Works: Ideal Use Cases\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart LR\n    subgraph R[\"Recurring Reports\"]\n        R1[\"Weekly, monthly, quarterly\"]\n        R2[\"Same structure, different data\"]\n    end\n\n    subgraph D[\"Data-to-Document\"]\n        D1[\"JSON → Excel with formulas\"]\n        D2[\"CSV → PowerPoint summary\"]\n        D3[\"Metrics → PDF report\"]\n    end\n\n    subgraph M[\"Multi-Format Output\"]\n        M1[\"One dataset → Excel + PPTX + PDF\"]\n        M2[\"Consistent data across formats\"]\n    end\n\n    subgraph T[\"Template-Based\"]\n        T1[\"Defined structure, variable content\"]\n        T2[\"Professional formatting\"]\n    end\n\n    subgraph B[\"Batch Processing\"]\n        B1[\"Generate 50 client reports\"]\n        B2[\"Same prompt, different data\"]\n    end\n\n    style R fill:#c8e6c9\n    style D fill:#c8e6c9\n    style M fill:#c8e6c9\n    style T fill:#c8e6c9\n    style B fill:#c8e6c9\n\u003C/pre>\n\u003Ch2 id=\"when-this-fails-honest-limitations\">When This Fails: Honest Limitations\u003C/h2>\n\u003Cp>Skills are not magic. Here’s what breaks.\u003C/p>\n\u003Ch3 id=\"document-complexity-limits\">Document Complexity Limits\u003C/h3>\n\u003Cp>\u003Cstrong>Recommended limits:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Excel: 2-3 sheets per workbook\u003C/li>\n\u003Cli>PowerPoint: 5-7 slides per deck\u003C/li>\n\u003Cli>PDF: 10-15 pages\u003C/li>\n\u003C/ul>\n\u003Cp>Beyond these, reliability degrades. Generation time increases exponentially, and partial failures become common.\u003C/p>\n\u003Cp>\u003Cstrong>Workaround:\u003C/strong> Break complex documents into multiple focused files.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Bad: One complex 10-sheet Excel\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">generate_excel(full_data, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"complete_report.xlsx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Fails at scale\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Good: Multiple focused files\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">generate_excel(pnl_data, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pnl_report.xlsx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">generate_excel(balance_data, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"balance_sheet.xlsx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">generate_excel(kpi_data, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"kpi_dashboard.xlsx\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"data-format-sensitivity\">Data Format Sensitivity\u003C/h3>\n\u003Cp>Skills are sensitive to input data structure. Slight variations cause unpredictable output.\u003C/p>\n\u003Cp>\u003Cstrong>Example failure:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Works\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">14500000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"growth\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">17.9\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Fails (missing field)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">14500000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}  \u003C/span>\u003Cspan style=\"color:#6A737D\"># No growth → chart generation fails\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Fails (wrong type)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"14.5M\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}   \u003C/span>\u003Cspan style=\"color:#6A737D\"># String not number → formula errors\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Validate data structure before sending to Skills.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> validate_data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    required_fields \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"growth\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"net_income\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> all\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(field \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"summary\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {}).get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"metrics\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">               for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> field \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> required_fields)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"rate-limits-and-timeouts\">Rate Limits and Timeouts\u003C/h3>\n\u003Cp>\u003Cstrong>Failure modes:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Generating multiple complex documents simultaneously hits rate limits\u003C/li>\n\u003Cli>Generation time can vary from 30 seconds to 5 minutes\u003C/li>\n\u003Cli>No guaranteed maximum completion time\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Implement retry logic and sequential execution.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> tenacity \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> retry, stop_after_attempt, wait_exponential\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">@retry\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#FFAB70\">stop\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">stop_after_attempt(\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">), \u003C/span>\u003Cspan style=\"color:#FFAB70\">wait\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">wait_exponential(\u003C/span>\u003Cspan style=\"color:#FFAB70\">min\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">max\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> generate_with_retry\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(prompt: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, skill_id: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> create_skills_message(prompt, skill_id)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> sequential_pipeline\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data_files: \u003C/span>\u003Cspan style=\"color:#79B8FF\">list\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">list\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    results \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_file \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> data_files:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_with_retry(data_file)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results.append(result)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Rate limit buffer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> results\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"numeric-precision\">Numeric Precision\u003C/h3>\n\u003Cp>Financial calculations can lose precision. Rounding errors accumulate.\u003C/p>\n\u003Cp>\u003Cstrong>Example:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"plaintext\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan>Expected: $14,500,000.00\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan>Generated: $14,499,999.99\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Specify precision explicitly in prompts.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Format all currency values:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Use exactly 2 decimal places\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Round to nearest cent using banker's rounding\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">- Display as $X,XXX,XXX.XX format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"no-persistent-state\">No Persistent State\u003C/h3>\n\u003Cp>Each Skills call is stateless. Documents generated in separate calls may have subtle inconsistencies.\u003C/p>\n\u003Cp>\u003Cstrong>Example failure:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Excel shows revenue of $14.5M\u003C/li>\n\u003Cli>PowerPoint shows revenue of $14.51M (different rounding)\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Generate all documents from the same data dict in the same session. Pass exact values, not calculated values.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Good: Same canonical data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">14500000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">generate_excel(data, \u003C/span>\u003Cspan style=\"color:#79B8FF\">...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">generate_powerpoint(data, \u003C/span>\u003Cspan style=\"color:#79B8FF\">...\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Same source\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Bad: Calculated values drift\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">excel_data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: calculate_revenue()}  \u003C/span>\u003Cspan style=\"color:#6A737D\"># 14500000\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">ppt_data \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"revenue\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: calculate_revenue()}    \u003C/span>\u003Cspan style=\"color:#6A737D\"># 14500001 (race condition)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"pipeline-fragility\">Pipeline Fragility\u003C/h3>\n\u003Cp>If step 2 fails, step 3 never runs. One failure breaks the entire pipeline.\u003C/p>\n\u003Cp>\u003Cstrong>Mitigation:\u003C/strong> Implement robust error handling with partial success tracking.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> resilient_pipeline\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(data: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    results \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"excel\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"powerpoint\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">None\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"errors\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: []}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"excel\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_excel(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"errors\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].append(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Excel failed: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"powerpoint\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_powerpoint(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"errors\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].append(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"PowerPoint failed: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_pdf(data)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        results[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"errors\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].append(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"PDF failed: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> results\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"best-practices-what-we-learned\">Best Practices: What We Learned\u003C/h2>\n\u003Cp>\u003Cstrong>Document structure:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>2-3 sheets/slides per document for reliable generation\u003C/li>\n\u003Cli>Focus each sheet on a single purpose\u003C/li>\n\u003Cli>Break complex reports into multiple files\u003C/li>\n\u003Cli>Chain documents sequentially, not in parallel\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Prompt design:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Use structured data (JSON) not prose descriptions\u003C/li>\n\u003Cli>Specify exact formatting requirements\u003C/li>\n\u003Cli>Include examples of expected output\u003C/li>\n\u003Cli>Be explicit about formulas and calculations\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Error handling:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Validate data before sending to Skills\u003C/li>\n\u003Cli>Implement retry logic with exponential backoff\u003C/li>\n\u003Cli>Track partial successes separately from complete failures\u003C/li>\n\u003Cli>Log token usage for cost monitoring\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Maintenance:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Monitor token usage trends over time\u003C/li>\n\u003Cli>Test prompts when updating to new SDK versions\u003C/li>\n\u003Cli>Keep prompt templates versioned with your code\u003C/li>\n\u003Cli>Build automated tests for document generation\u003C/li>\n\u003C/ul>\n\u003Ch2 id=\"agent-opportunity-document-generation-agent\">Agent Opportunity: Document Generation Agent\u003C/h2>\n\u003Cp>Build a specialized agent for document generation:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">name: document-generator\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">description: Generate multi-format business documents from structured data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">tools: Bash, Read, Write, Skill\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">model: sonnet\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">---\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Document Generation Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Workflow\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Validate input data**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Check required fields exist\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Verify data types are correct\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Normalize date formats\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Generate documents sequentially**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Excel first (primary data source)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> PowerPoint second (summary view)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> PDF third (formal documentation)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Verify outputs**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Check file sizes are reasonable\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Verify no generation errors\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Log token usage\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Report completion**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> List generated files with sizes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Summarize token usage and cost\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Note any warnings or partial failures\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Rules\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> NEVER generate more than 3 sheets per Excel\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ALWAYS validate data before calling Skills API\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ALWAYS implement retry logic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> ALWAYS track token usage for cost management\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This agent can be triggered by file drops in a watched directory—see the Directory Watchers post for that pattern.\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cstrong>Key Takeaways:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Skills generate professional documents (Excel, PowerPoint, PDF) in 1-2 minutes each\u003C/li>\n\u003Cli>Pipeline approach: data → Excel → PowerPoint → PDF, 5-6 minutes total\u003C/li>\n\u003Cli>90% fewer tokens than manual document instructions\u003C/li>\n\u003Cli>Cost: ~$0.13 per complete pipeline vs $50+ manual labor\u003C/li>\n\u003Cli>Reliability limits: 2-3 sheets per Excel, 5-7 slides per PowerPoint\u003C/li>\n\u003Cli>Common failures: complexity limits, data format sensitivity, rate limits\u003C/li>\n\u003Cli>Mitigations: break complex docs into focused files, validate data, implement retries\u003C/li>\n\u003Cli>Best fit: recurring reports, data-to-document conversion, template-based generation\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Try It Now:\u003C/strong>\nCopy the \u003Ccode>document_pipeline.py\u003C/code> and \u003Ccode>sample_data.json\u003C/code> files above. Run \u003Ccode>uv run document_pipeline.py --data sample_data.json --output ./reports\u003C/code>. Check the generated files. Modify the prompts for your use case. Track token usage to estimate your costs.\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cem>Next in series: Part 2 covers advanced patterns—custom templates, conditional formatting, and multi-source data aggregation.\u003C/em>\u003C/p>",{"headings":311,"localImagePaths":370,"remoteImagePaths":371,"frontmatter":372,"imagePaths":376},[312,315,318,321,324,327,330,333,336,339,342,345,346,349,352,355,358,361,364,367],{"depth":44,"slug":313,"text":314},"the-core-problem-manual-documents-dont-scale","The Core Problem: Manual Documents Don’t Scale",{"depth":44,"slug":316,"text":317},"the-pattern-skills-api-document-pipeline","The Pattern: Skills API Document Pipeline",{"depth":44,"slug":319,"text":320},"poc-complete-working-implementation","POC: Complete Working Implementation",{"depth":124,"slug":322,"text":323},"step-1-setup-and-configuration","Step 1: Setup and Configuration",{"depth":124,"slug":325,"text":326},"step-2-excel-generation-function","Step 2: Excel Generation Function",{"depth":124,"slug":328,"text":329},"step-3-powerpoint-generation-function","Step 3: PowerPoint Generation Function",{"depth":124,"slug":331,"text":332},"step-4-pdf-generation-function","Step 4: PDF Generation Function",{"depth":124,"slug":334,"text":335},"step-5-pipeline-orchestration","Step 5: Pipeline Orchestration",{"depth":124,"slug":337,"text":338},"step-6-sample-data-file","Step 6: Sample Data File",{"depth":44,"slug":340,"text":341},"the-numbers-what-actually-happens","The Numbers: What Actually Happens",{"depth":44,"slug":343,"text":344},"when-this-works-ideal-use-cases","When This Works: Ideal Use Cases",{"depth":44,"slug":254,"text":255},{"depth":124,"slug":347,"text":348},"document-complexity-limits","Document Complexity Limits",{"depth":124,"slug":350,"text":351},"data-format-sensitivity","Data Format Sensitivity",{"depth":124,"slug":353,"text":354},"rate-limits-and-timeouts","Rate Limits and Timeouts",{"depth":124,"slug":356,"text":357},"numeric-precision","Numeric Precision",{"depth":124,"slug":359,"text":360},"no-persistent-state","No Persistent State",{"depth":124,"slug":362,"text":363},"pipeline-fragility","Pipeline Fragility",{"depth":44,"slug":365,"text":366},"best-practices-what-we-learned","Best Practices: What We Learned",{"depth":44,"slug":368,"text":369},"agent-opportunity-document-generation-agent","Agent Opportunity: Document Generation Agent",[],[],{"title":285,"description":286,"pubDate":373,"author":17,"tags":374,"banner":295,"category":304,"difficulty":35,"tldr":297,"keyTakeaways":375},["Date","2025-12-17T00:00:00.000Z"],[19,289,290,23,291,292,293,294],[299,300,301,302,303],[],"document-generation-skills.md","directory-watchers",{"id":378,"data":380,"body":397,"filePath":398,"digest":399,"rendered":400,"legacyId":492},{"title":381,"description":382,"pubDate":383,"author":17,"tags":384,"draft":24,"banner":388,"seoKeywords":389,"tldr":390,"keyTakeaways":391,"category":304,"difficulty":35},"Directory Watchers: File-Based AI Automation That Scales","Turn your file system into an AI interface. Build drop zones that process files automatically with working Python code and production considerations.",["Date","2025-12-15T00:00:00.000Z"],[19,23,385,386,387],"file-system","python","production","/assets/posts/directory-watchers-banner.png",[],"Directory watchers turn your file system into an AI interface—drop a file, get processed results. Build with Python's watchdog library, configure zones via YAML, and handle production concerns like race conditions, error recovery, and monitoring.",[392,393,394,395,396],"Drop zones eliminate the chat interface—drag a file, get results automatically","Use watchdog events with pattern matching for flexible zone configuration","Production concerns: file locks, race conditions, atomic moves, error recovery","Archive originals before processing for debugging and audit trails","Add monitoring with simple JSON logs and file-based alerts for reliability","Directory watchers turn your file system into an AI interface.\n\nDrag a file into a folder. An agent processes it automatically. You get results. No chat. No prompting. No human-in-the-loop.\n\nThis post shows you how to build a complete drop zone system with working Python code, then walks through what breaks in production and how to fix it.\n\n## The Architecture\n\n```mermaid\nflowchart TB\n    subgraph DROPS[\"~/drops/\"]\n        D1[\"transcribe/\"] --> W1[\"Whisper → text\"]\n        D2[\"analyze/\"] --> W2[\"Claude → summary\"]\n        D3[\"images/\"] --> W3[\"Replicate → generations\"]\n        D4[\"data/\"] --> W4[\"Claude → analysis\"]\n    end\n\n    subgraph WATCHER[\"DIRECTORY WATCHER\"]\n        E1[watchdog events] --> E2[Pattern Match] --> E3[Agent Execute]\n    end\n\n    DROPS --> WATCHER\n\n    subgraph OUTPUT[\"OUTPUTS\"]\n        O1[\"~/output/{zone}/{timestamp}-{filename}.{result}\"]\n        O2[\"~/archive/{zone}/{timestamp}-{filename}.{original}\"]\n    end\n\n    WATCHER --> OUTPUT\n\n    style DROPS fill:#e3f2fd\n    style WATCHER fill:#fff3e0\n    style OUTPUT fill:#c8e6c9\n```\n\n## POC: Complete Drop Zone System\n\n### Step 1: Configuration File\n\nCreate `drops.yaml`:\n\n```yaml\n# Drop Zone Configuration\n# Each zone watches a directory and triggers an agent on file events\n\noutput_dir: ~/output\narchive_dir: ~/archive\nlog_dir: ~/logs\n\nzones:\n  transcribe:\n    directory: ~/drops/transcribe\n    patterns: [\"*.mp3\", \"*.wav\", \"*.m4a\", \"*.webm\"]\n    agent: whisper_transcribe\n    events: [created]\n\n  analyze:\n    directory: ~/drops/analyze\n    patterns: [\"*.txt\", \"*.md\", \"*.pdf\"]\n    agent: claude_analyze\n    events: [created]\n\n  images:\n    directory: ~/drops/images\n    patterns: [\"*.txt\"]  # Text file contains image prompts\n    agent: replicate_generate\n    events: [created]\n\n  data:\n    directory: ~/drops/data\n    patterns: [\"*.csv\", \"*.json\"]\n    agent: claude_data_analysis\n    events: [created]\n\nagents:\n  whisper_transcribe:\n    type: bash\n    command: |\n      whisper \"{file}\" --output_dir \"{output_dir}\" --output_format txt\n\n  claude_analyze:\n    type: claude\n    prompt_file: prompts/analyze.md\n    model: claude-3-5-sonnet-20241022\n\n  replicate_generate:\n    type: python\n    script: agents/image_gen.py\n\n  claude_data_analysis:\n    type: claude\n    prompt_file: prompts/data_analysis.md\n    model: claude-3-5-sonnet-20241022\n```\n\n### Step 2: The Core Watcher\n\nCreate `drop_watcher.py`:\n\n```python\n#!/usr/bin/env -S uv run\n# /// script\n# dependencies = [\n#   \"watchdog>=4.0.0\",\n#   \"pyyaml>=6.0\",\n#   \"rich>=13.0.0\",\n#   \"anthropic>=0.40.0\",\n# ]\n# ///\n\"\"\"\nDrop Zone Watcher - File-based AI automation\n\nUsage:\n    uv run drop_watcher.py [--config drops.yaml]\n\nWatches configured directories and triggers agents on file events.\n\"\"\"\n\nimport argparse\nimport fnmatch\nimport os\nimport shutil\nimport subprocess\nimport time\nfrom datetime import datetime\nfrom pathlib import Path\n\nimport yaml\nfrom anthropic import Anthropic\nfrom rich.console import Console\nfrom rich.panel import Panel\nfrom watchdog.events import FileSystemEventHandler\nfrom watchdog.observers import Observer\n\nconsole = Console()\n\nclass DropZoneHandler(FileSystemEventHandler):\n    def __init__(self, zone_name: str, zone_config: dict, global_config: dict):\n        self.zone_name = zone_name\n        self.zone_config = zone_config\n        self.global_config = global_config\n        self.patterns = zone_config.get(\"patterns\", [\"*\"])\n        self.agent_name = zone_config.get(\"agent\")\n        self.agent_config = global_config[\"agents\"].get(self.agent_name, {})\n\n    def on_created(self, event):\n        if event.is_directory:\n            return\n        if \"created\" not in self.zone_config.get(\"events\", [\"created\"]):\n            return\n        self._process_file(event.src_path)\n\n    def on_modified(self, event):\n        if event.is_directory:\n            return\n        if \"modified\" not in self.zone_config.get(\"events\", []):\n            return\n        self._process_file(event.src_path)\n\n    def _matches_pattern(self, filepath: str) -> bool:\n        filename = os.path.basename(filepath)\n        return any(fnmatch.fnmatch(filename, p) for p in self.patterns)\n\n    def _process_file(self, filepath: str):\n        if not self._matches_pattern(filepath):\n            return\n\n        # Wait for file to be fully written\n        time.sleep(0.5)\n\n        console.print(Panel(\n            f\"[bold green]Processing:[/] {filepath}\\n\"\n            f\"[bold blue]Zone:[/] {self.zone_name}\\n\"\n            f\"[bold yellow]Agent:[/] {self.agent_name}\",\n            title=\"Drop Detected\"\n        ))\n\n        try:\n            output_path = self._run_agent(filepath)\n            self._archive_file(filepath)\n            console.print(f\"[green]✓[/] Output: {output_path}\")\n        except Exception as e:\n            console.print(f\"[red]✗[/] Error: {e}\")\n\n    def _run_agent(self, filepath: str) -> str:\n        agent_type = self.agent_config.get(\"type\", \"bash\")\n        output_dir = self._get_output_dir()\n\n        if agent_type == \"bash\":\n            return self._run_bash_agent(filepath, output_dir)\n        elif agent_type == \"claude\":\n            return self._run_claude_agent(filepath, output_dir)\n        elif agent_type == \"python\":\n            return self._run_python_agent(filepath, output_dir)\n        else:\n            raise ValueError(f\"Unknown agent type: {agent_type}\")\n\n    def _run_bash_agent(self, filepath: str, output_dir: str) -> str:\n        command = self.agent_config[\"command\"].format(\n            file=filepath,\n            output_dir=output_dir\n        )\n        subprocess.run(command, shell=True, check=True)\n        return output_dir\n\n    def _run_claude_agent(self, filepath: str, output_dir: str) -> str:\n        prompt_file = self.agent_config.get(\"prompt_file\")\n        model = self.agent_config.get(\"model\", \"claude-3-5-sonnet-20241022\")\n\n        # Load prompt template\n        with open(prompt_file) as f:\n            prompt_template = f.read()\n\n        # Read input file\n        with open(filepath) as f:\n            content = f.read()\n\n        # Substitute variables\n        prompt = prompt_template.replace(\"{content}\", content)\n        prompt = prompt.replace(\"{filename}\", os.path.basename(filepath))\n\n        # Call Claude\n        client = Anthropic()\n        response = client.messages.create(\n            model=model,\n            max_tokens=4096,\n            messages=[{\"role\": \"user\", \"content\": prompt}]\n        )\n\n        result = response.content[0].text\n\n        # Write output\n        timestamp = datetime.now().strftime(\"%Y%m%d-%H%M%S\")\n        output_filename = f\"{timestamp}-{Path(filepath).stem}.md\"\n        output_path = os.path.join(output_dir, output_filename)\n\n        os.makedirs(output_dir, exist_ok=True)\n        with open(output_path, \"w\") as f:\n            f.write(result)\n\n        return output_path\n\n    def _run_python_agent(self, filepath: str, output_dir: str) -> str:\n        script = self.agent_config[\"script\"]\n        result = subprocess.run(\n            [\"uv\", \"run\", script, filepath, output_dir],\n            capture_output=True,\n            text=True,\n            check=True\n        )\n        return result.stdout.strip()\n\n    def _get_output_dir(self) -> str:\n        base = os.path.expanduser(self.global_config.get(\"output_dir\", \"~/output\"))\n        return os.path.join(base, self.zone_name)\n\n    def _archive_file(self, filepath: str):\n        archive_base = os.path.expanduser(\n            self.global_config.get(\"archive_dir\", \"~/archive\")\n        )\n        archive_dir = os.path.join(archive_base, self.zone_name)\n        os.makedirs(archive_dir, exist_ok=True)\n\n        timestamp = datetime.now().strftime(\"%Y%m%d-%H%M%S\")\n        filename = os.path.basename(filepath)\n        archive_path = os.path.join(archive_dir, f\"{timestamp}-{filename}\")\n\n        shutil.move(filepath, archive_path)\n\n\ndef load_config(config_path: str) -> dict:\n    with open(config_path) as f:\n        return yaml.safe_load(f)\n\n\ndef setup_watchers(config: dict) -> Observer:\n    observer = Observer()\n\n    for zone_name, zone_config in config.get(\"zones\", {}).items():\n        directory = os.path.expanduser(zone_config[\"directory\"])\n        os.makedirs(directory, exist_ok=True)\n\n        handler = DropZoneHandler(zone_name, zone_config, config)\n        observer.schedule(handler, directory, recursive=False)\n\n        console.print(f\"[blue]Watching:[/] {directory} → {zone_config['agent']}\")\n\n    return observer\n\n\ndef main():\n    parser = argparse.ArgumentParser(description=\"Drop Zone Watcher\")\n    parser.add_argument(\"--config\", default=\"drops.yaml\", help=\"Config file path\")\n    args = parser.parse_args()\n\n    config = load_config(args.config)\n\n    console.print(Panel(\n        \"[bold]Drop Zone Watcher[/]\\n\"\n        \"Drag files into watched directories to trigger AI agents.\",\n        title=\"Starting\"\n    ))\n\n    observer = setup_watchers(config)\n    observer.start()\n\n    try:\n        while True:\n            time.sleep(1)\n    except KeyboardInterrupt:\n        observer.stop()\n        console.print(\"[yellow]Shutting down...[/]\")\n\n    observer.join()\n\n\nif __name__ == \"__main__\":\n    main()\n```\n\n### Step 3: Agent Prompt Templates\n\nCreate `prompts/analyze.md`:\n\n```markdown\n# Document Analysis Agent\n\nAnalyze the following document and provide a structured summary.\n\n## Document Content\n\n{content}\n\n## Output Format\n\nProvide your analysis in this format:\n\n### Summary\nA 2-3 sentence overview of the document.\n\n### Key Points\n- Bullet point list of main ideas\n\n### Topics Covered\n- List of topics/themes\n\n### Action Items (if applicable)\n- Numbered list of action items\n\n### Questions Raised\n- Questions that arise from this content\n\n### Confidence\nHow confident are you in this analysis? (high/medium/low) and why.\n```\n\nCreate `prompts/data_analysis.md`:\n\n```markdown\n# Data Analysis Agent\n\nAnalyze the following data file and provide insights.\n\n## Data Content\n\n{content}\n\n## Filename\n{filename}\n\n## Analysis Required\n\n1. **Data Overview**\n   - File format (CSV, JSON, etc.)\n   - Number of records/rows\n   - Column/field names\n\n2. **Statistical Summary**\n   - For numeric columns: min, max, mean, median\n   - For categorical columns: unique values, distribution\n\n3. **Data Quality**\n   - Missing values\n   - Potential outliers\n   - Data type issues\n\n4. **Insights**\n   - Key patterns or trends\n   - Notable correlations\n   - Anomalies worth investigating\n\n5. **Recommendations**\n   - Suggested next steps for analysis\n   - Visualization recommendations\n   - Data cleaning suggestions\n```\n\n### Step 4: Image Generation Agent\n\nCreate `agents/image_gen.py`:\n\n```python\n#!/usr/bin/env -S uv run\n# /// script\n# dependencies = [\n#   \"replicate>=0.25.0\",\n#   \"requests>=2.31.0\",\n# ]\n# ///\n\"\"\"\nImage Generation Agent\n\nReads prompts from a text file and generates images using Replicate.\nEach line in the file is a separate prompt.\n\"\"\"\n\nimport os\nimport sys\nfrom datetime import datetime\nfrom pathlib import Path\n\nimport replicate\nimport requests\n\n\ndef generate_images(input_file: str, output_dir: str) -> list[str]:\n    \"\"\"Generate images from prompts in input file.\"\"\"\n    os.makedirs(output_dir, exist_ok=True)\n\n    with open(input_file) as f:\n        prompts = [line.strip() for line in f if line.strip()]\n\n    generated = []\n\n    for i, prompt in enumerate(prompts):\n        print(f\"Generating {i+1}/{len(prompts)}: {prompt[:50]}...\")\n\n        output = replicate.run(\n            \"stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b\",\n            input={\n                \"prompt\": prompt,\n                \"width\": 1024,\n                \"height\": 1024,\n            }\n        )\n\n        # Download the image\n        if output:\n            image_url = output[0]\n            response = requests.get(image_url)\n\n            timestamp = datetime.now().strftime(\"%Y%m%d-%H%M%S\")\n            safe_prompt = prompt[:30].replace(\" \", \"_\").replace(\"/\", \"-\")\n            filename = f\"{timestamp}-{i:03d}-{safe_prompt}.png\"\n            filepath = os.path.join(output_dir, filename)\n\n            with open(filepath, \"wb\") as f:\n                f.write(response.content)\n\n            generated.append(filepath)\n            print(f\"  Saved: {filepath}\")\n\n    return generated\n\n\nif __name__ == \"__main__\":\n    if len(sys.argv) \u003C 3:\n        print(\"Usage: uv run image_gen.py \u003Cinput_file> \u003Coutput_dir>\")\n        sys.exit(1)\n\n    input_file = sys.argv[1]\n    output_dir = sys.argv[2]\n\n    files = generate_images(input_file, output_dir)\n    print(f\"\\nGenerated {len(files)} images\")\n\n    # Return output path\n    print(output_dir)\n```\n\n## Data Flow: File Drop to Result\n\n```mermaid\nflowchart LR\n    subgraph Input\n        A[User drops file.txt]\n    end\n\n    subgraph Watcher\n        B[Watchdog detects create event]\n        C[Pattern matches *.txt]\n        D[Agent selected: claude_analyze]\n    end\n\n    subgraph Agent\n        E[Load prompt template]\n        F[Read file content]\n        G[Call Claude API]\n        H[Write result.md]\n    end\n\n    subgraph Cleanup\n        I[Archive original]\n        J[Log completion]\n    end\n\n    A --> B --> C --> D --> E --> F --> G --> H --> I --> J\n\n    style A fill:#e8f5e9\n    style H fill:#e3f2fd\n    style J fill:#fff3e0\n```\n\n## When Drop Zones Fail\n\nThe POC above works for clean, isolated files. Production breaks in predictable ways.\n\n### Files That Need Context\n\nA code file dropped into a review zone lacks its dependencies, imports, and surrounding architecture. The agent sees `import UserService from '../services'` but doesn't know what UserService does.\n\n**What breaks:** Reviews are shallow. \"This looks fine\" instead of \"This violates the retry policy established in commit abc123.\"\n\n**Fix:** Add a context builder. Before processing, scan the repository for related files:\n\n```python\ndef gather_context(filepath: str) -> dict:\n    \"\"\"Gather related files for context.\"\"\"\n    context = {\"main_file\": filepath}\n\n    # Parse imports\n    with open(filepath) as f:\n        content = f.read()\n        imports = extract_imports(content)  # Your parser here\n\n    # Find imported files\n    related = []\n    for imp in imports:\n        path = resolve_import(imp, filepath)\n        if path and os.path.exists(path):\n            with open(path) as f:\n                related.append({\"path\": path, \"content\": f.read()})\n\n    context[\"related_files\"] = related\n    return context\n```\n\nThis increases token usage 3-5x but improves accuracy significantly. For a 200-line Python file with 8 imports, you go from 800 tokens to 3,200 tokens. Cost per review goes from $0.02 to $0.08 with claude-3-5-sonnet-20241022.\n\n### Multi-File Inputs\n\nSometimes the task requires multiple files processed together. A blog post draft plus supporting research notes. Three screenshots that show a UI flow. CSV data plus its schema definition.\n\n**What breaks:** The watcher processes files individually. Drop three related screenshots, get three unconnected analyses instead of one coherent flow analysis.\n\n**Fix:** Add a staging area with batch processing:\n\n```yaml\n# In drops.yaml\nui_review:\n  directory: ~/drops/ui-review\n  patterns: [\"*.png\", \"*.jpg\"]\n  agent: ui_flow_analyzer\n  batch_mode: true\n  batch_window: 30  # seconds\n  batch_trigger: 3  # or N files\n```\n\nBuffer files for 30 seconds. If 3+ files arrive, process as a batch. If timeout hits with fewer files, process what you have.\n\n### Race Conditions: Incomplete Writes\n\nYou drop a 500MB video file. Watchdog fires on create. The agent starts processing while the file is still copying. Whisper transcribes 8 seconds of a 45-minute video.\n\n**What breaks:** Partial processing. Silent failures. Confusing output.\n\n**Fix:** Verify file stability before processing:\n\n```python\ndef wait_for_stable_file(filepath: str, timeout: int = 30) -> bool:\n    \"\"\"Wait until file size stops changing.\"\"\"\n    last_size = -1\n    stable_count = 0\n\n    for _ in range(timeout):\n        try:\n            current_size = os.path.getsize(filepath)\n            if current_size == last_size:\n                stable_count += 1\n                if stable_count >= 3:  # Stable for 3 seconds\n                    return True\n            else:\n                stable_count = 0\n            last_size = current_size\n        except OSError:\n            pass\n        time.sleep(1)\n\n    return False\n```\n\nReplace the POC's `time.sleep(0.5)` with this. A 500MB file takes 6-10 seconds to copy on typical hardware. Three-second stability window catches 99% of cases without excessive waiting.\n\n### Agent Failures Mid-Processing\n\nAPI rate limit hit. Network timeout. Model refuses the prompt due to content policy. The agent fails after archiving the input file but before writing output.\n\n**What breaks:** Input file is gone. No output exists. No way to retry. User thinks it worked because no error appeared.\n\n**Fix:** Transactional processing with rollback:\n\n```python\ndef _process_file(self, filepath: str):\n    if not self._matches_pattern(filepath):\n        return\n\n    # Create processing record\n    processing_id = self._start_processing(filepath)\n\n    try:\n        output_path = self._run_agent(filepath)\n        self._archive_file(filepath)\n        self._mark_complete(processing_id, output_path)\n        console.print(f\"[green]✓[/] Output: {output_path}\")\n    except Exception as e:\n        self._mark_failed(processing_id, str(e))\n        # Don't archive on failure - leave for retry\n        console.print(f\"[red]✗[/] Error: {e}\")\n        # Write error details to dead letter queue\n        self._write_to_dlq(filepath, processing_id, e)\n```\n\nKeep failed files in place. Log failures to a dead letter queue. Provide a manual retry command. For our use case running 200 files/day, we see 3-5 transient failures per day. All are recoverable with retry.\n\n### Token Limit Exceeded\n\nA 15,000-line CSV file hits the analyze zone. The agent tries to stuff it all into a prompt. Claude returns a 400 error: maximum context length exceeded.\n\n**What breaks:** Processing fails. File size limits aren't obvious. No graceful degradation.\n\n**Fix:** Add size checks and chunking strategy:\n\n```python\ndef _check_size_limits(self, filepath: str) -> tuple[bool, str]:\n    \"\"\"Check if file is processable.\"\"\"\n    file_size = os.path.getsize(filepath)\n    max_size = self.agent_config.get(\"max_file_size\", 10 * 1024 * 1024)  # 10MB default\n\n    if file_size > max_size:\n        return False, f\"File too large: {file_size} bytes (max: {max_size})\"\n\n    # For text files, estimate tokens\n    if filepath.endswith(('.txt', '.md', '.csv', '.json')):\n        with open(filepath) as f:\n            content = f.read()\n        estimated_tokens = len(content) // 4  # Rough estimate\n        max_tokens = self.agent_config.get(\"max_tokens\", 100000)\n\n        if estimated_tokens > max_tokens:\n            return False, f\"Content too large: ~{estimated_tokens} tokens (max: {max_tokens})\"\n\n    return True, \"OK\"\n```\n\nFor a 200K-token model, set max_tokens to 150K to leave room for prompts and output. Files that exceed limits go to a manual review folder with a clear error message.\n\n### Files Requiring Human Review\n\nSome automation needs a human checkpoint. Legal contract analysis that might inform business decisions. Code deployments to production. Financial data processing.\n\n**What breaks:** Full automation isn't always desirable. No way to inject human judgment. Liability concerns.\n\n**Fix:** Add an approval workflow:\n\n```yaml\ncontracts:\n  directory: ~/drops/contracts\n  patterns: [\"*.pdf\"]\n  agent: contract_analyzer\n  approval_required: true\n  approval_timeout: 3600  # 1 hour\n```\n\n```python\ndef _process_file(self, filepath: str):\n    output_path = self._run_agent(filepath)\n\n    if self.zone_config.get(\"approval_required\"):\n        approval_path = self._move_to_approval_queue(filepath, output_path)\n        console.print(f\"[yellow]⏸[/] Awaiting approval: {approval_path}\")\n        self._notify_approver(approval_path)\n        # Don't archive yet - wait for approval\n    else:\n        self._archive_file(filepath)\n```\n\nSet up an approval directory. Agent processes the file and moves it there with its output. Human reviews both. Approve by dropping in `~/approvals/accept/`, reject to `~/approvals/reject/`. A second watcher handles the approval directories.\n\n## Production Deployment Considerations\n\nPOC works on your laptop. Production needs operational rigor.\n\n### Monitoring and Alerting\n\n**The problem:** Silent failures. You think it's working. It's been down for three days.\n\n**What to track:**\n\n1. **Processing rate:** Files processed per hour\n2. **Failure rate:** Percentage of files that fail\n3. **Processing latency:** Time from drop to output\n4. **Queue depth:** Files waiting in drop zones\n5. **API health:** Response times and error rates\n\nInstrument the watcher:\n\n```python\nimport statsd  # Or your metrics library\n\nmetrics = statsd.StatsClient('localhost', 8125)\n\ndef _process_file(self, filepath: str):\n    start_time = time.time()\n\n    try:\n        output_path = self._run_agent(filepath)\n        self._archive_file(filepath)\n\n        # Record success\n        metrics.incr(f'dropzone.{self.zone_name}.success')\n        metrics.timing(f'dropzone.{self.zone_name}.duration',\n                      (time.time() - start_time) * 1000)\n    except Exception as e:\n        metrics.incr(f'dropzone.{self.zone_name}.failure')\n        raise\n```\n\nSet alerts:\n- Processing rate drops below 10 files/hour when average is 50/hour\n- Failure rate exceeds 10% over a 15-minute window\n- No files processed in 2 hours during business hours\n- Queue depth exceeds 100 files\n\nFor our production deployment handling 800 files/day, we get 1-2 actionable alerts per week. Most are transient API issues that self-resolve.\n\n### Logging and Audit Trails\n\nEvery file processed needs a record: who dropped it, when, what agent processed it, what the output was, any errors encountered.\n\n```python\nimport json\nimport logging\n\nlogging.basicConfig(\n    filename=os.path.expanduser(\"~/logs/dropzone.log\"),\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\n\ndef _process_file(self, filepath: str):\n    processing_record = {\n        \"timestamp\": datetime.now().isoformat(),\n        \"zone\": self.zone_name,\n        \"agent\": self.agent_name,\n        \"input_file\": filepath,\n        \"file_size\": os.path.getsize(filepath),\n        \"user\": os.environ.get(\"USER\"),\n    }\n\n    try:\n        output_path = self._run_agent(filepath)\n        processing_record[\"status\"] = \"success\"\n        processing_record[\"output_file\"] = output_path\n        processing_record[\"output_size\"] = os.path.getsize(output_path)\n    except Exception as e:\n        processing_record[\"status\"] = \"failure\"\n        processing_record[\"error\"] = str(e)\n        processing_record[\"error_type\"] = type(e).__name__\n    finally:\n        processing_record[\"duration_seconds\"] = time.time() - start_time\n        logging.info(json.dumps(processing_record))\n```\n\nLogs go to structured JSON for easy parsing. Ship to your log aggregation service. When a user asks \"did my file process?\", you have answers.\n\n### Resource Limits\n\n**CPU and Memory:** Watchdog is lightweight, but agents aren't. Whisper transcription spikes CPU to 100% for 30-60 seconds per file. Claude Code execution can use 2GB RAM.\n\nSet process limits:\n\n```python\nimport resource\n\ndef _run_agent(self, filepath: str) -> str:\n    # Limit memory to 4GB\n    resource.setrlimit(resource.RLIMIT_AS, (4 * 1024**3, 4 * 1024**3))\n\n    # Limit CPU time to 5 minutes\n    resource.setrlimit(resource.RLIMIT_CPU, (300, 300))\n\n    # Run agent...\n```\n\n**API Rate Limits:** Claude API: 50 requests/minute on tier 1, 5,000 requests/minute on tier 4. Replicate varies by model.\n\nAdd rate limiting:\n\n```python\nfrom time import time\nfrom collections import deque\n\nclass RateLimiter:\n    def __init__(self, max_requests: int, window_seconds: int):\n        self.max_requests = max_requests\n        self.window = window_seconds\n        self.requests = deque()\n\n    def acquire(self):\n        now = time()\n        # Remove old requests outside window\n        while self.requests and self.requests[0] \u003C now - self.window:\n            self.requests.popleft()\n\n        if len(self.requests) >= self.max_requests:\n            sleep_time = self.requests[0] + self.window - now\n            time.sleep(sleep_time)\n\n        self.requests.append(now)\n\n# In agent code\nrate_limiter = RateLimiter(max_requests=45, window_seconds=60)\n\ndef _run_claude_agent(self, filepath: str, output_dir: str) -> str:\n    rate_limiter.acquire()\n    # Call API...\n```\n\nLeave headroom. 45 requests/minute for a 50 req/min limit. Shared rate limiters if you have multiple services using the same API key.\n\n### Graceful Degradation\n\nAPIs go down. Networks fail. Disk fills up. Production systems need fallbacks.\n\n**When Claude API is unavailable:**\n\n```python\ndef _run_claude_agent(self, filepath: str, output_dir: str) -> str:\n    try:\n        # Normal Claude processing\n        return self._call_claude_api(filepath, output_dir)\n    except anthropic.APIConnectionError:\n        # Fallback to queue\n        return self._queue_for_retry(filepath)\n    except anthropic.RateLimitError:\n        # Back off and retry once\n        time.sleep(60)\n        return self._call_claude_api(filepath, output_dir)\n```\n\n**When disk space is low:**\n\n```python\ndef _check_disk_space(self) -> bool:\n    stat = os.statvfs(os.path.expanduser(\"~/output\"))\n    free_bytes = stat.f_bavail * stat.f_frsize\n    free_gb = free_bytes / (1024**3)\n\n    if free_gb \u003C 1.0:  # Less than 1GB free\n        console.print(\"[red]Low disk space![/] Pausing processing.\")\n        return False\n    return True\n```\n\nCheck before each file. Pause processing if disk is full. Alert on low space. For systems processing 50GB/day, check every 10 files and alert at 10GB free.\n\n### Security: Validating File Contents\n\nUsers drop files. Users are unpredictable. Protect your system.\n\n**File type validation:**\n\n```python\nimport magic  # python-magic library\n\ndef _validate_file(self, filepath: str) -> tuple[bool, str]:\n    # Check declared extension matches actual content\n    mime = magic.from_file(filepath, mime=True)\n\n    allowed_types = self.zone_config.get(\"allowed_mime_types\", [])\n    if allowed_types and mime not in allowed_types:\n        return False, f\"Invalid file type: {mime}\"\n\n    # Check for malicious content\n    if mime.startswith(\"application/x-executable\"):\n        return False, \"Executable files not allowed\"\n\n    return True, \"OK\"\n```\n\n**Content sanitization:**\n\n```python\ndef _sanitize_content(self, content: str) -> str:\n    # Remove potential injection attacks\n    content = content.replace(\"```python\", \"```text\")\n    content = content.replace(\"```bash\", \"```text\")\n\n    # Limit size\n    max_chars = 500000  # ~125K tokens\n    if len(content) > max_chars:\n        content = content[:max_chars] + \"\\n\\n[Content truncated]\"\n\n    return content\n```\n\nNever execute code from dropped files directly. Treat all input as untrusted. Validate, sanitize, then process.\n\n## The Automation Decision Framework\n\nNot every task deserves automation. Use specific thresholds.\n\n| Frequency | ROI Threshold | Action |\n|-----------|---------------|--------|\n| Once | N/A | Use chat |\n| 2-5x/month | > 5 min saved | Maybe automate |\n| Weekly | > 2 min saved | Consider zone |\n| Daily | > 30 sec saved | Build zone |\n| 10+ times/day | Any time saved | Definitely zone |\n\n| Complexity | Time to Build | Approach |\n|------------|---------------|----------|\n| Single step | 5 minutes | Bash agent |\n| Multi-step | 30 minutes | Python agent |\n| AI reasoning | 15 minutes | Claude agent |\n| Mixed flow | 1-2 hours | Chain agents |\n| Needs approval | 2-3 hours | Approval workflow |\n\n| Risk Level | Requirements | Safety |\n|------------|--------------|--------|\n| Low | None | Full auto |\n| Medium | Logging | Auto + audit |\n| High | Review | Approval required |\n| Critical | Sign-off | Manual only |\n\n**Real numbers from our deployment:**\n- Morning meeting transcription: 10x/week, saves 15 min/day, ROI: 2.5 hours/week\n- Code review: 30x/week, saves 3 min each, ROI: 1.5 hours/week\n- Data analysis: 5x/week, saves 20 min each, ROI: 1.7 hours/week\n- Legal contract review: 2x/month, approval required, ROI: 40 min/month\n\nTotal time saved: 22 hours/month. Setup time: 8 hours. Break-even in 2 weeks.\n\n## Agent Opportunity: Build Your Drop Zone Library\n\nStart with these high-value zones:\n\n### Morning Debrief Zone\n\n```yaml\n# In drops.yaml\nmorning_debrief:\n  directory: ~/drops/debrief\n  patterns: [\"*.m4a\", \"*.mp3\", \"*.wav\"]\n  agent: debrief_processor\n  events: [created]\n\nagents:\n  debrief_processor:\n    type: bash\n    command: |\n      # Transcribe\n      whisper \"{file}\" -o /tmp --output_format txt\n\n      # Extract filename for transcript\n      BASENAME=$(basename \"{file}\" | sed 's/\\.[^.]*$//')\n\n      # Process with Claude\n      cat /tmp/$BASENAME.txt | claude --prompt \"$(cat prompts/debrief.md)\" > \"{output_dir}/$BASENAME-insights.md\"\n```\n\n### Code Review Zone\n\n```yaml\ncode_review:\n  directory: ~/drops/review\n  patterns: [\"*.py\", \"*.ts\", \"*.js\", \"*.go\"]\n  agent: code_review\n  events: [created]\n\nagents:\n  code_review:\n    type: claude\n    prompt_file: prompts/code_review.md\n    model: claude-sonnet-4-20250514\n```\n\n### Research Paper Zone\n\n```yaml\nresearch:\n  directory: ~/drops/papers\n  patterns: [\"*.pdf\"]\n  agent: paper_summarize\n  events: [created]\n\nagents:\n  paper_summarize:\n    type: python\n    script: agents/paper_processor.py\n```\n\n## Running the System\n\n```bash\n# Create the directory structure\nmkdir -p ~/drops/{transcribe,analyze,images,data}\nmkdir -p ~/output ~/archive ~/logs\nmkdir -p prompts agents\n\n# Start the watcher\nuv run drop_watcher.py --config drops.yaml\n\n# In another terminal, test it:\necho \"Write a blog post about AI automation\" > ~/drops/analyze/test.txt\n\n# Check output\nls ~/output/analyze/\ncat ~/output/analyze/*.md\n```\n\n## The Key Insight\n\n**Repeat workflows benefit most from automation.**\n\nThe first time you do something, chat is fine. The tenth time, you should have a drop zone.\n\nDirectory watchers work because they match how you already work. You already organize files into folders. You already drag and drop. The interface is invisible.\n\nThey're called agents for a reason. They're capable of agency. Lean into the autonomy.\n\n---\n\n**Key Takeaways:**\n- Directory watchers turn the file system into an AI interface with zero learning curve\n- YAML config makes adding new zones a 5-minute task\n- Pattern matching routes files to appropriate agents automatically\n- Production requires monitoring, logging, rate limiting, and error handling\n- Failure modes are predictable: context gaps, race conditions, size limits, approval needs\n- ROI threshold: anything you do 10+ times/week that takes more than 30 seconds\n- Start with your highest-frequency task and expand from there\n\n**Try It Now:**\nCopy `drop_watcher.py` and `drops.yaml` above. Create the directory structure. Start the watcher. Drop a text file into `~/drops/analyze/`. Watch it process automatically and check `~/output/analyze/` for results.","src/content/blog/directory-watchers.md","ace24d794862ba90",{"html":401,"metadata":402},"\u003Cp>Directory watchers turn your file system into an AI interface.\u003C/p>\n\u003Cp>Drag a file into a folder. An agent processes it automatically. You get results. No chat. No prompting. No human-in-the-loop.\u003C/p>\n\u003Cp>This post shows you how to build a complete drop zone system with working Python code, then walks through what breaks in production and how to fix it.\u003C/p>\n\u003Ch2 id=\"the-architecture\">The Architecture\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart TB\n    subgraph DROPS[\"~/drops/\"]\n        D1[\"transcribe/\"] --> W1[\"Whisper → text\"]\n        D2[\"analyze/\"] --> W2[\"Claude → summary\"]\n        D3[\"images/\"] --> W3[\"Replicate → generations\"]\n        D4[\"data/\"] --> W4[\"Claude → analysis\"]\n    end\n\n    subgraph WATCHER[\"DIRECTORY WATCHER\"]\n        E1[watchdog events] --> E2[Pattern Match] --> E3[Agent Execute]\n    end\n\n    DROPS --> WATCHER\n\n    subgraph OUTPUT[\"OUTPUTS\"]\n        O1[\"~/output/{zone}/{timestamp}-{filename}.{result}\"]\n        O2[\"~/archive/{zone}/{timestamp}-{filename}.{original}\"]\n    end\n\n    WATCHER --> OUTPUT\n\n    style DROPS fill:#e3f2fd\n    style WATCHER fill:#fff3e0\n    style OUTPUT fill:#c8e6c9\n\u003C/pre>\n\u003Ch2 id=\"poc-complete-drop-zone-system\">POC: Complete Drop Zone System\u003C/h2>\n\u003Ch3 id=\"step-1-configuration-file\">Step 1: Configuration File\u003C/h3>\n\u003Cp>Create \u003Ccode>drops.yaml\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Drop Zone Configuration\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Each zone watches a directory and triggers an agent on file events\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">output_dir\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/output\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">archive_dir\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/archive\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">log_dir\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/logs\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">zones\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  transcribe\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/transcribe\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.mp3\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.wav\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.m4a\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.webm\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">whisper_transcribe\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  analyze\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/analyze\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.txt\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.md\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude_analyze\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  images\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/images\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.txt\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Text file contains image prompts\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">replicate_generate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  data\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/data\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.csv\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.json\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude_data_analysis\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">agents\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  whisper_transcribe\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">bash\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    command\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">|\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      whisper \"{file}\" --output_dir \"{output_dir}\" --output_format txt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  claude_analyze\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    prompt_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">prompts/analyze.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    model\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude-3-5-sonnet-20241022\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  replicate_generate\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">python\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    script\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">agents/image_gen.py\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  claude_data_analysis\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    prompt_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">prompts/data_analysis.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    model\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude-3-5-sonnet-20241022\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-2-the-core-watcher\">Step 2: The Core Watcher\u003C/h3>\n\u003Cp>Create \u003Ccode>drop_watcher.py\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#!/usr/bin/env -S uv run\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># /// script\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># dependencies = [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"watchdog>=4.0.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"pyyaml>=6.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"rich>=13.0.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"anthropic>=0.40.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ///\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Drop Zone Watcher - File-based AI automation\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Usage:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    uv run drop_watcher.py [--config drops.yaml]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Watches configured directories and triggers agents on file events.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> argparse\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> fnmatch\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> shutil\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> subprocess\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pathlib \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> anthropic \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rich.console \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Console\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> rich.panel \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Panel\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> watchdog.events \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> FileSystemEventHandler\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> watchdog.observers \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Observer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">console \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Console()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">class\u003C/span>\u003Cspan style=\"color:#B392F0\"> DropZoneHandler\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#B392F0\">FileSystemEventHandler\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __init__\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, zone_name: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, zone_config: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, global_config: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> zone_name\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_config \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> zone_config\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.global_config \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> global_config\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.patterns \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> zone_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"patterns\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_name \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> zone_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"agent\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> global_config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"agents\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].get(\u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_name, {})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> on_created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, event):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.is_directory:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"created\"\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"events\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"created\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._process_file(event.src_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> on_modified\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, event):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> event.is_directory:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"modified\"\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"events\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, []):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._process_file(event.src_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _matches_pattern\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        filename \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.basename(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> any\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(fnmatch.fnmatch(filename, p) \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> p \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.patterns)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _process_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._matches_pattern(filepath):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Wait for file to be fully written\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">0.5\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(Panel(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[bold green]Processing:[/] \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">filepath\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[bold blue]Zone:[/] \u003C/span>\u003Cspan style=\"color:#79B8FF\">{self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[bold yellow]Agent:[/] \u003C/span>\u003Cspan style=\"color:#79B8FF\">{self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_name\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            title\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Drop Detected\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        ))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_agent(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">            self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._archive_file(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.print(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[green]✓[/] Output: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">output_path\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            console.print(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[red]✗[/] Error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        agent_type \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"bash\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output_dir \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._get_output_dir()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> agent_type \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"bash\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_bash_agent(filepath, output_dir)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> agent_type \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"claude\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_claude_agent(filepath, output_dir)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        elif\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> agent_type \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"python\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_python_agent(filepath, output_dir)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            raise\u003C/span>\u003Cspan style=\"color:#79B8FF\"> ValueError\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Unknown agent type: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">agent_type\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_bash_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        command \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"command\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].format(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            file\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">filepath,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            output_dir\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">output_dir\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        subprocess.run(command, \u003C/span>\u003Cspan style=\"color:#FFAB70\">shell\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">check\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> output_dir\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_claude_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        prompt_file \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"prompt_file\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        model \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"model\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"claude-3-5-sonnet-20241022\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Load prompt template\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(prompt_file) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            prompt_template \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f.read()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Read input file\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(filepath) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            content \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f.read()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Substitute variables\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> prompt_template.replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{content}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, content)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> prompt.replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{filename}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, os.path.basename(filepath))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Call Claude\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        client \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anthropic()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> client.messages.create(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            model\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">model,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            max_tokens\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">4096\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            messages\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">[{\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"role\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"user\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: prompt}]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> response.content[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].text\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Write output\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        timestamp \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime.now().strftime(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"%Y%m\u003C/span>\u003Cspan style=\"color:#79B8FF\">%d\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-%H%M%S\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output_filename \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">timestamp\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">Path(filepath).stem\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.md\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.join(output_dir, output_filename)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        os.makedirs(output_dir, \u003C/span>\u003Cspan style=\"color:#FFAB70\">exist_ok\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(output_path, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"w\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            f.write(result)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> output_path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_python_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        script \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"script\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        result \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> subprocess.run(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"uv\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"run\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, script, filepath, output_dir],\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            capture_output\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            text\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            check\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> result.stdout.strip()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _get_output_dir\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        base \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.expanduser(\u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.global_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"output_dir\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"~/output\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.join(base, \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _archive_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        archive_base \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.expanduser(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">            self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.global_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"archive_dir\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"~/archive\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        archive_dir \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.join(archive_base, \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        os.makedirs(archive_dir, \u003C/span>\u003Cspan style=\"color:#FFAB70\">exist_ok\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        timestamp \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime.now().strftime(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"%Y%m\u003C/span>\u003Cspan style=\"color:#79B8FF\">%d\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-%H%M%S\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        filename \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.basename(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        archive_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.join(archive_dir, \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">timestamp\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">filename\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        shutil.move(filepath, archive_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> load_config\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(config_path: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(config_path) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> yaml.safe_load(f)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> setup_watchers\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(config: \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> Observer:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    observer \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Observer()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> zone_name, zone_config \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"zones\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, {}).items():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        directory \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.expanduser(zone_config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"directory\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        os.makedirs(directory, \u003C/span>\u003Cspan style=\"color:#FFAB70\">exist_ok\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        handler \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> DropZoneHandler(zone_name, zone_config, config)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        observer.schedule(handler, directory, \u003C/span>\u003Cspan style=\"color:#FFAB70\">recursive\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[blue]Watching:[/] \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">directory\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> → \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">zone_config[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'agent'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> observer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> main\u003C/span>\u003Cspan style=\"color:#E1E4E8\">():\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> argparse.ArgumentParser(\u003C/span>\u003Cspan style=\"color:#FFAB70\">description\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Drop Zone Watcher\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    parser.add_argument(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"--config\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">default\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"drops.yaml\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">help\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Config file path\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    args \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> parser.parse_args()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    config \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> load_config(args.config)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    console.print(Panel(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"[bold]Drop Zone Watcher[/]\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"Drag files into watched directories to trigger AI agents.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">        title\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Starting\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    ))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    observer \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> setup_watchers(config)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    observer.start()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        while\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> KeyboardInterrupt\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        observer.stop()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[yellow]Shutting down...[/]\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    observer.join()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __name__\u003C/span>\u003Cspan style=\"color:#F97583\"> ==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"__main__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    main()\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-3-agent-prompt-templates\">Step 3: Agent Prompt Templates\u003C/h3>\n\u003Cp>Create \u003Ccode>prompts/analyze.md\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Document Analysis Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Analyze the following document and provide a structured summary.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Document Content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{content}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Output Format\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Provide your analysis in this format:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">### Summary\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">A 2-3 sentence overview of the document.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">### Key Points\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Bullet point list of main ideas\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">### Topics Covered\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> List of topics/themes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">### Action Items (if applicable)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Numbered list of action items\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">### Questions Raised\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Questions that arise from this content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">### Confidence\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">How confident are you in this analysis? (high/medium/low) and why.\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Create \u003Ccode>prompts/data_analysis.md\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"markdown\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\"># Data Analysis Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">Analyze the following data file and provide insights.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Data Content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{content}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Filename\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">{filename}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF;font-weight:bold\">## Analysis Required\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">1.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Data Overview**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> File format (CSV, JSON, etc.)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Number of records/rows\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Column/field names\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">2.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Statistical Summary**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> For numeric columns: min, max, mean, median\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> For categorical columns: unique values, distribution\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">3.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Data Quality**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Missing values\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Potential outliers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Data type issues\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">4.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Insights**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Key patterns or trends\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Notable correlations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Anomalies worth investigating\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">5.\u003C/span>\u003Cspan style=\"color:#E1E4E8;font-weight:bold\"> **Recommendations**\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Suggested next steps for analysis\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Visualization recommendations\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">   -\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Data cleaning suggestions\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"step-4-image-generation-agent\">Step 4: Image Generation Agent\u003C/h3>\n\u003Cp>Create \u003Ccode>agents/image_gen.py\u003C/code>:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#!/usr/bin/env -S uv run\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># /// script\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># dependencies = [\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"replicate>=0.25.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">#   \"requests>=2.31.0\",\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># ///\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Image Generation Agent\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Reads prompts from a text file and generates images using Replicate.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">Each line in the file is a separate prompt.\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sys\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> pathlib \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> Path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> replicate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> generate_images\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(input_file: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> list[\u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"Generate images from prompts in input file.\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    os.makedirs(output_dir, \u003C/span>\u003Cspan style=\"color:#FFAB70\">exist_ok\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(input_file) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        prompts \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> [line.strip() \u003C/span>\u003Cspan style=\"color:#F97583\">for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f \u003C/span>\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> line.strip()]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    generated \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> i, prompt \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> enumerate\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(prompts):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Generating \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i\u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\">1}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">/\u003C/span>\u003Cspan style=\"color:#79B8FF\">{len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(prompts)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">prompt[:\u003C/span>\u003Cspan style=\"color:#79B8FF\">50\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">...\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> replicate.run(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">            \"stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">            input\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">{\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"prompt\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: prompt,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"width\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">                \"height\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">1024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        )\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Download the image\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> output:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            image_url \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> output[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            response \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> requests.get(image_url)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            timestamp \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> datetime.now().strftime(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"%Y%m\u003C/span>\u003Cspan style=\"color:#79B8FF\">%d\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-%H%M%S\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            safe_prompt \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> prompt[:\u003C/span>\u003Cspan style=\"color:#79B8FF\">30\u003C/span>\u003Cspan style=\"color:#E1E4E8\">].replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\" \"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"_\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">).replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"/\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"-\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            filename \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">timestamp\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">i\u003C/span>\u003Cspan style=\"color:#F97583\">:03d\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">safe_prompt\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.png\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            filepath \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.join(output_dir, filename)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(filepath, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"wb\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                f.write(response.content)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            generated.append(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">            print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"  Saved: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">filepath\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generated\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __name__\u003C/span>\u003Cspan style=\"color:#F97583\"> ==\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"__main__\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(sys.argv) \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Usage: uv run image_gen.py &#x3C;input_file> &#x3C;output_dir>\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        sys.exit(\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    input_file \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sys.argv[\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    output_dir \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> sys.argv[\u003C/span>\u003Cspan style=\"color:#79B8FF\">2\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    files \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> generate_images(input_file, output_dir)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">Generated \u003C/span>\u003Cspan style=\"color:#79B8FF\">{len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(files)\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> images\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Return output path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">    print\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(output_dir)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"data-flow-file-drop-to-result\">Data Flow: File Drop to Result\u003C/h2>\n\u003Cpre class=\"mermaid\">flowchart LR\n    subgraph Input\n        A[User drops file.txt]\n    end\n\n    subgraph Watcher\n        B[Watchdog detects create event]\n        C[Pattern matches *.txt]\n        D[Agent selected: claude_analyze]\n    end\n\n    subgraph Agent\n        E[Load prompt template]\n        F[Read file content]\n        G[Call Claude API]\n        H[Write result.md]\n    end\n\n    subgraph Cleanup\n        I[Archive original]\n        J[Log completion]\n    end\n\n    A --> B --> C --> D --> E --> F --> G --> H --> I --> J\n\n    style A fill:#e8f5e9\n    style H fill:#e3f2fd\n    style J fill:#fff3e0\n\u003C/pre>\n\u003Ch2 id=\"when-drop-zones-fail\">When Drop Zones Fail\u003C/h2>\n\u003Cp>The POC above works for clean, isolated files. Production breaks in predictable ways.\u003C/p>\n\u003Ch3 id=\"files-that-need-context\">Files That Need Context\u003C/h3>\n\u003Cp>A code file dropped into a review zone lacks its dependencies, imports, and surrounding architecture. The agent sees \u003Ccode>import UserService from '../services'\u003C/code> but doesn’t know what UserService does.\u003C/p>\n\u003Cp>\u003Cstrong>What breaks:\u003C/strong> Reviews are shallow. “This looks fine” instead of “This violates the retry policy established in commit abc123.”\u003C/p>\n\u003Cp>\u003Cstrong>Fix:\u003C/strong> Add a context builder. Before processing, scan the repository for related files:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> gather_context\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">dict\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"Gather related files for context.\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    context \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"main_file\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: filepath}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Parse imports\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(filepath) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        content \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f.read()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        imports \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> extract_imports(content)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Your parser here\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Find imported files\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    related \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> []\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> imp \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> imports:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> resolve_import(imp, filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> path \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.exists(path):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(path) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                related.append({\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"path\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: path, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"content\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: f.read()})\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    context[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"related_files\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> related\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> context\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>This increases token usage 3-5x but improves accuracy significantly. For a 200-line Python file with 8 imports, you go from 800 tokens to 3,200 tokens. Cost per review goes from $0.02 to $0.08 with claude-3-5-sonnet-20241022.\u003C/p>\n\u003Ch3 id=\"multi-file-inputs\">Multi-File Inputs\u003C/h3>\n\u003Cp>Sometimes the task requires multiple files processed together. A blog post draft plus supporting research notes. Three screenshots that show a UI flow. CSV data plus its schema definition.\u003C/p>\n\u003Cp>\u003Cstrong>What breaks:\u003C/strong> The watcher processes files individually. Drop three related screenshots, get three unconnected analyses instead of one coherent flow analysis.\u003C/p>\n\u003Cp>\u003Cstrong>Fix:\u003C/strong> Add a staging area with batch processing:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># In drops.yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">ui_review\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/ui-review\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.png\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.jpg\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">ui_flow_analyzer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  batch_mode\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  batch_window\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">30\u003C/span>\u003Cspan style=\"color:#6A737D\">  # seconds\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  batch_trigger\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#6A737D\">  # or N files\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Buffer files for 30 seconds. If 3+ files arrive, process as a batch. If timeout hits with fewer files, process what you have.\u003C/p>\n\u003Ch3 id=\"race-conditions-incomplete-writes\">Race Conditions: Incomplete Writes\u003C/h3>\n\u003Cp>You drop a 500MB video file. Watchdog fires on create. The agent starts processing while the file is still copying. Whisper transcribes 8 seconds of a 45-minute video.\u003C/p>\n\u003Cp>\u003Cstrong>What breaks:\u003C/strong> Partial processing. Silent failures. Confusing output.\u003C/p>\n\u003Cp>\u003Cstrong>Fix:\u003C/strong> Verify file stability before processing:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> wait_for_stable_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, timeout: \u003C/span>\u003Cspan style=\"color:#79B8FF\">int\u003C/span>\u003Cspan style=\"color:#F97583\"> =\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 30\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"Wait until file size stops changing.\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    last_size \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#F97583\"> -\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    stable_count \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    for\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> _ \u003C/span>\u003Cspan style=\"color:#F97583\">in\u003C/span>\u003Cspan style=\"color:#79B8FF\"> range\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(timeout):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            current_size \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.getsize(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> current_size \u003C/span>\u003Cspan style=\"color:#F97583\">==\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> last_size:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                stable_count \u003C/span>\u003Cspan style=\"color:#F97583\">+=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> stable_count \u003C/span>\u003Cspan style=\"color:#F97583\">>=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Stable for 3 seconds\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">                    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                stable_count \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 0\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            last_size \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> current_size\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> OSError\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            pass\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">1\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Replace the POC’s \u003Ccode>time.sleep(0.5)\u003C/code> with this. A 500MB file takes 6-10 seconds to copy on typical hardware. Three-second stability window catches 99% of cases without excessive waiting.\u003C/p>\n\u003Ch3 id=\"agent-failures-mid-processing\">Agent Failures Mid-Processing\u003C/h3>\n\u003Cp>API rate limit hit. Network timeout. Model refuses the prompt due to content policy. The agent fails after archiving the input file but before writing output.\u003C/p>\n\u003Cp>\u003Cstrong>What breaks:\u003C/strong> Input file is gone. No output exists. No way to retry. User thinks it worked because no error appeared.\u003C/p>\n\u003Cp>\u003Cstrong>Fix:\u003C/strong> Transactional processing with rollback:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _process_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#F97583\"> not\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._matches_pattern(filepath):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Create processing record\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    processing_id \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._start_processing(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_agent(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._archive_file(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._mark_complete(processing_id, output_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[green]✓[/] Output: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">output_path\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._mark_failed(processing_id, \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(e))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Don't archive on failure - leave for retry\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[red]✗[/] Error: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">e\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Write error details to dead letter queue\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._write_to_dlq(filepath, processing_id, e)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Keep failed files in place. Log failures to a dead letter queue. Provide a manual retry command. For our use case running 200 files/day, we see 3-5 transient failures per day. All are recoverable with retry.\u003C/p>\n\u003Ch3 id=\"token-limit-exceeded\">Token Limit Exceeded\u003C/h3>\n\u003Cp>A 15,000-line CSV file hits the analyze zone. The agent tries to stuff it all into a prompt. Claude returns a 400 error: maximum context length exceeded.\u003C/p>\n\u003Cp>\u003Cstrong>What breaks:\u003C/strong> Processing fails. File size limits aren’t obvious. No graceful degradation.\u003C/p>\n\u003Cp>\u003Cstrong>Fix:\u003C/strong> Add size checks and chunking strategy:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _check_size_limits\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> tuple[\u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">    \"\"\"Check if file is processable.\"\"\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    file_size \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.getsize(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    max_size \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"max_file_size\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">10\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1024\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1024\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)  \u003C/span>\u003Cspan style=\"color:#6A737D\"># 10MB default\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> file_size \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> max_size:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"File too large: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">file_size\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> bytes (max: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">max_size\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">)\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # For text files, estimate tokens\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> filepath.endswith((\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'.txt'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'.md'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'.csv'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">'.json'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        with\u003C/span>\u003Cspan style=\"color:#79B8FF\"> open\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(filepath) \u003C/span>\u003Cspan style=\"color:#F97583\">as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            content \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> f.read()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        estimated_tokens \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(content) \u003C/span>\u003Cspan style=\"color:#F97583\">//\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 4\u003C/span>\u003Cspan style=\"color:#6A737D\">  # Rough estimate\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        max_tokens \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"max_tokens\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">100000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> estimated_tokens \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> max_tokens:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">            return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Content too large: ~\u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">estimated_tokens\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> tokens (max: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">max_tokens\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">)\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"OK\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>For a 200K-token model, set max_tokens to 150K to leave room for prompts and output. Files that exceed limits go to a manual review folder with a clear error message.\u003C/p>\n\u003Ch3 id=\"files-requiring-human-review\">Files Requiring Human Review\u003C/h3>\n\u003Cp>Some automation needs a human checkpoint. Legal contract analysis that might inform business decisions. Code deployments to production. Financial data processing.\u003C/p>\n\u003Cp>\u003Cstrong>What breaks:\u003C/strong> Full automation isn’t always desirable. No way to inject human judgment. Liability concerns.\u003C/p>\n\u003Cp>\u003Cstrong>Fix:\u003C/strong> Add an approval workflow:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">contracts\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/contracts\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">contract_analyzer\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  approval_required\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">true\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  approval_timeout\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">3600\u003C/span>\u003Cspan style=\"color:#6A737D\">  # 1 hour\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _process_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_agent(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"approval_required\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        approval_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._move_to_approval_queue(filepath, output_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[yellow]⏸[/] Awaiting approval: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">approval_path\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._notify_approver(approval_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Don't archive yet - wait for approval\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    else\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._archive_file(filepath)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Set up an approval directory. Agent processes the file and moves it there with its output. Human reviews both. Approve by dropping in \u003Ccode>~/approvals/accept/\u003C/code>, reject to \u003Ccode>~/approvals/reject/\u003C/code>. A second watcher handles the approval directories.\u003C/p>\n\u003Ch2 id=\"production-deployment-considerations\">Production Deployment Considerations\u003C/h2>\n\u003Cp>POC works on your laptop. Production needs operational rigor.\u003C/p>\n\u003Ch3 id=\"monitoring-and-alerting\">Monitoring and Alerting\u003C/h3>\n\u003Cp>\u003Cstrong>The problem:\u003C/strong> Silent failures. You think it’s working. It’s been down for three days.\u003C/p>\n\u003Cp>\u003Cstrong>What to track:\u003C/strong>\u003C/p>\n\u003Col>\n\u003Cli>\u003Cstrong>Processing rate:\u003C/strong> Files processed per hour\u003C/li>\n\u003Cli>\u003Cstrong>Failure rate:\u003C/strong> Percentage of files that fail\u003C/li>\n\u003Cli>\u003Cstrong>Processing latency:\u003C/strong> Time from drop to output\u003C/li>\n\u003Cli>\u003Cstrong>Queue depth:\u003C/strong> Files waiting in drop zones\u003C/li>\n\u003Cli>\u003Cstrong>API health:\u003C/strong> Response times and error rates\u003C/li>\n\u003C/ol>\n\u003Cp>Instrument the watcher:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> statsd  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Or your metrics library\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">metrics \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> statsd.StatsClient(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'localhost'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">8125\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _process_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    start_time \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time.time()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_agent(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._archive_file(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Record success\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        metrics.incr(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dropzone.\u003C/span>\u003Cspan style=\"color:#79B8FF\">{self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.success'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        metrics.timing(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dropzone.\u003C/span>\u003Cspan style=\"color:#79B8FF\">{self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.duration'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">                      (time.time() \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> start_time) \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1000\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        metrics.incr(\u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'dropzone.\u003C/span>\u003Cspan style=\"color:#79B8FF\">{self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.failure'\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        raise\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Set alerts:\u003C/p>\n\u003Cul>\n\u003Cli>Processing rate drops below 10 files/hour when average is 50/hour\u003C/li>\n\u003Cli>Failure rate exceeds 10% over a 15-minute window\u003C/li>\n\u003Cli>No files processed in 2 hours during business hours\u003C/li>\n\u003Cli>Queue depth exceeds 100 files\u003C/li>\n\u003C/ul>\n\u003Cp>For our production deployment handling 800 files/day, we get 1-2 actionable alerts per week. Most are transient API issues that self-resolve.\u003C/p>\n\u003Ch3 id=\"logging-and-audit-trails\">Logging and Audit Trails\u003C/h3>\n\u003Cp>Every file processed needs a record: who dropped it, when, what agent processed it, what the output was, any errors encountered.\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> json\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> logging\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">logging.basicConfig(\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    filename\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">os.path.expanduser(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"~/logs/dropzone.log\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    level\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\">logging.\u003C/span>\u003Cspan style=\"color:#79B8FF\">INFO\u003C/span>\u003Cspan style=\"color:#E1E4E8\">,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#FFAB70\">    format\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003Cspan style=\"color:#79B8FF\">%(asctime)s\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> - \u003C/span>\u003Cspan style=\"color:#79B8FF\">%(name)s\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> - \u003C/span>\u003Cspan style=\"color:#79B8FF\">%(levelname)s\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> - \u003C/span>\u003Cspan style=\"color:#79B8FF\">%(message)s\u003C/span>\u003Cspan style=\"color:#9ECBFF\">'\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _process_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    processing_record \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> {\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"timestamp\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: datetime.now().isoformat(),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"zone\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_name,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"agent\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.agent_name,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"input_file\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: filepath,\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"file_size\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: os.path.getsize(filepath),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">        \"user\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: os.environ.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"USER\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">),\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    }\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        output_path \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._run_agent(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"status\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"success\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"output_file\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> output_path\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"output_size\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.path.getsize(output_path)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#79B8FF\"> Exception\u003C/span>\u003Cspan style=\"color:#F97583\"> as\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> e:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"status\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"failure\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"error\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(e)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"error_type\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(e).\u003C/span>\u003Cspan style=\"color:#79B8FF\">__name__\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    finally\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        processing_record[\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"duration_seconds\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time.time() \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> start_time\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        logging.info(json.dumps(processing_record))\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Logs go to structured JSON for easy parsing. Ship to your log aggregation service. When a user asks “did my file process?”, you have answers.\u003C/p>\n\u003Ch3 id=\"resource-limits\">Resource Limits\u003C/h3>\n\u003Cp>\u003Cstrong>CPU and Memory:\u003C/strong> Watchdog is lightweight, but agents aren’t. Whisper transcription spikes CPU to 100% for 30-60 seconds per file. Claude Code execution can use 2GB RAM.\u003C/p>\n\u003Cp>Set process limits:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> resource\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Limit memory to 4GB\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    resource.setrlimit(resource.\u003C/span>\u003Cspan style=\"color:#79B8FF\">RLIMIT_AS\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1024\u003C/span>\u003Cspan style=\"color:#F97583\">**\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">4\u003C/span>\u003Cspan style=\"color:#F97583\"> *\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1024\u003C/span>\u003Cspan style=\"color:#F97583\">**\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Limit CPU time to 5 minutes\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    resource.setrlimit(resource.\u003C/span>\u003Cspan style=\"color:#79B8FF\">RLIMIT_CPU\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, (\u003C/span>\u003Cspan style=\"color:#79B8FF\">300\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">300\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Run agent...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>API Rate Limits:\u003C/strong> Claude API: 50 requests/minute on tier 1, 5,000 requests/minute on tier 4. Replicate varies by model.\u003C/p>\n\u003Cp>Add rate limiting:\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">from\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> collections \u003C/span>\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> deque\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">class\u003C/span>\u003Cspan style=\"color:#B392F0\"> RateLimiter\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#79B8FF\"> __init__\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, max_requests: \u003C/span>\u003Cspan style=\"color:#79B8FF\">int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, window_seconds: \u003C/span>\u003Cspan style=\"color:#79B8FF\">int\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.max_requests \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> max_requests\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.window \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> window_seconds\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> deque()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    def\u003C/span>\u003Cspan style=\"color:#B392F0\"> acquire\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        now \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> time()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Remove old requests outside window\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        while\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> now \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.window:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">            self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests.popleft()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(\u003C/span>\u003Cspan style=\"color:#79B8FF\">self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests) \u003C/span>\u003Cspan style=\"color:#F97583\">>=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.max_requests:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            sleep_time \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests[\u003C/span>\u003Cspan style=\"color:#79B8FF\">0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.window \u003C/span>\u003Cspan style=\"color:#F97583\">-\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> now\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">            time.sleep(sleep_time)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">        self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.requests.append(now)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># In agent code\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">rate_limiter \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> RateLimiter(\u003C/span>\u003Cspan style=\"color:#FFAB70\">max_requests\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">45\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#FFAB70\">window_seconds\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">60\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_claude_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    rate_limiter.acquire()\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Call API...\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Leave headroom. 45 requests/minute for a 50 req/min limit. Shared rate limiters if you have multiple services using the same API key.\u003C/p>\n\u003Ch3 id=\"graceful-degradation\">Graceful Degradation\u003C/h3>\n\u003Cp>APIs go down. Networks fail. Disk fills up. Production systems need fallbacks.\u003C/p>\n\u003Cp>\u003Cstrong>When Claude API is unavailable:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _run_claude_agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, output_dir: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    try\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Normal Claude processing\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._call_claude_api(filepath, output_dir)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> anthropic.APIConnectionError:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Fallback to queue\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._queue_for_retry(filepath)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    except\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> anthropic.RateLimitError:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">        # Back off and retry once\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        time.sleep(\u003C/span>\u003Cspan style=\"color:#79B8FF\">60\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">._call_claude_api(filepath, output_dir)\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>When disk space is low:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _check_disk_space\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    stat \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> os.statvfs(os.path.expanduser(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"~/output\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">))\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    free_bytes \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> stat.f_bavail \u003C/span>\u003Cspan style=\"color:#F97583\">*\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> stat.f_frsize\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    free_gb \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> free_bytes \u003C/span>\u003Cspan style=\"color:#F97583\">/\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> (\u003C/span>\u003Cspan style=\"color:#79B8FF\">1024\u003C/span>\u003Cspan style=\"color:#F97583\">**\u003C/span>\u003Cspan style=\"color:#79B8FF\">3\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> free_gb \u003C/span>\u003Cspan style=\"color:#F97583\">&#x3C;\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 1.0\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:  \u003C/span>\u003Cspan style=\"color:#6A737D\"># Less than 1GB free\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        console.print(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"[red]Low disk space![/] Pausing processing.\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Check before each file. Pause processing if disk is full. Alert on low space. For systems processing 50GB/day, check every 10 files and alert at 10GB free.\u003C/p>\n\u003Ch3 id=\"security-validating-file-contents\">Security: Validating File Contents\u003C/h3>\n\u003Cp>Users drop files. Users are unpredictable. Protect your system.\u003C/p>\n\u003Cp>\u003Cstrong>File type validation:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">import\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> magic  \u003C/span>\u003Cspan style=\"color:#6A737D\"># python-magic library\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _validate_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, filepath: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> tuple[\u003C/span>\u003Cspan style=\"color:#79B8FF\">bool\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Check declared extension matches actual content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    mime \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> magic.from_file(filepath, \u003C/span>\u003Cspan style=\"color:#FFAB70\">mime\u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\">True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    allowed_types \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> self\u003C/span>\u003Cspan style=\"color:#E1E4E8\">.zone_config.get(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"allowed_mime_types\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, [])\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> allowed_types \u003C/span>\u003Cspan style=\"color:#F97583\">and\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mime \u003C/span>\u003Cspan style=\"color:#F97583\">not\u003C/span>\u003Cspan style=\"color:#F97583\"> in\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> allowed_types:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#F97583\">f\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Invalid file type: \u003C/span>\u003Cspan style=\"color:#79B8FF\">{\u003C/span>\u003Cspan style=\"color:#E1E4E8\">mime\u003C/span>\u003Cspan style=\"color:#79B8FF\">}\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Check for malicious content\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> mime.startswith(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"application/x-executable\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">):\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">        return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> False\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"Executable files not allowed\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#79B8FF\"> True\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"OK\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>\u003Cstrong>Content sanitization:\u003C/strong>\u003C/p>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"python\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">def\u003C/span>\u003Cspan style=\"color:#B392F0\"> _sanitize_content\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(self, content: \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">) -> \u003C/span>\u003Cspan style=\"color:#79B8FF\">str\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Remove potential injection attacks\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    content \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> content.replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"```python\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"```text\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    content \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> content.replace(\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"```bash\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"```text\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">)\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\">    # Limit size\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">    max_chars \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#79B8FF\"> 500000\u003C/span>\u003Cspan style=\"color:#6A737D\">  # ~125K tokens\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    if\u003C/span>\u003Cspan style=\"color:#79B8FF\"> len\u003C/span>\u003Cspan style=\"color:#E1E4E8\">(content) \u003C/span>\u003Cspan style=\"color:#F97583\">>\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> max_chars:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#E1E4E8\">        content \u003C/span>\u003Cspan style=\"color:#F97583\">=\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> content[:max_chars] \u003C/span>\u003Cspan style=\"color:#F97583\">+\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"\u003C/span>\u003Cspan style=\"color:#79B8FF\">\\n\\n\u003C/span>\u003Cspan style=\"color:#9ECBFF\">[Content truncated]\"\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#F97583\">    return\u003C/span>\u003Cspan style=\"color:#E1E4E8\"> content\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Cp>Never execute code from dropped files directly. Treat all input as untrusted. Validate, sanitize, then process.\u003C/p>\n\u003Ch2 id=\"the-automation-decision-framework\">The Automation Decision Framework\u003C/h2>\n\u003Cp>Not every task deserves automation. Use specific thresholds.\u003C/p>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Frequency\u003C/th>\u003Cth>ROI Threshold\u003C/th>\u003Cth>Action\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Once\u003C/td>\u003Ctd>N/A\u003C/td>\u003Ctd>Use chat\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>2-5x/month\u003C/td>\u003Ctd>> 5 min saved\u003C/td>\u003Ctd>Maybe automate\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Weekly\u003C/td>\u003Ctd>> 2 min saved\u003C/td>\u003Ctd>Consider zone\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Daily\u003C/td>\u003Ctd>> 30 sec saved\u003C/td>\u003Ctd>Build zone\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>10+ times/day\u003C/td>\u003Ctd>Any time saved\u003C/td>\u003Ctd>Definitely zone\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Complexity\u003C/th>\u003Cth>Time to Build\u003C/th>\u003Cth>Approach\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Single step\u003C/td>\u003Ctd>5 minutes\u003C/td>\u003Ctd>Bash agent\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Multi-step\u003C/td>\u003Ctd>30 minutes\u003C/td>\u003Ctd>Python agent\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>AI reasoning\u003C/td>\u003Ctd>15 minutes\u003C/td>\u003Ctd>Claude agent\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Mixed flow\u003C/td>\u003Ctd>1-2 hours\u003C/td>\u003Ctd>Chain agents\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Needs approval\u003C/td>\u003Ctd>2-3 hours\u003C/td>\u003Ctd>Approval workflow\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003Ctable>\u003Cthead>\u003Ctr>\u003Cth>Risk Level\u003C/th>\u003Cth>Requirements\u003C/th>\u003Cth>Safety\u003C/th>\u003C/tr>\u003C/thead>\u003Ctbody>\u003Ctr>\u003Ctd>Low\u003C/td>\u003Ctd>None\u003C/td>\u003Ctd>Full auto\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Medium\u003C/td>\u003Ctd>Logging\u003C/td>\u003Ctd>Auto + audit\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>High\u003C/td>\u003Ctd>Review\u003C/td>\u003Ctd>Approval required\u003C/td>\u003C/tr>\u003Ctr>\u003Ctd>Critical\u003C/td>\u003Ctd>Sign-off\u003C/td>\u003Ctd>Manual only\u003C/td>\u003C/tr>\u003C/tbody>\u003C/table>\n\u003Cp>\u003Cstrong>Real numbers from our deployment:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Morning meeting transcription: 10x/week, saves 15 min/day, ROI: 2.5 hours/week\u003C/li>\n\u003Cli>Code review: 30x/week, saves 3 min each, ROI: 1.5 hours/week\u003C/li>\n\u003Cli>Data analysis: 5x/week, saves 20 min each, ROI: 1.7 hours/week\u003C/li>\n\u003Cli>Legal contract review: 2x/month, approval required, ROI: 40 min/month\u003C/li>\n\u003C/ul>\n\u003Cp>Total time saved: 22 hours/month. Setup time: 8 hours. Break-even in 2 weeks.\u003C/p>\n\u003Ch2 id=\"agent-opportunity-build-your-drop-zone-library\">Agent Opportunity: Build Your Drop Zone Library\u003C/h2>\n\u003Cp>Start with these high-value zones:\u003C/p>\n\u003Ch3 id=\"morning-debrief-zone\">Morning Debrief Zone\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># In drops.yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">morning_debrief\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/debrief\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.m4a\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.mp3\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.wav\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">debrief_processor\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">agents\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  debrief_processor\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">bash\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    command\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#F97583\">|\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      # Transcribe\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      whisper \"{file}\" -o /tmp --output_format txt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      # Extract filename for transcript\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      BASENAME=$(basename \"{file}\" | sed 's/\\.[^.]*$//')\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      # Process with Claude\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#9ECBFF\">      cat /tmp/$BASENAME.txt | claude --prompt \"$(cat prompts/debrief.md)\" > \"{output_dir}/$BASENAME-insights.md\"\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"code-review-zone\">Code Review Zone\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">code_review\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/review\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.py\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.ts\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.js\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">, \u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.go\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">code_review\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">agents\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  code_review\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    prompt_file\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">prompts/code_review.md\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    model\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">claude-sonnet-4-20250514\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch3 id=\"research-paper-zone\">Research Paper Zone\u003C/h3>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"yaml\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">research\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  directory\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">~/drops/papers\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  patterns\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">\"*.pdf\"\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  agent\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">paper_summarize\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  events\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: [\u003C/span>\u003Cspan style=\"color:#9ECBFF\">created\u003C/span>\u003Cspan style=\"color:#E1E4E8\">]\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">agents\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">  paper_summarize\u003C/span>\u003Cspan style=\"color:#E1E4E8\">:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    type\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">python\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#85E89D\">    script\u003C/span>\u003Cspan style=\"color:#E1E4E8\">: \u003C/span>\u003Cspan style=\"color:#9ECBFF\">agents/paper_processor.py\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"running-the-system\">Running the System\u003C/h2>\n\u003Cpre class=\"astro-code github-dark\" style=\"background-color:#24292e;color:#e1e4e8; overflow-x: auto;\" tabindex=\"0\" data-language=\"bash\">\u003Ccode>\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Create the directory structure\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">mkdir\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -p\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/drops/{transcribe,analyze,images,data}\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">mkdir\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -p\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/output\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/archive\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/logs\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">mkdir\u003C/span>\u003Cspan style=\"color:#79B8FF\"> -p\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> prompts\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> agents\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Start the watcher\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">uv\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> run\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> drop_watcher.py\u003C/span>\u003Cspan style=\"color:#79B8FF\"> --config\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> drops.yaml\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># In another terminal, test it:\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#79B8FF\">echo\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> \"Write a blog post about AI automation\"\u003C/span>\u003Cspan style=\"color:#F97583\"> >\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/drops/analyze/test.txt\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#6A737D\"># Check output\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">ls\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/output/analyze/\u003C/span>\u003C/span>\n\u003Cspan class=\"line\">\u003Cspan style=\"color:#B392F0\">cat\u003C/span>\u003Cspan style=\"color:#9ECBFF\"> ~/output/analyze/\u003C/span>\u003Cspan style=\"color:#79B8FF\">*\u003C/span>\u003Cspan style=\"color:#9ECBFF\">.md\u003C/span>\u003C/span>\u003C/code>\u003C/pre>\n\u003Ch2 id=\"the-key-insight\">The Key Insight\u003C/h2>\n\u003Cp>\u003Cstrong>Repeat workflows benefit most from automation.\u003C/strong>\u003C/p>\n\u003Cp>The first time you do something, chat is fine. The tenth time, you should have a drop zone.\u003C/p>\n\u003Cp>Directory watchers work because they match how you already work. You already organize files into folders. You already drag and drop. The interface is invisible.\u003C/p>\n\u003Cp>They’re called agents for a reason. They’re capable of agency. Lean into the autonomy.\u003C/p>\n\u003Chr>\n\u003Cp>\u003Cstrong>Key Takeaways:\u003C/strong>\u003C/p>\n\u003Cul>\n\u003Cli>Directory watchers turn the file system into an AI interface with zero learning curve\u003C/li>\n\u003Cli>YAML config makes adding new zones a 5-minute task\u003C/li>\n\u003Cli>Pattern matching routes files to appropriate agents automatically\u003C/li>\n\u003Cli>Production requires monitoring, logging, rate limiting, and error handling\u003C/li>\n\u003Cli>Failure modes are predictable: context gaps, race conditions, size limits, approval needs\u003C/li>\n\u003Cli>ROI threshold: anything you do 10+ times/week that takes more than 30 seconds\u003C/li>\n\u003Cli>Start with your highest-frequency task and expand from there\u003C/li>\n\u003C/ul>\n\u003Cp>\u003Cstrong>Try It Now:\u003C/strong>\nCopy \u003Ccode>drop_watcher.py\u003C/code> and \u003Ccode>drops.yaml\u003C/code> above. Create the directory structure. Start the watcher. Drop a text file into \u003Ccode>~/drops/analyze/\u003C/code>. Watch it process automatically and check \u003Ccode>~/output/analyze/\u003C/code> for results.\u003C/p>",{"headings":403,"localImagePaths":485,"remoteImagePaths":486,"frontmatter":487,"imagePaths":491},[404,407,410,413,416,419,422,425,428,431,434,437,440,443,446,449,452,455,458,461,464,467,470,473,476,479,482],{"depth":44,"slug":405,"text":406},"the-architecture","The Architecture",{"depth":44,"slug":408,"text":409},"poc-complete-drop-zone-system","POC: Complete Drop Zone System",{"depth":124,"slug":411,"text":412},"step-1-configuration-file","Step 1: Configuration File",{"depth":124,"slug":414,"text":415},"step-2-the-core-watcher","Step 2: The Core Watcher",{"depth":124,"slug":417,"text":418},"step-3-agent-prompt-templates","Step 3: Agent Prompt Templates",{"depth":124,"slug":420,"text":421},"step-4-image-generation-agent","Step 4: Image Generation Agent",{"depth":44,"slug":423,"text":424},"data-flow-file-drop-to-result","Data Flow: File Drop to Result",{"depth":44,"slug":426,"text":427},"when-drop-zones-fail","When Drop Zones Fail",{"depth":124,"slug":429,"text":430},"files-that-need-context","Files That Need Context",{"depth":124,"slug":432,"text":433},"multi-file-inputs","Multi-File Inputs",{"depth":124,"slug":435,"text":436},"race-conditions-incomplete-writes","Race Conditions: Incomplete Writes",{"depth":124,"slug":438,"text":439},"agent-failures-mid-processing","Agent Failures Mid-Processing",{"depth":124,"slug":441,"text":442},"token-limit-exceeded","Token Limit Exceeded",{"depth":124,"slug":444,"text":445},"files-requiring-human-review","Files Requiring Human Review",{"depth":44,"slug":447,"text":448},"production-deployment-considerations","Production Deployment Considerations",{"depth":124,"slug":450,"text":451},"monitoring-and-alerting","Monitoring and Alerting",{"depth":124,"slug":453,"text":454},"logging-and-audit-trails","Logging and Audit Trails",{"depth":124,"slug":456,"text":457},"resource-limits","Resource Limits",{"depth":124,"slug":459,"text":460},"graceful-degradation","Graceful Degradation",{"depth":124,"slug":462,"text":463},"security-validating-file-contents","Security: Validating File Contents",{"depth":44,"slug":465,"text":466},"the-automation-decision-framework","The Automation Decision Framework",{"depth":44,"slug":468,"text":469},"agent-opportunity-build-your-drop-zone-library","Agent Opportunity: Build Your Drop Zone Library",{"depth":124,"slug":471,"text":472},"morning-debrief-zone","Morning Debrief Zone",{"depth":124,"slug":474,"text":475},"code-review-zone","Code Review Zone",{"depth":124,"slug":477,"text":478},"research-paper-zone","Research Paper Zone",{"depth":44,"slug":480,"text":481},"running-the-system","Running the System",{"depth":44,"slug":483,"text":484},"the-key-insight","The Key Insight",[],[],{"title":381,"description":382,"pubDate":488,"author":17,"tags":489,"banner":388,"category":304,"difficulty":35,"tldr":390,"keyTakeaways":490},["Date","2025-12-15T00:00:00.000Z"],[19,23,385,386,387],[392,393,394,395,396],[],"directory-watchers.md"]