name: PR Tests & Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  deployments: write

jobs:
  test-and-deploy:
    name: Test & Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build project
        run: npm run build

      - name: Run Playwright tests
        id: playwright
        run: |
          npm test -- --reporter=json --reporter=list 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Parse test results
        id: results
        if: always()
        run: |
          if [ -f test-output.txt ]; then
            PASSED=$(grep -oP '\d+(?= passed)' test-output.txt | tail -1 || echo "0")
            FAILED=$(grep -oP '\d+(?= failed)' test-output.txt | tail -1 || echo "0")
            SKIPPED=$(grep -oP '\d+(?= skipped)' test-output.txt | tail -1 || echo "0")

            PASSED=${PASSED:-0}
            FAILED=${FAILED:-0}
            SKIPPED=${SKIPPED:-0}

            TOTAL=$((PASSED + FAILED + SKIPPED))

            if [ "$FAILED" -gt 0 ]; then
              STATUS="failure"
              EMOJI="‚ùå"
            else
              STATUS="success"
              EMOJI="‚úÖ"
            fi

            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          else
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Cloudflare Pages Preview
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=acidbath --branch=${{ github.head_ref }}

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const passed = '${{ steps.results.outputs.passed }}';
            const failed = '${{ steps.results.outputs.failed }}';
            const skipped = '${{ steps.results.outputs.skipped }}';
            const total = '${{ steps.results.outputs.total }}';
            const status = '${{ steps.results.outputs.status }}';
            const emoji = '${{ steps.results.outputs.emoji }}';
            const sha = context.sha.substring(0, 7);
            const previewUrl = '${{ steps.deploy.outputs.deployment-url }}';

            let body = `## ${emoji} PR Status Report\n\n`;
            body += `**Commit:** \`${sha}\`\n\n`;

            // Preview URL section
            body += `### üåê Preview Deployment\n\n`;
            body += `**URL:** ${previewUrl}\n\n`;

            // Test results section
            body += `### üß™ Test Results\n\n`;
            body += `| Status | Count |\n`;
            body += `|--------|-------|\n`;
            body += `| ‚úÖ Passed | ${passed} |\n`;
            body += `| ‚ùå Failed | ${failed} |\n`;
            body += `| ‚è≠Ô∏è Skipped | ${skipped} |\n`;
            body += `| **Total** | **${total}** |\n\n`;

            if (status === 'failure') {
              body += `### ‚ö†Ô∏è Some tests failed\n\n`;
              body += `Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n`;
            } else {
              body += `All tests passed! üéâ\n`;
            }

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              (comment.body.includes('## ‚úÖ PR Status Report') || comment.body.includes('## ‚ùå PR Status Report'))
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Comment on linked issue
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request?.body || '';
            const prTitle = context.payload.pull_request?.title || '';

            // Match issue references with word boundary to avoid matching hex colors like #39ff14
            // Prioritize explicit "Closes #N" or "Fixes #N" patterns
            const closesMatch = (prBody + ' ' + prTitle).match(/(?:closes|fixes|resolves)\s+#(\d+)/i);
            const issueMatch = closesMatch || (prBody + ' ' + prTitle).match(/#(\d+)(?!\w)/);
            if (!issueMatch) {
              console.log('No linked issue found');
              return;
            }

            const issueNumber = parseInt(issueMatch[1]);
            const status = '${{ steps.results.outputs.status }}';
            const emoji = '${{ steps.results.outputs.emoji }}';
            const passed = '${{ steps.results.outputs.passed }}';
            const failed = '${{ steps.results.outputs.failed }}';
            const sha = context.sha.substring(0, 7);
            const prNumber = context.issue.number;
            const previewUrl = '${{ steps.deploy.outputs.deployment-url }}';

            let body = `### ${emoji} PR #${prNumber} Status Update\n\n`;
            body += `**Commit:** \`${sha}\`\n`;
            body += `**Tests:** ${passed} passed, ${failed} failed\n`;
            body += `**Preview:** ${previewUrl}\n\n`;
            body += `[View PR](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/pull/${prNumber}) | `;
            body += `[View Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });

      - name: Fail if tests failed
        if: steps.results.outputs.status == 'failure'
        run: exit 1
